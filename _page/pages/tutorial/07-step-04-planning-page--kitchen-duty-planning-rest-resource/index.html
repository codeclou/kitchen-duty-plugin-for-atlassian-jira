{% set CURRENT_PAGE_ID = 7 %}
{% set gitHubBaseUrlForStep4 = 'https://github.com/codeclou/kitchen-duty-plugin-for-atlassian-jira/blob/__COMMIT__/step-04-kitchen-duty-plugin/' %}
{% extends layoutSourceDir + "/layout_with_sidebar.html" %}
{% block head %}
    <title>Kitchen Duty Planning REST Resource ~ Planning Page | Plugin Development Tutorial for Atlassian JIRAÂ® | Kitchen Duty Plugin by codeclou UG</title>
    <meta description="An interactive step-by-step tutorial on how to write Plugins for Atlassian Jira by codeclou UG">
    <meta name="robots" content="noindex, nofollow">
{% endblock %}
{% block content %}



<div class="row">
    <div class="col-md-12">
        {{ headline('Kitchen Duty Planning REST Resource', 'm') }}

        {# ############################################################# #}
        {# STEP 4  #}
        {# ############################################################# #}

        <p>Basically we will build the <strong>Kitchen Duty Planning REST Resource</strong> and the <strong>Kitchen Duty Planning REST Model</strong>
            which will persist our selected weeks and users to the database.</p>

        <p>You also might want to look into <a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/03-story-workshop-for-planning-page/">the Story Workshop</a> again to recapitulate what we are going to build now.</p>

        <div class="alert alert-info">This chapter heavily depends on the <a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/05-step-02-planning-page--user-search-rest-resource/">configuration done in Step 2</a>.</div>

        <h3 class="cs-headline cs-headline--s">What do we need exactly?</h3>

        <div class="row">
            <div class="col-md-6">
                <p>
                    After some serious brain usage on how to store the actual data of <strong>&laquo;who has Kitchen Duty in which week?&raquo;</strong>
                    I came up with the <strong>Data-Model</strong> seen on the right.</p>
                <p>
                    The <strong>Week</strong> will be the actual week number in the year, and we don't care about the year in this tutorial. So if you had kitchen duty in week 24 this year you will have it the years after as well.
                    With a little thinking ahead of how I want to use it in the JS Controller
                    I basically will select a week via a date picker and <a href="http://momentjs.com/docs/#/get-set/week/">calculate the week number in the frontend using moment.js</a></p>
                <p>
                    The <strong>User</strong> part is obvious. We will need to store a list of usernames in the database in relation with Weeks (<a href="https://developer.atlassian.com/docs/atlassian-platform-common-components/active-objects/developing-your-plugin-with-active-objects/the-active-objects-library/manytomany-relationship"><code>@ManyToMany</code></a>).
                </p>
                <p>
                    Concerning the <strong>REST Endpoint</strong> I will want to have an URL which I can fire
                    GET requests on something like <code>/planning/week/15/users</code> and receive a list of users.
                </p>
                <p>
                    Obviously the other way round would be a PUT request on <code>/planning/week/15/users</code> with a list of users
                    as request body to store the user list for the week 15.
                </p>

                <p>
                    And for our stretch-goal a GET request on <code>/planning/user/bob/weeks</code> should return a list of week numbers
                    in which Bob has Kitchen Duty.
                </p>
            </div>
            <div class="col-md-offset-1 col-md-5">
                <table class="table table-bordered cs-table-uml">
                    <thead>
                    <tr>
                        <th>Week</th>
                        <th class="cs-table-uml--connector">
                            n&nbsp;&nbsp;&nbsp;&nbsp;m
                        </th>
                        <th>User</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>week:&nbsp;Integer</td>
                        <td class="cs-table-uml--blank"></td>
                        <td>username:&nbsp;String</td>
                    </tr>
                    </tbody>
                </table>
                <br>
                <br>
                <div style="padding:0 0 0 30px">
                    <img src="/kitchen-duty-plugin-for-atlassian-jira/images/drawings/persist-me-senpai.svg" class="img-fluid">
                </div>
            </div>
        </div>

        <h3 class="cs-headline cs-headline--s">How exactly do we persist our data?</h3>


        <p>Alright we know how we want to use our REST Endpoint from the perspective of the JS Controller. And we have some kind of clue
            on how the data should be stored theoretically.</p>

        <p>There are <strong>two main possibilities to persist data in JIRA</strong>.</p>

        <p>
            <ul>
                <li>
                    Using the <strong><a href="https://developer.atlassian.com/docs/common-coding-tasks/storing-plugin-settings">PluginSettingsFactory</a></strong> you
                    have an easy way to persist data. But you don't have queries and cannot build relationships like you can with a real Database.
                    So this is good if you just want to store simple stuff when you always know how to retrieve data from the PluginSettingsFactory (for example by a fixed key).
                    <br />&nbsp;
                </li>
                <li>
                    Then there are <strong><a href="https://developer.atlassian.com/docs/atlassian-platform-common-components/active-objects">Active Objects</a></strong> which let you use
                    a real database with an ORM Interface. And that is definitely the choice we want to make here.
                    So you might want to stroll around the Active Objects documents a little to get a grasp of it or just continue reading since I will also introduce you to it step by step.
                </li>
            </ul>
        </p>

        <div class="cs-v-spacer cs-v-spacer--big"></div>








        <h3 class="cs-headline cs-headline--s">Enabling Active Objects on our Project</h3>

        <p>
            All I will be writing about Active Objects is taken from the <em><a href="https://developer.atlassian.com/docs/atlassian-platform-common-components/active-objects/developing-your-plugin-with-active-objects">Developing your plugin with Active Objects Guide</a></em> and the <em><a href="https://developer.atlassian.com/docs/atlassian-platform-common-components/active-objects/getting-started-with-active-objects">Getting Started with Active Objects Guide</a></em>.
        </p>

        <p>
            First of all add <a href="https://maven.atlassian.com/content/repositories/atlassian-public/com/atlassian/activeobjects/activeobjects-plugin/">Active Objects dependency</a> to your pom.xml.
        </p>

        {{ csSource(lang='xml', filepath="", filename="pom.xml", ghBaseUrl=(gitHubBaseUrlForStep4 | replace("__COMMIT__", "master")), source='
        |<dependency>
        |   <groupId>com.atlassian.activeobjects</groupId>
        |   <artifactId>activeobjects-plugin</artifactId>
        |   <version>1.1.5</version>
        |   <scope>provided</scope>
        |</dependency>
        ') }}



        <p>We need a <strong>Component Import for <code>ActiveObjects</code></strong> which will be the object we use to access the database.</p>

        <p>
            {{ csSource(lang='java', filepath="src/main/java/com/codeclou/kitchen/duty/impl/", filename="MyPluginComponentImpl.java", uniqueId='sdfrg445ger', ghBaseUrl=(gitHubBaseUrlForStep4 | replace("__COMMIT__", "30e29f5e1cc8bdb4d5a6ff72834fd4af219d4a1d")), source='
            |package io.codeclou.kitchen.duty.rest;
            |
            |import com.atlassian.activeobjects.external.ActiveObjects;
            |import com.atlassian.plugin.spring.scanner.annotation.imports.ComponentImport;
            |...
            |
            |@Named ("myPluginComponent")
            |public class MyPluginComponentImpl implements MyPluginComponent {
            |   ...
            |   @ComponentImport
            |   private ActiveObjects activeObjects;
            |   ...
            |}
            ') }}
        </p>

        <p>Now we <strong>create our first Entity <code>Week</code></strong> and define the week as integer via getter/setter.</p>

        <div class="row">
            <div class="col-md-8">
                {{ csSource(lang='java', filepath="src/main/java/com/codeclou/kitchen/duty/ao/", filename="Week.java", uniqueId='h768go8gdfssfdsbo8gv8gbu909', ghBaseUrl=(gitHubBaseUrlForStep4 | replace("__COMMIT__", "30e29f5e1cc8bdb4d5a6ff72834fd4af219d4a1d")), source='
                |package io.codeclou.kitchen.duty.ao;
                |
                |import net.java.ao.Entity;
                |import net.java.ao.Preload;
                |
                |@Preload {{{point::1}}}
                |public interface Week extends Entity { {{{point::2}}}
                |    Integer getWeek();
                |
                |    void setWeek(Integer week);
                |}
                ') }}

            </div>
            <div class="col-md-4 cs-sticky-in-parent">
                <div class="list-group cs-source-point-list" data-source-target="h768go8gdfssfdsbo8gv8gbu909">
                    <div class="list-group-item cs-source-point-list__item">
                        We annotate our class with <code>@Preload</code> which I think makes it not lazy loaded ... but you have
                        to read the docs if you want to know in detail.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        The important thing is that we extend <code>Entity</code> that makes our Class automatically have <code>getID()</code>
                        so we just need to define our fields which is currently only the week number (week of year).
                    </div>
                </div>
            </div>
        </div>

        <p>We just created the <code>Week</code> Entity now and we need to tell the Active Objects module of our Plugin where he can find our Entity.
            Therefore we add a section to our <code>atlassian-plugin.xml</code> file listing the Entities (Maybe there is some kind of nice Annotation to skip that step, but since the docs are very thin on that I don't know. So if you find out please tell me).</p>


        {{ csSource(lang='xml', filepath="src/main/resources/", filename="atlassian-plugin.xml", ghBaseUrl=(gitHubBaseUrlForStep4 | replace("__COMMIT__", "30e29f5e1cc8bdb4d5a6ff72834fd4af219d4a1d")), source='
        |<ao key="ao-module">
        |    <description>The module configuring the Active Objects service used by this plugin</description>
        |    <entity>io.codeclou.kitchen.duty.ao.Week</entity>
        |</ao>
        ') }}

        <div class="cs-v-spacer cs-v-spacer--big"></div>







        <h3 class="cs-headline cs-headline--s">Creating a basic Week Entity and a persist-Endpoint</h3>

        <p>We are agile coders and wanna see basic results now of what we did. Therefore we will create a very basic persistTest-Endpoint to try out the ORM stuff provided by Active Objects.
            We will get rid of the endpoint later we just use it to get a feel of how Active Objects works.</p>


        <div class="row">
            <div class="col-md-8">
                {{ csSource(lang='java', filepath="src/main/java/com/codeclou/kitchen/duty/rest/", filename="KitchenDutyPlanningResource.java", uniqueId='kdpr11464', ghBaseUrl=(gitHubBaseUrlForStep4 | replace("__COMMIT__", "30e29f5e1cc8bdb4d5a6ff72834fd4af219d4a1d")), source='
                |package io.codeclou.kitchen.duty.rest;
                |
                |import com.atlassian.activeobjects.external.ActiveObjects;
                |import com.atlassian.jira.bc.user.search.UserSearchService;
                |import com.atlassian.plugins.rest.common.security.AnonymousAllowed;
                |import com.atlassian.sal.api.transaction.TransactionCallback;
                |import io.codeclou.kitchen.duty.ao.Week;
                |
                |import javax.inject.Inject;
                |import javax.inject.Named;
                |import javax.servlet.http.HttpServletRequest;
                |import javax.ws.rs.GET;
                |import javax.ws.rs.Path;
                |import javax.ws.rs.Produces;
                |import javax.ws.rs.QueryParam;
                |import javax.ws.rs.core.Context;
                |import javax.ws.rs.core.MediaType;
                |import javax.ws.rs.core.Response;
                |import java.util.ArrayList;
                |import java.util.List;
                |
                |@Named
                |@Path("/planning")
                |public class KitchenDutyPlanningResource {
                |
                |    private ActiveObjects activeObjects; {{{point::1}}}
                |
                |    @Inject {{{point::2}}}
                |    public KitchenDutyPlanningResource(ActiveObjects activeObjects) {
                |        this.activeObjects = activeObjects;
                |    }
                |
                |    public KitchenDutyPlanningResource() {
                |    }
                |
                |
                |    @GET
                |    @Path("/persistTest") {{{point::3}}}
                |    @Produces({MediaType.APPLICATION_JSON})
                |    @AnonymousAllowed
                |    public Response persistTest() {
                |        activeObjects.executeInTransaction(new TransactionCallback<Week>() {{{point::4}}}
                |        {
                |            @Override
                |            public Week doInTransaction() {{{point::5}}}
                |            {
                |                final Week testWeek = activeObjects.create(Week.class); {{{point::6}}}
                |                testWeek.setWeek(42);
                |                testWeek.save();
                |                return testWeek;
                |            }
                |        });
                |        return Response.ok("ok").build();
                |    }
                |
                |
                |    @GET
                |    @Path("/health")
                |    @Produces({MediaType.APPLICATION_JSON})
                |    @AnonymousAllowed
                |    public Response health() {
                |        return Response.ok("ok").build();
                |    }
                |
                |}
                ') }}

            </div>
            <div class="col-md-4 cs-sticky-in-parent">
                <div class="list-group cs-source-point-list" data-source-target="kdpr11464">
                    <div class="list-group-item cs-source-point-list__item">
                        Define <code>ActiveObjects</code> as property so that we can use it.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Add an <code>@Inject</code> to the constructor so that we get it injected via DI.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Define a Endpoint with path <code>persistTest</code> and Method <code>@Get</code>
                        which we will use to play with the ORM.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        We start a Transaction <em>(... this should be done with Annotations ... but we have to deal with it ...)</em>
                        And here we would need to define our return type which in our case is <code>Week</code>. You could set it to Void here too.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        We need to override <code>doInTransaction</code> and inside here we can do actual
                        Active Objects ORM stuff. Obviously here we could override more methods to handle transaction rollbacks
                        and usually we should wrap all these shenanigans inside a try-catch block and do proper exception handling
                        BUT we are currently just playing around so it is fine.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Now that we are deep inside the rabbit hole we can start to <strong>persist our first <code>Week</code> object</strong>.
                        We call <code>activeObjects.create(..)</code> and pass our Class-Type.
                        After that we set our week value and call <code>.save()</code>.
                        Now our week is persisted to the Database. Banzai!
                    </div>
                </div>
            </div>
        </div>


        <p>Alright now startup JIRA with <code>atlas-run</code> but <strong>capture the output a file called <code>jira-stdout.log</code> so that we can grep it later</strong>. You need to have <a href="https://de.wikipedia.org/wiki/Tee_(Unix)">tee</a> installed.

        {{ csShell(shellCmd='atlas-run | tee jira-stdout.log', shellCmdOutput='
        |...
        |[INFO] [talledLocalContainer] INFORMATION: Server startup in 38377 ms
        |[INFO] [talledLocalContainer] Tomcat 8.x started on port [2990]
        |[INFO] jira started successfully in 58s at http://localhost:2990/jira
        |[INFO] Type Ctrl-D to shutdown gracefully
        |[INFO] Type Ctrl-C to exit
        ') }}

        <p>Open another terminal to execute some CURL commands and once JIRA has started up execute a GET Request to our persistTest Endpoint.</p>


        {{ csShell(shellCmd='curl --user admin:admin -H \'Content-Type: application/json\' http://localhost:2990/jira/rest/kitchenduty/1.0/planning/persistTest', shellCmdOutput='
        |ok
        ') }}

        <p>Now our Week object with week 42 should have been persisted to the table Week in the database</p>

        <div class="cs-v-spacer cs-v-spacer--big"></div>









        <h3 class="cs-headline cs-headline--s">Let's have a look into the Database</h3>

        <p>Alright now you need to know that <strong>JIRA runs a <a href="http://www.h2database.com/">H2 Database</a></strong> when started with <code>atlas-run</code>. And it <strong>does NOT use <a href="http://hsqldb.org/">HSQLDB</a> anymore</strong> even though it has used HSQLDB up to some version of JIRA - but those days seem over.</p>

        <p>
            You might have wondered why you needed to capture the STDOUT of JIRA previously to <code>jira-stdout.log</code>.
            Because on line 12131415 of one trillion overall lines that atlas-run echos you will find a line starting containing <code>Database URL</code> which
            tells you the location of the H2 Database.
            And since we want to have a look we need to know where the Database resides in order to connect.
        </p>

        <p>
            Now stop the <code>atlas-run</code> by pressing CTRL+C <em>(we can only look into the H2 DB if no other process uses it)</em>.
            And <strong>grep for the Database URL in the captured STDOUT</strong>.
        </p>

        {{ csShell(shellCmd='grep "Database URL" jira-stdout.log', shellCmdOutput='
        |[INFO] [talledLocalContainer]     Database URL   : jdbc:h2:file:/Users/...../target/jira/home/database/h2db
        ') }}

        <p>Copy the whole <code>jdbc:h2:file:/Users/...../target/jira/home/database/h2db</code> JDBC URL (I have shortened the path here)</p>

        <p>In the same terminal we now <strong>start the H2 Database Console</strong> by executing the h2.jar file. <em>(Depending on your SDK version it should be somehwere around that location and might have an alternate version number.)</em></p>

        {{ csShell(shellCmd='java -jar target/container/tomcat8x/cargo-jira-home/webapps/jira/WEB-INF/lib/h2-1.4.185.jar') }}

        <p>Now a Browser Tab opens with the console and you just paste the JDBC URL and click connect.</p>

        {{ image('doc/step-04-h2-console-login.png', 'Step 4 - H2 Database Console Login', '60%') }}

        <div class="cs-blockquote">
            <p>
                Please remember to always just look into the database.
                You should never alter the Database with SQL Statements since JIRA manages autoincrement IDs and some other Caches
                and you will surely run into strange errors if you still do so. When using Object Relational Mappers it is best not to fiddle with the Database.
                <strong>Number One Rule: Only alter the Database through Active Objects.</strong>
            </p>
        </div>


        <p>You should see our Week table and if you execute a SELECT Statement on it you can see contents.</p>


        {{ image('doc/step-04-h2-console-jira.png', 'Step 4 - H2 Database Console Select Result on Table Week', '60%') }}

        <p>You can see the whole process of calling the testPersist Endpoint and connecting to the H2 Database in the following gif.</p>

        {{ image('doc/step-04-h2-jira-connect.gif', 'Step 4 - Interactive Demo: H2 Database Console Select Result on Table Week', '60%') }}

        <div class="cs-v-spacer cs-v-spacer--big"></div>










        <h3 class="cs-headline cs-headline--s">Adding User Class and Many-to-Many Relationship</h3>

        <p>Since we got Active Objects running successfully we now want to add a <a href="https://developer.atlassian.com/docs/atlassian-platform-common-components/active-objects/developing-your-plugin-with-active-objects/the-active-objects-library/manytomany-relationship"><code>@ManyToMany</code></a> relationship between <code>User</code> an <code>Week</code>.</p>

        <p>And when you have read the docs you will note that <strong>we need a Mapping Entity</strong> for that case. We will call it <code>UserToWeek</code>.</p>


        <p>But first we want to define the week and username as unique to avoid duplicate entries which are developer's nightmares.</p>

        <div class="row">
            <div class="col-md-8">
                {{ csSource(lang='java', filepath="src/main/java/com/codeclou/kitchen/duty/ao/", filename="Week.java", uniqueId='x235325', ghBaseUrl=(gitHubBaseUrlForStep4 | replace("__COMMIT__", "3b102ae23eaa587bb432b4b04b806ff78eb50b8f")), source='
                |package io.codeclou.kitchen.duty.ao;
                |
                |import net.java.ao.Entity;
                |import net.java.ao.ManyToMany;
                |import net.java.ao.Preload;
                |import net.java.ao.schema.NotNull;
                |import net.java.ao.schema.Unique;
                |
                |@Preload
                |public interface Week extends Entity {
                |
                |    @NotNull  {{{point::1}}}
                |    @Unique  {{{point::2}}}
                |    Integer getWeek();
                |    void setWeek(Integer week);
                |
                |    @ManyToMany(value = UserToWeek.class)  {{{point::3}}}
                |    User[] getUsers();
                |}
                ') }}
            </div>
            <div class="col-md-4 cs-sticky-in-parent">
                <div class="list-group cs-source-point-list" data-source-target="x235325">
                    <div class="list-group-item cs-source-point-list__item">
                        First we define week <code>@NotNull</code> which does not allow NULL values anymore.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Secondly we define week <code>@Unique</code> which does not allow duplicate values anymore.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Thirdly we define the Many-To-Many relationship on <code>getUsers()</code>
                        with <code>@ManyToMany</code>. The <code>value = UserToWeek.class</code> defines which
                        entity is used to map this relationship. You might know that you always need a mapping-table in the database
                        when mapping to objects many-to-many since the relational paradigma can only map one-to-many.
                        We will create <code>UserToWeek</code> a little further down below.
                    </div>
                </div>
            </div>
        </div>


        <div class="row">
            <div class="col-md-8">
            {{ csSource(lang='java', filepath="src/main/java/com/codeclou/kitchen/duty/ao/", filename="User.java", uniqueId='x543534r34', ghBaseUrl=(gitHubBaseUrlForStep4 | replace("__COMMIT__", "3b102ae23eaa587bb432b4b04b806ff78eb50b8f")), source='
            |package io.codeclou.kitchen.duty.ao;
            |
            |import net.java.ao.Entity;
            |import net.java.ao.ManyToMany;
            |import net.java.ao.Preload;
            |import net.java.ao.schema.NotNull;
            |import net.java.ao.schema.Unique;
            |
            |@Preload
            |public interface User extends Entity {
            |
            |    @NotNull {{{point::1}}}
            |    @Unique {{{point::2}}}
            |    String getName();
            |    void setName(String week);
            |
            |    @ManyToMany(value = UserToWeek.class) {{{point::3}}}
            |    Week[] getWeeks();
            |}
            ') }}
            </div>
            <div class="col-md-4 cs-sticky-in-parent">
                <div class="list-group cs-source-point-list" data-source-target="x543534r34">
                    <div class="list-group-item cs-source-point-list__item">
                        First we define the username <code>@NotNull</code> which does not allow NULL values anymore.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Secondly we define the username <code>@Unique</code> which does not allow duplicate values anymore.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Thirdly we define the Many-To-Many relationship on <code>getWeeks()</code>
                        with <code>@ManyToMany</code>. It works the same way as in <code>Week</code> just the other way round.
                    </div>
                </div>
            </div>
        </div>

        <p>We just defined our real entities and the relation they have through <code>UserToWeek</code> so all that is left is to define the mapping entity.</p>


        <div class="row">
            <div class="col-md-8">
            {{ csSource(lang='java', filepath="src/main/java/com/codeclou/kitchen/duty/ao/", filename="UserToWeek.java", uniqueId='x457458754646', ghBaseUrl=(gitHubBaseUrlForStep4 | replace("__COMMIT__", "3b102ae23eaa587bb432b4b04b806ff78eb50b8f")), source='
            |package io.codeclou.kitchen.duty.ao;
            |
            |import net.java.ao.Entity;
            |
            |public interface UserToWeek extends Entity { {{{point::1}}}
            |
            |    void setUser(User user); {{{point::2}}}
            |    User getUser();
            |
            |    void setWeek(Week week); {{{point::3}}}
            |    Week getWeek();
            |}
            ') }}
            </div>
            <div class="col-md-4 cs-sticky-in-parent">
                <div class="list-group cs-source-point-list" data-source-target="x457458754646">
                    <div class="list-group-item cs-source-point-list__item">
                        The <code>UserToWeek</code> also extends <code>Entity</code>.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        We define getter and setter for <code>User</code>.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        We define getter and setter for <code>Week</code>.
                    </div>
                </div>
            </div>
        </div>

        <p>That was all we needed to do to map the Many-To-Many relationship with Active Objects. And now <strong>don't forget to list the entities in the <code>ao</code> section of your <code>atlassian-plugin.xml</code></strong>.</p>

        {{ csSource(lang='xml', filepath="src/main/resources/", filename="atlassian-plugin.xml", ghBaseUrl=(gitHubBaseUrlForStep4 | replace("__COMMIT__", "3b102ae23eaa587bb432b4b04b806ff78eb50b8f")), source='
            |<ao key="ao-module">
            |    <description>The module configuring the Active Objects service used by this plugin</description>
            |    <entity>io.codeclou.kitchen.duty.ao.Week</entity>
            |    <entity>io.codeclou.kitchen.duty.ao.User</entity>
            |    <entity>io.codeclou.kitchen.duty.ao.UserToWeek</entity>
            |</ao>
        ') }}

        <p>&nbsp;</p>

        <p>We <strong>change the testPersist Endpoint to now persist a full relationship.</strong></p>

        <div class="row">
            <div class="col-md-6">
            {{ csSource(lang='java', filepath="src/main/java/com/codeclou/kitchen/duty/rest/", filename="KitchenDutyPlanningResource.java", uniqueId='x3eewr867987ij', ghBaseUrl=(gitHubBaseUrlForStep4 | replace("__COMMIT__", "83e18b1e57beb1e9282b2b3781966f88efd2763f")), source='
            |package io.codeclou.kitchen.duty.rest;
            |...
            |
            |@Named
            |@Path("/planning")
            |public class KitchenDutyPlanningResource {
            |...
            |
            |    @GET
            |    @Path("/persistTest")
            |    @Produces({MediaType.APPLICATION_JSON})
            |    @AnonymousAllowed
            |    public Response persistTest() {
            |        activeObjects.executeInTransaction(new TransactionCallback<Week>()
            |        {
            |            @Override
            |            public Week doInTransaction()
            |            {
            |                final Week testWeek = activeObjects.create(
            |                    Week.class, {{{point::1}}}
            |                    new DBParam("WEEK", 42)); {{{point::2}}}
            |                testWeek.save();
            |
            |                final User user = activeObjects.create(
            |                    User.class, {{{point::3}}}
            |                    new DBParam("NAME", "ichiban")); {{{point::4}}}
            |                user.save();
            |
            |                final UserToWeek relationship =
            |                           activeObjects.create(UserToWeek.class); {{{point::5}}}
            |                relationship.setUser(user); {{{point::6}}}
            |                relationship.setWeek(testWeek);
            |                relationship.save();
            |
            |                return testWeek;
            |            }
            |        });
            |        return Response.ok("ok").build();
            |    }
            |...
            |}
            ') }}
            </div>
            <div class="col-md-6 cs-sticky-in-parent">
                <div class="list-group cs-source-point-list" data-source-target="x3eewr867987ij">
                    <div class="list-group-item cs-source-point-list__item">
                        This is not new to you, we use <code>activeObjects#create(...)</code> to create a <code>Week</code> object with reference to the Database.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        But this is new. <code>DBParam</code> is used to immediately set the <code>@NotNull</code> values when creating the object.
                        Why do we need this? You can read <em><a href="https://developer.atlassian.com/docs/atlassian-platform-common-components/active-objects/developing-your-plugin-with-active-objects/the-active-objects-library/creating-entities">'Creating an entity with "not null"-constraints'</a></em>
                        OR let me explain. What does actually happen when <code>activeObjects#create(...)</code> is called? Usually the Active Objects
                        does an INSERT into the database with null values and the autoincrement ID of the table row is then the only thing set (except for default values).
                        So right after <code>create(Week.class)</code> the week object already has an ID when calling <code>getID()</code>.
                        And now comes the tricky part. If you have defined a property as <code>@NotNull</code> Active Objects also just tries
                        to do a INSERT into the table to write the ID back to the object BUT WAIT an <strong><code>ActiveObjectsSqlException</code> is thrown</strong> since our field
                        is null and it is not allowed to be null. <strong>SOLUTION</strong>: We use <code>DBParams</code> to immediately set the NotNull-Values
                        so that the initial INSERT that is triggered by <code>create(...)</code> contains actual values for our NotNull-Fields.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        We create a <code>User</code> object mapped to a Database Table row as we just did with <code>Week</code>.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        We also need to set the <code>NAME</code> value initially for our NotNull-Fields.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        We create a <code>UserToWeek</code> object mapped to a Database Table row as we just did with <code>User</code>.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Now we need to set the <code>User</code> and <code>Week</code> objects as reference and save.
                        By that the Many-To-Many relation between <code>User</code> and <code>Week</code> is now established.
                    </div>

                </div>
            </div>
        </div>


        <p>&nbsp;</p>

        <p>
            We are all set now to start JIRA again and to test if we can really save our relationship.
            But before we do that do a quick <code>atlas-clean</code> before the next <code>atlas-run</code> so that the database gets purged.
            Otherwise you might run into <code>Unique index or primary key violation</code> errors since we have 4 week entries already all with <em>week=42</em> values.
        </p>

        <p>
            {{ csShell(shellCmd='atlas-clean') }}
        </p>


        <p>
            We startup JIRA again and call the persistTest Endpoint again.
        </p>

        <p>
            {{ csShell(shellCmd='atlas-run') }}
        </p>

        <p>
            {{ csShell(shellCmd='curl --user admin:admin -H \'Content-Type: application/json\' http://localhost:2990/jira/rest/kitchenduty/1.0/planning/persistTest', shellCmdOutput='
            |ok
            ') }}
        </p>

        <p>
            And by calling the testPersist endpoint a second time we will get a <strong>unique constraint exception</strong> as expected.
            That is fine since that only shows that the unique constraint works and we will be throwing away the persistTest Endpoint anyways.
        </p>

        {{ image('doc/step-04-unique-index-exception.png', 'Step 4 - Unique Index Violation on second request', '60%') }}

        <p>We shutdown JIRA again and fire up the H2 Console again to see what tables have been created.</p>

        {{ image('doc/step-04-many-to-many-week-user.png', 'Step 4 - ManyToMany Relationship between User and Week mapped by three Tables in Database', '60%') }}

        <div class="cs-v-spacer cs-v-spacer--big"></div>













        <h3 class="cs-headline cs-headline--s">Creating the real Kitchen Duty Planning REST Resource with GET Endpoints for User and Week</h3>

        <p>
            Ok we have played around a little with active objects so far and now have our data model and entities in place.
            That means we can now create the real Endpoint Methods and throw away the testPersist Endpoint.
        </p>



        <div class="row">
            <div class="col-md-8">
            {{ csSource(lang='java', filepath="src/main/java/com/codeclou/kitchen/duty/rest/", filename="KitchenDutyPlanningResource.java", uniqueId='xtrfdg54ze56dhr', ghBaseUrl=(gitHubBaseUrlForStep4 | replace("__COMMIT__", "e923ee619b945042bc37217e78b3aead2f8a4b44")), source='
            |package io.codeclou.kitchen.duty.rest;
            |...
            |
            |@Named
            |@Path("/planning")
            |public class KitchenDutyPlanningResource {
            |...
            |
            |    /**
            |     * Get the Users assigned to the weekNumber.
            |     *
            |     * @param weekNumber
            |     * @return
            |     */
            |    @GET
            |    @Path("/week/{weekNumber}/users")
            |    @Produces({MediaType.APPLICATION_JSON})
            |    @AnonymousAllowed
            |    public Response getUsersForWeek(@PathParam("weekNumber") final Integer weekNumber) {
            |        Week[] weeks = activeObjects.executeInTransaction(new TransactionCallback<Week[]>() { {{{point::1}}}
            |            @Override
            |            public Week[] doInTransaction() {
            |                return activeObjects.find( {{{point::2}}}
            |                           Week.class,
            |                           Query.select().where("WEEK = ?", weekNumber)); {{{point::3}}}
            |            }
            |        });
            |        List<KitchenDutyPlanningResourceUserModel> users = new ArrayList<>(); {{{point::4}}}
            |        if (weeks != null && weeks.length > 0) { {{{point::5}}}
            |            for (User user : weeks[0].getUsers()) { {{{point::6}}}
            |                users.add(
            |                   new KitchenDutyPlanningResourceUserModel( {{{point::7}}}
            |                            user.getID(),
            |                            user.getName()
            |                   )
            |                );
            |            }
            |        }
            |        return Response.ok(users).build(); {{{point::8}}}
            |    }
            |
            |    /**
            |     * Get the Weeks assigned to the User.
            |     *
            |     * @param weekNumber
            |     * @return
            |     */
            |    @GET
            |    @Path("/user/{username}/weeks")
            |    @Produces({MediaType.APPLICATION_JSON})
            |    @AnonymousAllowed
            |    public Response getWeeksForUser(@PathParam("username") final String username) { {{{point::9}}}
            |        User[] users = activeObjects.executeInTransaction(new TransactionCallback<User[]>() {
            |            @Override
            |            public User[] doInTransaction() {
            |                return activeObjects.find(User.class, Query.select().where("NAME = ?", username));
            |            }
            |        });
            |        List<KitchenDutyPlanningResourceWeekModel> weeks = new ArrayList<>();
            |        if (users != null && users.length > 0) {
            |            for (Week week : users[0].getWeeks()) {
            |                weeks.add(new KitchenDutyPlanningResourceWeekModel(week.getID(), week.getWeek()));
            |            }
            |        }
            |        return Response.ok(weeks).build();
            |    }
            |...
            |}
            ') }}
            </div>
            <div class="col-md-4">
                <!-- no sticky here since block is too big -->
                <div class="list-group cs-source-point-list" data-source-target="xtrfdg54ze56dhr">
                    <div class="list-group-item cs-source-point-list__item">
                        In our new <strong><code>/week/{weekNumber}/users</code> Endpoint</strong>
                        we start a Transaction and specify <code>Week[]</code> as return type since there is no way <em>(at least I did not find one)</em>
                        to get only one entity from the Database. We always get a List. Since we are having our unique constraints setup our lists will most likely
                        only contain one value.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Now we use a new method <code>find(...)</code> of the Active Objects class which will return a List of Weeks
                        found in the database.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Via the <code>Query.select().where(...)</code> we define that we only want to get records that have
                        the week number set we passed as the Endpoints <code>@PathParam</code>.
                        And please be aware that you HAVE TO add spaces in <code>"WEEK = ?"</code> otherwise it is Exception-Day for you.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        What are we doing now? We just received a Week-Array from the activeObjects object most likely being cglib-proxy objects
                        that might be lazy <em>(even though we specified <code>@Preload</code>)</em>.
                        That being said and me being very paranoid when it comes to my REST APIs I always want to seperate the Data Model that is populate
                        to the User via the API from my internal Data Model used by the Database. Therefore I always setup simple POJOs that get a copy of the relevant database values.
                        For example your REST-API User object might not contain a password property even though your Database User object does.
                        <em>(And yes we could hide it with some kind of Hide-Json-Annotation, but a clear separation is what worked best for me so far.)</em>
                        If you like you can try to skip out this step and directly pass your Database Entitiy objects out via the REST Endpoint.
                        You might need to setup the JAX-WS Annotations on your Entities then.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        We simply check if we got an empty result from out database lookup and if not we continue.
                        And if we got an empty result we return the empty List as Endpoint response.
                        This is always better as passing NULL and having trouble in your JS Controller handling these shenanigans.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        We iterate over our Results with a for-loop. And if you want to be fancy you can do this in a more fashioned way ...
                        I already see the scala nerds roll their eyes .... anyways we are fine with it.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Now we create such a REST-API-Pojo via a convenience constructor to copy the needed values
                        from our database entity.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Lastly we return our list of users as Endpoint response.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        The exact same thing is done for the <strong><code>/user/{username}/weeks</code> Endpoint</strong>. The same explanations apply.
                    </div>
                </div>
            </div>
        </div>

        <p>We have just used the <strong>REST-API-Pojos</strong> which we will define right now. No magic just getters and setters and some JAX-WS Annotations you have seen in previous steps of the tutorial already.
        The only fancy thing is the convenience constructor but yeah ... just copy paste those two since it's not a big deal.</p>

        <p>
            {{ csSource(lang='java', filepath="src/main/java/com/codeclou/kitchen/duty/rest/", filename="KitchenDutyPlanningResourceWeekModel.java", ghBaseUrl=(gitHubBaseUrlForStep4 | replace("__COMMIT__", "e923ee619b945042bc37217e78b3aead2f8a4b44")), source='
            |package io.codeclou.kitchen.duty.rest;
            |
            |import javax.xml.bind.annotation.XmlAccessType;
            |import javax.xml.bind.annotation.XmlAccessorType;
            |import javax.xml.bind.annotation.XmlElement;
            |import javax.xml.bind.annotation.XmlRootElement;
            |
            |@XmlRootElement(name = "weeks")
            |@XmlAccessorType(XmlAccessType.FIELD)
            |public class KitchenDutyPlanningResourceWeekModel {
            |
            |    @XmlElement
            |    private Integer id;
            |
            |    @XmlElement
            |    private Integer week;
            |
            |    KitchenDutyPlanningResourceWeekModel() { }
            |
            |    KitchenDutyPlanningResourceWeekModel(Integer id, Integer week) {
            |        this.id = id;
            |        this.week = week;
            |    }
            |
            |    public Integer getId() {
            |        return id;
            |    }
            |
            |    public void setId(Integer id) {
            |        this.id = id;
            |    }
            |
            |    public Integer getWeek() {
            |        return week;
            |    }
            |
            |    public void setWeek(Integer week) {
            |        this.week = week;
            |    }
            |}
            ') }}
        </p>


        <p>
            {{ csSource(lang='java', filepath="src/main/java/com/codeclou/kitchen/duty/rest/", filename="KitchenDutyPlanningResourceUserModel.java", ghBaseUrl=(gitHubBaseUrlForStep4 | replace("__COMMIT__", "e923ee619b945042bc37217e78b3aead2f8a4b44")), source='
            |package io.codeclou.kitchen.duty.rest;
            |
            |import javax.xml.bind.annotation.XmlAccessType;
            |import javax.xml.bind.annotation.XmlAccessorType;
            |import javax.xml.bind.annotation.XmlElement;
            |import javax.xml.bind.annotation.XmlRootElement;
            |
            |@XmlRootElement(name = "users")
            |@XmlAccessorType(XmlAccessType.FIELD)
            |public class KitchenDutyPlanningResourceUserModel {
            |
            |    @XmlElement
            |    private Integer id;
            |
            |    @XmlElement
            |    private String username;
            |
            |    KitchenDutyPlanningResourceUserModel() { }
            |
            |    KitchenDutyPlanningResourceUserModel(Integer id, String username) {
            |        this.id = id;
            |        this.username = username;
            |    }
            |
            |    public Integer getId() {
            |        return id;
            |    }
            |
            |    public void setId(Integer id) {
            |        this.id = id;
            |    }
            |
            |    public String getUsername() {
            |        return username;
            |    }
            |
            |    public void setUsername(String username) {
            |        this.username = username;
            |    }
            |}
            ') }}
        </p>

        <p>Alright we again are at a point where we want to start JIRA and fire some request against our API to check it out.</p>

        {{ csShell(shellCmd='atlas-run') }}


        <p>Now we can query these two endpoints with the following example requests.</p>

        <p><strong>List assigned users for week 42.</strong></p>

        {{ csShell(shellCmd='curl --user admin:admin -H \'Content-Type: application/json\' http://localhost:2990/jira/rest/kitchenduty/1.0/planning/week/42/users', shellCmdOutput='
        |[{"id":2,"username":"ichiban"}]
        ') }}

        <p><strong>List weeks for user ichiban.</strong></p>

        {{ csShell(shellCmd='curl --user admin:admin -H \'Content-Type: application/json\' http://localhost:2990/jira/rest/kitchenduty/1.0/planning/user/ichiban/weeks', shellCmdOutput='
        |[{"id":2,"week":42}]
        ') }}


        <p>
            That is working fine. In the next section we will deal with assigning Users to Weeks and removing assignments.
        </p>

        <div class="cs-v-spacer cs-v-spacer--big"></div>





        <!--
        AO 1.2.0 - Indexes example: https://developer.atlassian.com/docs/atlassian-platform-common-components/active-objects/ao-1-2-0-upgrade-guide
        -->






        <h3 class="cs-headline cs-headline--s">Add the PUT and DELETE Endpoints to add a User to a Week or remove him</h3>


        <p>
            Now we add the functionality to <strong>add users to weeks and remove them from weeks</strong>.
            Therefore we will need a <strong>DELETE and PUT Endpoint</strong> which we add to the <code>KitchenDutyPlanningResource</code> Class.
        </p>
        <p>
            We <strong>start with the PUT Endpoint to assign Users to Weeks</strong>.
        </p>

        <div class="row">
            <div class="col-md-8">
                {{ csSource(lang='java', filepath="src/main/java/com/codeclou/kitchen/duty/rest/", filename="KitchenDutyPlanningResource.java", uniqueId='x890uji9099n', ghBaseUrl=(gitHubBaseUrlForStep4 | replace("__COMMIT__", "e90e472228d0512b90d6ef2f6f1b9f3cae91c542")), source='
                |...
                |    /**
                |     * Add the User to the Week
                |     *
                |     * @param weekNumber
                |     * @return
                |     */
                |    @PUT {{{point::1}}}
                |    @Path("/week/{weekNumber}/users")
                |    @Produces({MediaType.APPLICATION_JSON})
                |    @AnonymousAllowed
                |    public Response addUserToWeek(@PathParam("weekNumber") final Integer weekNumber, {{{point::2}}}
                |                                  final KitchenDutyPlanningResourceUserModel userParam) { {{{point::3}}}
                |        activeObjects.executeInTransaction(new TransactionCallback<Void>() { {{{point::4}}}
                |            @Override
                |            public Void doInTransaction() {
                |                //
                |                // WEEK
                |                //
                |                Week week = KitchenDutyActiveObjectHelper.findUniqueWeek( {{{point::5}}}
                |                                 activeObjects,
                |                                 weekNumber
                |                );
                |                if (week == null) {
                |                    week = activeObjects.create(
                |                                 Week.class,
                |                                 new DBParam("WEEK", weekNumber) {{{point::6}}}
                |                    );
                |                    week.save();
                |                }
                |
                |                //
                |                // USER
                |                //
                |                User user = KitchenDutyActiveObjectHelper.findUniqueUser( {{{point::7}}}
                |                                 activeObjects,
                |                                 userParam.getUsername()
                |                );
                |                if (user == null) {
                |                    user = activeObjects.create(
                |                                 User.class,
                |                                 new DBParam("NAME", userParam.getUsername())
                |                    );
                |                    user.save();
                |                }
                |
                |                //
                |                // Establish ManyToMany Relationship
                |                //
                |                UserToWeek relationship = KitchenDutyActiveObjectHelper
                |                                             .findRelationship(activeObjects, user, week); {{{point::8}}}
                |                if (relationship != null) {
                |                    // relation already exists
                |                    return null; {{{point::9}}}
                |                }
                |                relationship = activeObjects.create(UserToWeek.class); {{{point::10}}}
                |                relationship.setUser(user);
                |                relationship.setWeek(week);
                |                relationship.save();
                |
                |                return null;
                |            }
                |        });
                |        return Response.ok().build(); {{{point::11}}}
                |    }
                |...
                ') }}
            </div>
            <div class="col-md-4">
                <!-- no sticky here since block is too big -->
                <div class="list-group cs-source-point-list" data-source-target="x890uji9099n">
                    <div class="list-group-item cs-source-point-list__item">
                        We define our new <strong><code>PUT /week/{weekNumber}/users</code> Endpoint</strong>
                        with method <code>@PUT</code> <em>(you can also use <code>@Patch</code> which would be more appropriate since we are sending increments to the Endpoints but it is up to you)</em>.
                        There is nothing more time consuming as to argue with colleagues about REST API design ... at best you look at the <a href="https://developer.github.com/v3/">GitHub REST API</a> or
                        the <a href="http://spring.io/guides/gs/accessing-data-rest/">Spring Data REST Docs</a> to get a feel for good API design. And if you
                        are ever in the position to nag about someones API just ask him <em>"Does it come with <a href="http://spring.io/understanding/HATEOAS">HATEOAS</a>?"</em> and you will immediately sound
                        like an expert. Then take a deep sip of your coffee, lean back and nod your head constantly to everything beeing said as if everything
                        being said is boring you ....
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        <code>iswoWeekNumber</code> is a <code>@PathParam</code> again.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Since it is a PUT Endpoint we will send some JSON-Request-Body from our JS-Controller or our CURL commands.
                        This JSON-Body is being automatically parsed by JAX-WS into the <code>KitchenDutyPlanningResourceUserModel</code> and you can access it via <code>userParam</code>.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        We start a Transaction again but this time we choose <code>Void</code> as return type since we will do all our shenanigans inside the
                        transaction.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Get the week by the weekNumber using our <code>findUniqueWeek</code> helper method which we will define later - just trust me that
                        it will return one for the weekNumber passed or null.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        If the week is null we just create it on the fly and continue.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Same goes for the <code>User</code>. First try to find the existing user and if the user does not exist create it.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Now we lookup if there is an existing many-to-many relationship between <code>User</code> and <code>Week</code> mapped by <code>UserToWeek</code>.
                        Therefore I create a helper method <code>findRelationship</code> which returns an <code>UserToWeek</code> object representing an existing relationship or null.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        If the relationship is not null we skip out here since the relationship already exists.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        If the relationship is null we simply create it.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        We always return HTTP 200 because in case an Exception is thrown JAX-WS will return HTTP 500 anyway.
                        If you are designing a real API add a try/catch block and return some wrapped human readable errors
                        and define HTTP Response codes for different error types. We are fine if we can check for HTTP 200 in our JS-Controller,
                        and if the response code is not 200 we know something went wrong anyway.
                    </div>
                </div>
            </div>
        </div>





        <p>To break this up a little concerning readability now follows the <strong>DELETE Endpoint to remove Week assignments of Users</strong> in the same file.</p>

        <div class="row">
            <div class="col-md-8">
                {{ csSource(lang='java', filepath="src/main/java/com/codeclou/kitchen/duty/rest/", filename="KitchenDutyPlanningResource.java", uniqueId='x890uji9099n', ghBaseUrl=(gitHubBaseUrlForStep4 | replace("__COMMIT__", "e90e472228d0512b90d6ef2f6f1b9f3cae91c542")), source='
                |...
                |
                |    /**
                |     * Remove the User from Week
                |     *
                |     * @param weekNumber
                |     * @return
                |     */
                |    @DELETE {{{point::1}}}
                |    @Path("/week/{weekNumber}/users")
                |    @Produces({MediaType.APPLICATION_JSON})
                |    @AnonymousAllowed
                |    public Response deleteUserFomWeek(@PathParam("weekNumber") final Integer weekNumber,
                |                                  final KitchenDutyPlanningResourceUserModel userParam) { {{{point::2}}}
                |        activeObjects.executeInTransaction(new TransactionCallback<Void>() {
                |            @Override
                |            public Void doInTransaction() {
                |                //
                |                // WEEK
                |                //
                |                Week week = KitchenDutyActiveObjectHelper.findUniqueWeek( {{{point::3}}}
                |                                 activeObjects,
                |                                 weekNumber
                |                );
                |                if (week == null) {
                |                    // week does not exist => no relation to delete
                |                    return null;
                |                }
                |
                |                //
                |                // USER
                |                //
                |                User user = KitchenDutyActiveObjectHelper.findUniqueUser( {{{point::4}}}
                |                                 activeObjects,
                |                                 userParam.getUsername()
                |                );
                |                if (user == null) {
                |                    // user does not exist => no relation to delete
                |                    return null;
                |                }
                |
                |                //
                |                // Delete ManyToMany Relationship
                |                //
                |                UserToWeek relationship = KitchenDutyActiveObjectHelper
                |                                             .findRelationship(activeObjects, user, week); {{{point::5}}}
                |                if (relationship != null) {
                |                    activeObjects.delete(relationship); {{{point::6}}}
                |                }
                |
                |                return null;
                |            }
                |        });
                |        return Response.ok().build();
                |    }
                |...
                ') }}
            </div>
            <div class="col-md-4">
                <!-- no sticky here since block is too big -->
                <div class="list-group cs-source-point-list" data-source-target="x890uji9099n">
                    <div class="list-group-item cs-source-point-list__item">
                        We define our Endpoint with method <code>@DELETE</code>.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        The JSON-Request-Body will be parsed into our POJO the same way as in the Endpoint above.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        In the same way as in the PUT Endpoint we try to find an existing Week by our <code>findUniqueWeek</code>
                        helper method. And if it is null it indicates that there cannot be any existing relation between user and week
                        and that we can skip out here.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Same goes for the User. Find existing user by <code>findUniqueUser</code>
                        helper method. And if it is null it indicates that there cannot be any existing relation between user and week
                        and that we can skip out here.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        If both user and week already exist try to find an existing relation by <code>findRelationship</code>
                        helper method. And if it is not null delete the relationship.
                    </div>
                </div>
            </div>
        </div>

        <p>
            To prevent code duplication and improve readability of Endpoint-code I <strong>moved some common data-access-spaghetti-code into some static Methods</strong> of the <code>KitchenDutyActiveObjectHelper</code> Class.
            It should be pretty self-explanatory.
        </p>

        <p>
            {{ csSource(lang='java', filepath="src/main/java/com/codeclou/kitchen/duty/ao/", filename="KitchenDutyActiveObjectHelper.java", ghBaseUrl=(gitHubBaseUrlForStep4 | replace("__COMMIT__", "e90e472228d0512b90d6ef2f6f1b9f3cae91c542")), source='
            |package io.codeclou.kitchen.duty.ao;
            |
            |import com.atlassian.activeobjects.external.ActiveObjects;
            |import net.java.ao.Query;
            |
            |public class KitchenDutyActiveObjectHelper {
            |
            |    public static Week findUniqueWeek(ActiveObjects activeObjects, Integer weekNumber) {
            |        Week[] weekRes = activeObjects.find(Week.class, Query.select().where("WEEK = ?", weekNumber));
            |        if ((weekRes != null && weekRes.length > 0)) {
            |            return weekRes[0];
            |        }
            |        return null;
            |    }
            |
            |    public static User findUniqueUser(ActiveObjects activeObjects, String username) {
            |        User[] userRes = activeObjects.find(User.class, Query.select().where("NAME = ?", username));
            |        if ((userRes != null && userRes.length > 0)) {
            |            return userRes[0];
            |        }
            |        return null;
            |    }
            |
            |    public static UserToWeek findRelationship(ActiveObjects activeObjects, User user, Week week) {
            |        UserToWeek[] relationships = activeObjects.find(UserToWeek.class, Query.select().where("USER_ID = ? AND WEEK_ID = ?", user.getID(), week.getID()));
            |        if ((relationships  != null && relationships .length > 0)) {
            |            return relationships[0];
            |        }
            |        return null;
            |    }
            |}
            ') }}
        </p>



        <p>Now we can fire up <code>atlas-run</code> once more and wait for JIRA startup.</p>

        <p><strong>Let's add a user called jimmy to a week 42</strong>. Fire up this curl command and it should return a HTTP 200 telling you it worked <em>(we use the CURL <code>-i</code> parameter to echo out the response headers and return code)</code></em>.
        We have written our Endpoints in a way so that the CURLs are idemponent. So if you fire it a second time you will get a HTTP 200 as well but since jimmy already is assigned to week 42 nothing happens internally.</p>

        <p>And by the way, we don't need to pass an ID for user since we don't know it and since the username has a unique constraint which makes it our technical primary key.</p>

        {{ csShell(shellCmd='curl -i --user admin:admin -H \'Content-Type: application/json\' -X PUT -d \'{ "username": "jimmy" }\' http://localhost:2990/jira/rest/kitchenduty/1.0/planning/week/42/users', shellCmdOutput='
        |HTTP/1.1 200 OK
        |...
        |Content-Type: application/json;charset=UTF-8
        |Content-Length: 0
        |Date: Fri, 09 Sep 2016 16:52:06 GMT
        ') }}

        <p><strong>Let's remove a user called ichiban from week 42.</strong></p>

        {{ csShell(shellCmd='curl -i --user admin:admin -H \'Content-Type: application/json\' -X DELETE -d \'{ "username": "ichiban" }\' http://localhost:2990/jira/rest/kitchenduty/1.0/planning/week/42/users', shellCmdOutput='
        |HTTP/1.1 200 OK
        |...
        |Content-Type: application/json;charset=UTF-8
        |Content-Length: 0
        |Date: Fri, 09 Sep 2016 16:52:06 GMT
        ') }}

        <p><strong>List assigned users for week 42.</strong></p>

        {{ csShell(shellCmd='curl --user admin:admin -H \'Content-Type: application/json\' http://localhost:2990/jira/rest/kitchenduty/1.0/planning/week/42/users', shellCmdOutput='
        |[{"id":3,"username":"jimmy"}]
        ') }}

        <p>&nbsp;</p>

        <p>Now we have all our Endpoints in place and can continue to the next step. There we will actually use our Endpoints from the JS-Controller.</p>






        <div class="cs-v-spacer"></div>
        <div class="cs-tutorial-step-review">
            <div class="cs-tutorial-step-review__headline">
                <strong>You have completed Step 4.</strong> Good Job! You can check out this step's solution on GitHub
            </div>
            <div class="cs-tutorial-step-review__link">
                <a href="https://github.com/codeclou/kitchen-duty-plugin-for-atlassian-jira/tree/master/step-04-kitchen-duty-plugin">
                    https://github.com/codeclou/kitchen-duty-plugin-for-atlassian-jira/tree/master/step-04-kitchen-duty-plugin
                </a>
            </div>
        </div>
        <div class="cs-v-spacer"></div>
        <p>The graphic shows marked green <strong>which components we implemented in this section</strong>.</p>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-10 offset-lg-1 col-xl-8 offset-xl-2">
                {{ interactiveGraphic('p07-ig01', 'kitchen-duty-planning-page--component-overview',
                '{
                    "markedAsDone": [ "webwork-action", "html-view", "user-resource", "user-search-resource-model", "user-js-controller", "kitchen-duty-resource", "kitchen-duty-planning-model" ],
                    "markedAsTodo": [  ],
                    "markedAsGrayedOut": [ ],
                    "onClick": [ ]
                }')
                }}
            </div>
        </div>

        <div class="cs-v-spacer cs-v-spacer--big"></div>
        <div class="cs-v-spacer cs-v-spacer--big"></div>

    </div>
</div>


{% endblock %}
