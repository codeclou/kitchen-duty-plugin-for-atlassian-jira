{% set CURRENT_PAGE_ID = 10 %}
{% set gitHubBaseUrlForStep6 = 'https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/__COMMIT__/step-06-kitchen-duty-plugin/' %}
{% extends layoutSourceDir + "/layout_with_sidebar.html" %}
{% block head %}
    <title>Kitchen Duty Overview Page Implementation ~ Overview Page | Plugin Development Tutorial for Atlassian JIRA® | Kitchen Duty Plugin by Comsysto Reply</title>
    <meta description="An interactive step-by-step tutorial on how to write Plugins for Atlassian JIRA® by Comsysto Reply">
    <meta name="robots" content="noindex, nofollow">
{% endblock %}
{% block content %}



<div class="row">
    <div class="col-md-12">
        {{ headline('Kitchen Duty Overview Page', 'm') }}

        <p>
            Before we continue any further we need to clean up some <strong>technical debt</strong>.
            I just realised the <strong>REST API Endpoints are not secured</strong> also the <strong>database spaghetti code</strong>
            really bugs me out. Therefore here are some completely unrelated but necessary things we need to do.
        </p>

        <h3 class="cs-headline cs-headline--s">BaseResource and AuthGuards for KitchenDutyPlanningResource Endpoint</h3>

        <div class="row">
            <div class="col-md-8">
                <p>
                    Since we will get more Endpoints now for our Overview Page we will have common code. Therefore we will create a base-class all endpoints extend from.
                    We move the common code there. The first thing is the dependencies to <code>UserManager</code> and <code>ActiveObjects</code>.
                    Next are the two <strong>AuthGuard methods</strong> we will use to secure every endpoint <code>isUserLoggedIn()</code> and <code>isUserNotAdmin()</code>.
                    Lastly we need some convenience methods to serve certain HTTP Error codes as JSON - therefore we now have <code>getUnauthorizedErrorResponse()</code> and <code>getForbiddenErrorResponse()</code>.
                </p>


                {{ csSource(lang='java', filepath="src/main/java/com/comsysto/kitchen/duty/rest/", filename="BaseResource.java", ghBaseUrl=(gitHubBaseUrlForStep6 | replace("__COMMIT__", "master")), uniqueId='fsd5', source='
                    |package com.comsysto.kitchen.duty.rest;
                    |
                    |import com.atlassian.activeobjects.external.ActiveObjects;
                    |import com.atlassian.sal.api.user.UserProfile;
                    |
                    |import javax.ws.rs.core.Response;
                    |import java.time.LocalDate;
                    |import java.time.temporal.ChronoField;
                    |import java.time.temporal.WeekFields;
                    |import java.util.ArrayList;
                    |import java.util.List;
                    |
                    |public class BaseResource {
                    |
                    |    protected com.atlassian.sal.api.user.UserManager userManager;
                    |    protected ActiveObjects activeObjects;
                    |
                    |    protected Boolean isUserLoggedIn() {
                    |        UserProfile user = userManager.getRemoteUser();
                    |        if (user != null) {
                    |            return true;
                    |        } else {
                    |            return false;
                    |        }
                    |    }
                    |
                    |    public Boolean isUserNotAdmin() {
                    |        UserProfile user = userManager.getRemoteUser();;
                    |        return (user == null || !userManager.isAdmin(user.getUserKey()));
                    |    }
                    |
                    |    protected Response getUnauthorizedErrorResponse() {
                    |        return Response.serverError()
                    |            .entity(new RestError(
                    |                RestError.errorText401,
                    |                401001,
                    |                Response.Status.UNAUTHORIZED.getStatusCode()))
                    |            .status(Response.Status.UNAUTHORIZED)
                    |            .build();
                    |    }
                    |
                    |    protected Response getForbiddenErrorResponse() {
                    |        return Response.serverError()
                    |            .entity(new RestError(
                    |                RestError.errorText403,
                    |                403001,
                    |                Response.Status.FORBIDDEN.getStatusCode()))
                    |            .status(Response.Status.FORBIDDEN)
                    |            .build();
                    |    }
                    |}
                    ')}}

            </div>
            <div class="col-md-4 text-center">
                <div style="max-width:500px">
                    <img src="/kitchen-duty-plugin-for-atlassian-jira/images/drawings/06-fffecurity.svg" class="img-fluid">
                </div>
            </div>
        </div>


        <p>You might have already seen that we use a class <code>RestError</code>. This is a simple pojo to serve our errors as JSON.</p>

        {{ csSource(lang='java', filepath="src/main/java/com/comsysto/kitchen/duty/rest/", filename="RestError.java", ghBaseUrl=(gitHubBaseUrlForStep6 | replace("__COMMIT__", "master")), uniqueId='fsdsdfsd5', source='
            |package com.comsysto.kitchen.duty.rest;
            |
            |import javax.xml.bind.annotation.XmlAccessType;
            |import javax.xml.bind.annotation.XmlAccessorType;
            |import javax.xml.bind.annotation.XmlElement;
            |import javax.xml.bind.annotation.XmlRootElement;
            |
            |@XmlRootElement(name = "status")
            |@XmlAccessorType(XmlAccessType.FIELD)
            |public class RestError {
            |
            |    public static final String errorText401 = "Unauthorized (no user is authenticated).";
            |    public static final String errorText403 = "Permission Denied (insufficient rights).";
            |
            |    @XmlElement(name = "statusCode")
            |    private Integer statusCode;
            |
            |    @XmlElement(name = "subCode")
            |    private Integer subCode;
            |
            |    @XmlElement
            |    private String message;
            |
            |    public RestError() {    }
            |
            |    public RestError(String message, Integer subCode, Integer statusCode) {
            |        this.setMessage(message);
            |        this.setStatusCode(statusCode);
            |        this.setSubCode(subCode);
            |    }
            |
            |    public Integer getStatusCode() {
            |        return statusCode;
            |    }
            |
            |    public void setStatusCode(Integer statusCode) {
            |        this.statusCode = statusCode;
            |    }
            |
            |    public String getMessage() {
            |        return message;
            |    }
            |
            |    public void setMessage(String message) {
            |        this.message = message;
            |    }
            |
            |    public Integer getSubCode() {
            |        return subCode;
            |    }
            |
            |    public void setSubCode(Integer subCode) {
            |        this.subCode = subCode;
            |    }
            |}
            |
            ')}}

            <p>Ok now we need our existing <code>KitchenDutyPlanningResource</code> <strong>to extend the <code>BaseResource</code> and use the AuthGuards</strong>.</p>
            <div class="row">
                <div class="col-md-7">
                    {{ csSource(lang='java', filepath="src/main/java/com/comsysto/kitchen/duty/rest/", filename="KitchenDutyPlanningResource.java", ghBaseUrl=(gitHubBaseUrlForStep6 | replace("__COMMIT__", "master")), uniqueId='fsdsdasfggfsd5', source='
                    |package com.comsysto.kitchen.duty.rest;
                    |
                    |...
                    |
                    |@Named
                    |@Path("/planning")
                    |public class KitchenDutyPlanningResource extends BaseResource { {{{point::1}}}
                    |
                    |    @Inject
                    |    public KitchenDutyPlanningResource(ActiveObjects activeObjects, {{{point::2}}}
                    |                                       UserManager userManager) {
                    |        this.activeObjects = activeObjects;
                    |        this.userManager = userManager;
                    |    }
                    |
                    |    public KitchenDutyPlanningResource() {
                    |    }
                    |
                    |    @GET
                    |    @Path("/week/{weekNumber}/users")
                    |    @Produces({MediaType.APPLICATION_JSON})
                    |    @AnonymousAllowed
                    |    public Response getUsersForWeek(@PathParam("weekNumber") final Integer weekNumber) {
                    |        // AUTHENTICATION
                    |        if (!this.isUserLoggedIn()) { {{{point::3}}}
                    |            return getUnauthorizedErrorResponse();
                    |        }
                    |        // AUTHORIZATION
                    |        if (this.isUserNotAdmin()) { {{{point::4}}}
                    |            return getForbiddenErrorResponse();
                    |        }
                    |        // BUSINESS LOGIC
                    |        ...
                    |    }
                    |
                    |    @PUT
                    |    @Path("/week/{weekNumber}/users")
                    |    @Produces({MediaType.APPLICATION_JSON})
                    |    @AnonymousAllowed {{{point::5}}}
                    |    public Response addUserToWeek(@PathParam("weekNumber") final Integer weekNumber,
                    |                                  final List<KitchenDutyPlanningResourceUserModel> userParams) {
                    |        // AUTHENTICATION
                    |        if (!this.isUserLoggedIn()) {
                    |            return getUnauthorizedErrorResponse();
                    |        }
                    |        // AUTHORIZATION
                    |        if (this.isUserNotAdmin()) {
                    |            return getForbiddenErrorResponse();
                    |        }
                    |        // BUSINESS LOGIC
                    |        ...
                    |    }
                    |
                    |    @DELETE
                    |    @Path("/week/{weekNumber}/users")
                    |    @Produces({MediaType.APPLICATION_JSON})
                    |    @AnonymousAllowed
                    |    public Response deleteUserFomWeek(@PathParam("weekNumber") final Integer weekNumber,
                    |                                  final KitchenDutyPlanningResourceUserModel userParam) {
                    |        // AUTHENTICATION
                    |        if (!this.isUserLoggedIn()) {
                    |            return getUnauthorizedErrorResponse();
                    |        }
                    |        // AUTHORIZATION
                    |        if (this.isUserNotAdmin()) {
                    |            return getForbiddenErrorResponse();
                    |        }
                    |        // BUSINESS LOGIC
                    |        ...
                    |    }
                    |
                    |    @GET
                    |    @Path("/user/{username}/weeks")
                    |    @Produces({MediaType.APPLICATION_JSON})
                    |    @AnonymousAllowed
                    |    public Response getWeeksForUser(@PathParam("username") final String username) {
                    |        // AUTHENTICATION
                    |        if (!this.isUserLoggedIn()) {
                    |            return getUnauthorizedErrorResponse();
                    |        }
                    |        // AUTHORIZATION
                    |        if (this.isUserNotAdmin()) {
                    |            return getForbiddenErrorResponse();
                    |        }
                    |        // BUSINESS LOGIC
                    |        ...
                    |    }
                    |
                    |
                    |    @GET
                    |    @Path("/health")
                    |    @Produces({MediaType.APPLICATION_JSON})
                    |    @AnonymousAllowed
                    |    public Response health() {
                    |        return Response.ok("ok").build();
                    |    }
                    |
                    |}
                    ')}}
            </div>
            <div class="col-md-5 cs-sticky-in-parent">
                <div class="list-group cs-source-point-list" data-source-target="fsdsdasfggfsd5">
                    <div class="list-group-item cs-source-point-list__item">
                       Class needs to extend <code>BaseResource</code> now.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                       Constructor now needs to do dependency injection for <code>UserManager</code> and <code>ActiveObjects</code>.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                       AuthGuard to ensure user is logged in. Otherwise error HTTP 401 Unauthorized is served.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                       AuthGuard to ensure user is administrator. Otherwise error HTTP 403 Forbidden is served.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        <strong>Why not just remove <code>@AnonymousAllowed</code></strong>? You can do that - then JIRA will do the authentication and error handling and most likely send you HTML errors instead of JSON.
                        Just do Authentication and Authorization the way you see it fits best for you. This is just one way to do so, but it is also risky if you forget the AuthGuards for some methods.
                        You should always have automated REST API tests ensure your plugin is really secure.
                    </div>
                </div>
            </div>
        </div>

        <p>

        </p>

        <p>You might have noticed that we use a <code>UserManager</code> that <strong>comes from the SAL API</strong>. We have already learned that we need to add a <code>@ComponentImport</code> for that.</p>


        {{ csSource(lang='java', filepath="src/main/java/com/comsysto/kitchen/duty/impl/", filename="MyPluginComponentImpl.java", ghBaseUrl=(gitHubBaseUrlForStep6 | replace("__COMMIT__", "master")), uniqueId='fsd5', source='
                |package com.comsysto.kitchen.duty.impl;
                |
                |...
                |
                |@ExportAsService ({MyPluginComponent.class})
                |@Named ("myPluginComponent")
                |public class MyPluginComponentImpl implements MyPluginComponent {
                |
                |    @ComponentImport
                |    protected com.atlassian.sal.api.user.UserManager userManager;
                |    ...
                |}
            ')}}

        <p>&nbsp;</p>











        <h3 class="cs-headline cs-headline--s">KitchenDutyActiveObjectHelper - or howto move data access spaghetti code somewhere else</h3>

        <p>
        We have previously seen our REST Endpoints full of ugly transactional data access code.
        We want to move that stuff somewhere else and have clean REST Endpoints that just call some methods and do not care about transactions.
        The code simply moves into <strong><code>KitchenDutyActiveObjectHelper</code></strong>. There it can be ugly and we do not have to see it all the time.
        </p>



        <div class="row">
            <div class="col-md-7">
                {{ csSource(lang='java', filepath="src/main/java/com/comsysto/kitchen/duty/ao/", filename="KitchenDutyActiveObjectHelper.java", ghBaseUrl=(gitHubBaseUrlForStep6 | replace("__COMMIT__", "master")), uniqueId='fsdsdasfggfsddfsdffej5', source='
                    |package com.comsysto.kitchen.duty.ao;
                    |
                    |...
                    |import java.util.ArrayList;
                    |import java.util.List;
                    |
                    |public class KitchenDutyActiveObjectHelper {
                    |
                    |    ....
                    |
                    |    //
                    |    // TRANSACTIONAL
                    |    //
                    |
                    |    public static Week getWeekByWeekNumberInTransaction(ActiveObjects activeObjects, Long weekNumber) { {{{point::1}}}
                    |        return activeObjects.executeInTransaction(new TransactionCallback<Week>() {
                    |            @Override
                    |            public Week doInTransaction() {
                    |                Week[] weeks = activeObjects.find(Week.class, Query.select().where("WEEK = ?", weekNumber));
                    |                if (weeks != null && weeks.length > 0) {
                    |                    return weeks[0];
                    |                }
                    |                return null;
                    |            }
                    |        });
                    |    }
                    |
                    |    public static List<User> getUsersAssignedToWeekInTransaction(ActiveObjects activeObjects, Week week) { {{{point::2}}}
                    |        List<User> users = new ArrayList<>(); {{{point::3}}}
                    |        if (week != null) {
                    |            UserToWeek[] relationships = activeObjects.executeInTransaction(new TransactionCallback<UserToWeek[]>() {
                    |                @Override
                    |                public UserToWeek[] doInTransaction() {
                    |                    return KitchenDutyActiveObjectHelper.findAllRelationships(activeObjects, week);
                    |                }
                    |            });
                    |            if (relationships != null) {
                    |                for (UserToWeek userToWeek : relationships) {
                    |                    users.add(userToWeek.getUser());
                    |                }
                    |            }
                    |        }
                    |        return users;
                    |    }
                    |
                    |}
                ')}}
            </div>
            <div class="col-md-5 cs-sticky-in-parent">
                <div class="list-group cs-source-point-list" data-source-target="fsdsdasfggfsddfsdffej5">
                    <div class="list-group-item cs-source-point-list__item">
                       <strong><code>getWeekByWeekNumberInTransaction()</code></strong> gives us either an object of <code>Week</code> or <code>null</code> for a certain week number.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                       <strong><code>getUsersAssignedToWeekInTransaction()</code></strong> gives us either a list of <code>List&lt;User&gt;</code> or and empty list for a certain week.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                       Note that we never return null for lists. It is always convenient in the upper layers of our code (e.g. the REST Endpoints) to not always have to null check everything.
                    </div>
                    <div class="mt-3 text-center">
                        <img src="/kitchen-duty-plugin-for-atlassian-jira/images/drawings/06-al-dente.svg" class="img-fluid" style="max-width:400px">
                    </div>
                </div>
            </div>
        </div>

        <p>These two methods are needed for our Overview Page REST Endpoint. If you are brave enough you can refactor the Planning Page REST Endpoint in the same way and move
        the code to <code>KitchenDutyActiveObjectHelper</code>.</p>

        <p>&nbsp;</p>

        <h3 class="cs-headline cs-headline--s">Kitchen Duty Overview Page REST Resource</h3>

        <p>We now need a REST Endpoint to give us all weeks with users that have kitchen duty for the whole month.</p>
        <p>
            But since we checked the <a href="https://fullcalendar.io/docs/event-object">Events Object Spec of Full Calendar</a> we know that for a
            valid event we need <strong>the start and the end date</strong>.
            We want an event representing a week which means sunday is the start date and saturday the end date.
            It is possible to calculate that in JavaScript but I decided to do it in Java.
        </p>

        {{ csSource(lang='js', filepath="", filename="desired event response for march 2018",  source='
        |[
        |  {
        |    "week": 10,
        |    "start": "2018-03-04",
        |    "end": "2018-03-10",
        |    "users": [ ]
        |  },
        |  {
        |    "week": 11,
        |    "start": "2018-03-11",
        |    "end": "2018-03-17",
        |    "users": [ "admin" ]
        |  },
        |  ...
        |]
        ') }}

        <p>Since we moved the data access code to our ActiveObjectsHelper our Endpoint looks very clean now.</p>

        <div class="row">
            <div class="col-md-7">
                {{ csSource(lang='java', filepath="src/main/java/com/comsysto/kitchen/duty/rest/", filename="KitchenDutyOverviewPageResource.java", ghBaseUrl=(gitHubBaseUrlForStep6 | replace("__COMMIT__", "master")), uniqueId='mdsihjsdfdv8', source='
                    |package com.comsysto.kitchen.duty.rest;
                    |
                    |import com.atlassian.activeobjects.external.ActiveObjects;
                    |import com.atlassian.plugins.rest.common.security.AnonymousAllowed;
                    |import com.atlassian.sal.api.user.UserManager;
                    |import com.comsysto.kitchen.duty.ao.KitchenDutyActiveObjectHelper;
                    |import com.comsysto.kitchen.duty.ao.User;
                    |import com.comsysto.kitchen.duty.ao.Week;
                    |
                    |...
                    |import java.util.ArrayList;
                    |import java.util.List;
                    |import java.util.stream.Collectors;
                    |
                    |@Named
                    |@Path("/overview_page")
                    |public class KitchenDutyOverviewPageResource extends BaseResource {
                    |
                    |    @Inject
                    |    public KitchenDutyOverviewPageResource(ActiveObjects activeObjects,
                    |                                           UserManager userManager) {
                    |        this.activeObjects = activeObjects;
                    |        this.userManager = userManager;
                    |    }
                    |    public KitchenDutyOverviewPageResource() { }
                    |
                    |    @GET
                    |    @Path("/year/{year}/month/{month}") {{{point::1}}}
                    |    @Produces({MediaType.APPLICATION_JSON})
                    |    @AnonymousAllowed
                    |    public Response getUsersForWeek(@PathParam("year") final Long year,
                    |                                    @PathParam("month") final Long month) {
                    |        // AUTHENTICATION
                    |        if (!this.isUserLoggedIn()) {
                    |            return getUnauthorizedErrorResponse();
                    |        }
                    |        // BUSINESS LOGIC
                    |        List<KitchenDutyOverviewPageMonthDutyModel> responseList = new ArrayList<>();
                    |        List<Long> weekNumbersInMonth = getWeeksOfMonth(year, month); {{{point::2}}}
                    |        for (Long weekNumber : weekNumbersInMonth) {
                    |            Week week = KitchenDutyActiveObjectHelper {{{point::3}}}
                    |                         .getWeekByWeekNumberInTransaction(activeObjects, weekNumber);
                    |            List<User> usersForWeek = KitchenDutyActiveObjectHelper {{{point::4}}}
                    |                         .getUsersAssignedToWeekInTransaction(activeObjects, week);
                    |            List<String> usernames = usersForWeek
                    |                         .stream()
                    |                         .map(user -> user.getName())
                    |                         .collect(Collectors.toList()); {{{point::5}}}
                    |            responseList.add(new KitchenDutyOverviewPageMonthDutyModel(
                    |                weekNumber,
                    |                getFirstDayOfWeekOfYear(year, weekNumber).toString(), {{{point::6}}}
                    |                getLastDayOfWeekOfYear(year, weekNumber).toString(), {{{point::7}}}
                    |                usernames)
                    |            );
                    |        }
                    |
                    |        return Response.ok(responseList).build();
                    |    }
                    |
                    |}
                    |
                ')}}
            </div>
            <div class="col-md-5 cs-sticky-in-parent">
                <div class="list-group cs-source-point-list" data-source-target="mdsihjsdfdv8">
                    <div class="list-group-item cs-source-point-list__item">
                        The URL should map to <code>/year/{year}/month/{month}</code>
                        so that we can query for e.g. <code>/year/2018/month/8</code>
                        and get all weeks for that month. We always get 5 weeks.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Get all weeks in that month.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Query the database and get existing Week Object.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Get the users for that week (nullsafe = return empty list if no users found)
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Map the user objects to stringified usernames.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Now we build our event list as <code>KitchenDutyOverviewPageMonthDutyModel</code>
                        objects with week, start-date and end-date.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        <code>getFirstDayOfWeekOfYear()</code> gets you the date of the first day of the week (sunday).
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        <code>getLastDayOfWeekOfYear()</code> gets you the date of the last day of the week (saturday).
                    </div>
                </div>
            </div>
        </div>

        <p>The pojo for the week-events with start and end-date. The rest will be mapped in the JS controller.</p>

        {{ csSource(lang='java', filepath="src/main/java/com/comsysto/kitchen/duty/rest/", filename="KitchenDutyOverviewPageMonthDutyModel.java", ghBaseUrl=(gitHubBaseUrlForStep6 | replace("__COMMIT__", "master")), uniqueId='kjnbhuivozuo89o', source='
            |package com.comsysto.kitchen.duty.rest;
            |
            |import javax.xml.bind.annotation.XmlAccessType;
            |import javax.xml.bind.annotation.XmlAccessorType;
            |import javax.xml.bind.annotation.XmlElement;
            |import javax.xml.bind.annotation.XmlRootElement;
            |import java.util.List;
            |
            |/*
            | * We want this entity to be directly usable as full calendar event object
            | * https://fullcalendar.io/docs/event-object
            | */
            |@XmlRootElement(name = "duty")
            |@XmlAccessorType(XmlAccessType.FIELD)
            |public class KitchenDutyOverviewPageMonthDutyModel {
            |
            |    @XmlElement
            |    private Long week;
            |
            |    @XmlElement
            |    private String start; /* Date String - First day of week (Sunday) */
            |    @XmlElement
            |    private String end; /* Date String - Last day of week (Monday) */
            |
            |    @XmlElement
            |    private List<String> users;
            |
            |    public KitchenDutyOverviewPageMonthDutyModel(Long week, String start, String end, List<String> users) {
            |        this.start = start;
            |        this.end = end;
            |        this.week = week;
            |        this.users = users;
            |    }
            |
            |    public Long getWeek() {
            |        return week;
            |    }
            |
            |    public void setWeek(Long week) {
            |        this.week = week;
            |    }
            |
            |    public List<String> getUsers() {
            |        return users;
            |    }
            |
            |    public void setUsers(List<String> users) {
            |        this.users = users;
            |    }
            |
            |    public String getStart() {
            |        return start;
            |    }
            |
            |    public void setStart(String start) {
            |        this.start = start;
            |    }
            |
            |    public String getEnd() {
            |        return end;
            |    }
            |
            |    public void setEnd(String end) {
            |        this.end = end;
            |    }
            |}
            |
        ')}}

        <p>The <strong>date calculation helpers <code>getWeeksOfMonth()</code>, <code>getFirstDayOfWeekOfYear()</code> and <code>getLastDayOfWeekOfYear()</code> are defined in <code>BaseResource.java</code></strong>.</p>

        <div class="row">
            <div class="col-md-7">
                {{ csSource(lang='java', filepath="src/main/java/com/comsysto/kitchen/duty/rest/", filename="BaseResource.java", ghBaseUrl=(gitHubBaseUrlForStep6 | replace("__COMMIT__", "master")), uniqueId='sg4ddf', source='
                    |package com.comsysto.kitchen.duty.rest;
                    |
                    |import com.atlassian.activeobjects.external.ActiveObjects;
                    |import com.atlassian.sal.api.user.UserProfile;
                    |
                    |import javax.ws.rs.core.Response;
                    |import java.time.DayOfWeek;
                    |import java.time.LocalDate;
                    |import java.time.Month;
                    |import java.time.temporal.ChronoField;
                    |import java.time.temporal.TemporalField;
                    |import java.time.temporal.WeekFields;
                    |import java.util.ArrayList;
                    |import java.util.List;
                    |import java.util.Locale;
                    |
                    |public class BaseResource {
                    |
                    |    ...
                    |
                    |    // See unit test
                    |    public static List<Long> getWeeksOfMonth(Long year, Long month) { {{{point::1}}}
                    |        List<Long> weeks = new ArrayList<>();
                    |        weeks.add(getWeekOfMonth(year, month, 1L));
                    |        weeks.add(getWeekOfMonth(year, month, 2L));
                    |        weeks.add(getWeekOfMonth(year, month, 3L));
                    |        weeks.add(getWeekOfMonth(year, month, 4L));
                    |        weeks.add(getWeekOfMonth(year, month, 5L));
                    |        return weeks;
                    |    }
                    |
                    |    protected static Long getWeekOfMonth(Long year, Long month, Long weekInMonth) { {{{point::2}}}
                    |        // https://docs.oracle.com/javase/8/docs/api/java/time/temporal/WeekFields.html
                    |        // For locale en_US weeks start on sunday
                    |        WeekFields weekFields = WeekFields.of(Locale.forLanguageTag("en_US"));
                    |        LocalDate origin  = LocalDate.of(1970, 1, 1);
                    |        LocalDate reference = origin
                    |            .with(weekFields.weekBasedYear(), year)
                    |            .with(ChronoField.YEAR, year)
                    |            .with(ChronoField.MONTH_OF_YEAR, month)
                    |            .with(ChronoField.ALIGNED_DAY_OF_WEEK_IN_MONTH, 1)
                    |            .with(ChronoField.ALIGNED_WEEK_OF_MONTH, weekInMonth);
                    |        return (long) reference.get(weekFields.weekOfYear());
                    |    }
                    |
                    |    public static LocalDate getFirstDayOfWeekOfYear(Long year, Long week) { {{{point::3}}}
                    |        // https://docs.oracle.com/javase/8/docs/api/java/time/temporal/WeekFields.html
                    |        WeekFields weekFields = WeekFields.of(Locale.forLanguageTag("en_US"));
                    |        return LocalDate.now()
                    |            .with(weekFields.weekBasedYear(), year)
                    |            .with(ChronoField.ALIGNED_WEEK_OF_YEAR, week)
                    |            .with(ChronoField.DAY_OF_WEEK, 1).minusDays(1);
                    |    }
                    |
                    |    public static LocalDate getLastDayOfWeekOfYear(Long year, Long week) { {{{point::4}}}
                    |        return getFirstDayOfWeekOfYear(year, week).plusDays(6);
                    |    }
                    |}
                    |
                ')}}
            </div>
            <div class="col-md-5 cs-sticky-in-parent">
                <div class="list-group cs-source-point-list" data-source-target="sg4ddf">
                    <div class="list-group-item cs-source-point-list__item">
                        <code>getWeeksOfMonth()</code> returns five weeks with week numbers
                        for given year and month.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        <code>getWeekOfMonth()</code> returns the week number
                        for given year, month and weekInMonth. Ok if it sounds confusing look
                        at the Unit Test. But simply said this methods converts
                        week 1-5 of a specific month to the week-of-year-number.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        <code>getFirstDayOfWeekOfYear()</code> returns the first day of the week (sunday)
                        for a given year and week.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        <code>getLastDayOfWeekOfYear()</code> returns the last day of the week (saturday)
                        for a given year and week.
                    </div>
                </div>
            </div>
        </div>

        <p>The <strong>Unit Test for the date calculation helpers</strong> looks like this. Just simple asserts, nothing special.</p>

        {{ csSource(lang='java', filepath="src/test/java/ut/com/comsysto/kitchen/duty/rest/", filename="BaseResourceTest.java", ghBaseUrl=(gitHubBaseUrlForStep6 | replace("__COMMIT__", "master")), uniqueId='sgsdfhxsdf4ddf', source='
            |package ut.com.comsysto.kitchen.duty.rest;
            |
            |import com.comsysto.kitchen.duty.rest.BaseResource;
            |import org.junit.Test;
            |
            |import java.time.LocalDate;
            |import java.util.Arrays;
            |import java.util.List;
            |
            |import static org.hamcrest.core.Is.is;
            |import static org.junit.Assert.assertEquals;
            |import static org.junit.Assert.assertThat;
            |
            |public class BaseResourceTest {
            |
            |    @Test
            |    public void testGetWeeksOfMonth__weekStartsInPreviousMonth() {
            |        // Sunday to Saturday:
            |        // Week 31  July   29, 2018 => August  4, 2018
            |        // Week 32  August  5, 2018 => August 11, 2018
            |        // Week 33  August 12, 2018 => August 18, 2018
            |        // Week 34  August 19, 2018 => August 25, 2018
            |        // Week 35  August 26, 2018 => Sept,   1, 2018
            |        {
            |            List<Long> weeks = BaseResource.getWeeksOfMonth(2018L, 8L);
            |            assertThat(weeks, is(Arrays.asList(31L, 32L, 33L, 34L, 35L)));
            |        }
            |
            |        // Sunday to Saturday:
            |        // Week 5  January  28, 2018 => February  3, 2018
            |        // Week 6  February  4, 2018 => February 10, 2018
            |        // Week 7  February 11, 2018 => February 17, 2018
            |        // Week 8  February 18, 2018 => February 24, 2018
            |        // Week 9  February 25, 2018 => March     3, 2018
            |        {
            |            List<Long> weeks = BaseResource.getWeeksOfMonth(2018L, 2L);
            |            assertThat(weeks, is(Arrays.asList(5L, 6L, 7L, 8L, 9L)));
            |        }
            |
            |        // Sunday to Saturday:
            |        // Week 18  April 29, 2018 => May   5, 2018
            |        // Week 19  May    6, 2018 => May  12, 2018
            |        // Week 20  May   13, 2018 => May  19, 2018
            |        // Week 21  May   20, 2018 => May  26, 2018
            |        // Week 22  May   27, 2018 => June  2, 2018
            |        {
            |            List<Long> weeks = BaseResource.getWeeksOfMonth(2018L, 5L);
            |            assertThat(weeks, is(Arrays.asList(18L, 19L, 20L, 21L, 22L)));
            |        }
            |    }
            |
            |    @Test
            |    public void testGetWeeksOfMonth__weekStartsExactlyInMonth() {
            |        // Sunday to Saturday:
            |        // Week 19  May  1, 2016 => May  7, 2016
            |        // Week 20  May  8, 2016 => May 14, 2016
            |        // Week 21  May 15, 2016 => May 21, 2016
            |        // Week 22  May 22, 2016 => May 28, 2016
            |        // Week 23  May 29, 2016 => June 4, 2016
            |        {
            |            List<Long> weeks = BaseResource.getWeeksOfMonth(2016L, 5L);
            |            assertThat(weeks, is(Arrays.asList(19L, 20L, 21L, 22L, 23L)));
            |        }
            |
            |        // Sunday to Saturday:
            |        // Week 27  July  1, 2018 => July  7, 2018
            |        // Week 28  July  8, 2018 => July 14, 2018
            |        // Week 29  July 15, 2018 => July 21, 2018
            |        // Week 30  July 22, 2018 => July 28, 2018
            |        // Week 31  July 29, 2018 => Aug.  4, 2018
            |        {
            |            List<Long> weeks = BaseResource.getWeeksOfMonth(2018L, 7L);
            |            assertThat(weeks, is(Arrays.asList(27L, 28L, 29L, 30L, 31L)));
            |        }
            |    }
            |
            |    @Test
            |    public void testGetFirstDayOfWeekOfMonth() {
            |        LocalDate date = BaseResource.getFirstDayOfWeekOfYear(2018L, 32L);
            |        assertEquals("2018-08-05", date.toString());
            |
            |        LocalDate date2 = BaseResource.getFirstDayOfWeekOfYear(2018L, 31L);
            |        assertEquals("2018-07-29", date2.toString());
            |
            |        LocalDate date3 = BaseResource.getFirstDayOfWeekOfYear(2018L, 27L);
            |        assertEquals("2018-07-01", date3.toString());
            |    }
            |
            |    @Test
            |    public void testGetLastDayOfWeekOfMonth() {
            |        LocalDate date = BaseResource.getLastDayOfWeekOfYear(2018L, 32L);
            |        assertEquals("2018-08-11", date.toString());
            |
            |        LocalDate date2 = BaseResource.getLastDayOfWeekOfYear(2018L, 31L);
            |        assertEquals("2018-08-04", date2.toString());
            |    }
            |
            |}
        ')}}


        <p>Ok if we now do a curl on the Endpoint it looks like this. We always get five weeks within the month (or with minor overlap).</p>


        {{ csShell(shellCmd='curl --user admin:admin http://localhost:2990/jira/rest/kitchenduty/1.0/overview_page/year/2018/month/3', shellCmdOutput='
                |[
                |  {
                |    "week": 10,
                |    "start": "2018-03-04",
                |    "end": "2018-03-10",
                |    "users": [ ]
                |  },
                |  {
                |    "week": 11,
                |    "start": "2018-03-11",
                |    "end": "2018-03-17",
                |    "users": [ "admin" ]
                |  },
                |  {
                |    "week": 12,
                |    "start": "2018-03-18",
                |    "end": "2018-03-24",
                |    "users": [ ]
                |  },
                |  {
                |    "week": 13,
                |    "start": "2018-03-25",
                |    "end": "2018-03-31",
                |    "users": [ ]
                |  },
                |  {
                |    "week": 14,
                |    "start": "2018-04-01",
                |    "end": "2018-04-07",
                |    "users": [ ]
                |  }
                |]
         ') }}


    <p>The code for our endpoint is complete now. Let's move on.</p>


    <h3 class="cs-headline cs-headline--s">Kitchen Duty Overview Page Webwork Action and WebItems</h3>

    <p>Ok now again comes the ugly XML part. We need a dedicated page that can be accessed by every logged in user to display
    the calendar. And we need a <a href="https://developer.atlassian.com/server/jira/platform/web-item/">Web Item</a> link in the top JIRA navigation bar.</p>

    {{ image('doc/step-06-web-item.png', 'Step 6 - Web Item - Link to Overview Page from navigation top bar', '60%') }}

    <p>Also we want to link to the Overview Page from the Planning Page to make navigating easy.</p>

    {{ image('doc/step-06-planning-page-link-to-overview.png', 'Step 6 - Web Item - Link to Overview Page from Planning Page', '60%') }}


    <div class="row">
        <div class="col-md-7">
            {{ csSource(lang='xml', filepath="src/main/resources/", filename="atlassian-plugin.xml", ghBaseUrl=(gitHubBaseUrlForStep6 | replace("__COMMIT__", "master")), uniqueId='knjbihvutzczdgui', source='
                |<atlassian-plugin key="${atlassian.plugin.key}" name="${project.name}" plugins-version="2">
                |  ...
                |  <web-item key="admin_kitchen_duty_overview_webitem"  {{{point::1}}}
                |       name="admin_kitchen_duty_overview_webitem"
                |       section="admin_plugins_menu/admin_kitchen_duty_planning_section"
                |       weight="14" i18n-name-key="kitchen-duty-plugin.admin.overview.page.web.item.name">
                |     <label key="kitchen-duty-plugin.admin.overview.page.web.item.name"/>
                |     <link linkId="admin_kitchen_duty_overview_webitem_link">/secure/KitchenDutyOverviewPageWebworkAction.jspa</link>
                |  </web-item>
                |  ...
                |  <!-- ====================== -->
                |  <!-- OVERVIEW PAGE -->
                |  <!-- ====================== -->
                |  <web-resource key="kitchen-duty-plugin-resources--overview-page" {{{point::2}}}
                |       name="kitchen-duty-plugin Web Resources for Overview Page">
                |    <dependency>com.atlassian.auiplugin:ajs</dependency>
                |    <dependency>com.atlassian.auiplugin:aui-experimental-soy-templates</dependency>
                |    <transformation extension="soy">
                |      <transformer key="soyTransformer">
                |        <functions>com.atlassian.confluence.plugins.soy:soy-core-functions</functions>
                |      </transformer>
                |    </transformation>
                |    <resource type="download" name="momentjs.js"
                |              location="/js/3rdparty/moment-2.22.2.min.js"/>   {{{point::3}}}
                |    <resource type="download" name="fullcalendar.js"
                |              location="/js/3rdparty/fullcalendar-3.9.0.min.js"/>   {{{point::4}}}
                |    <resource type="download" name="fullcalendar.css"
                |              location="/css/3rdparty/fullcalendar-3.9.0.min.css"/>   {{{point::5}}}
                |    <resource type="download" name="kitchen-duty-overview-soy.js"
                |              location="templates-soy/kitchen-duty-overview.soy"/>     {{{point::6}}}
                |    <resource type="download" name="kitchen-duty-plugin--overview-page-controller.js"
                |              location="/js/kitchen-duty-plugin--overview-page-controller.js"/>   {{{point::7}}}
                |    <context>kitchen-duty-plugin</context>
                |  </web-resource>
                |  <webwork1 key="kitchen-duty-overview-page-webwork-module"
                |            name="Kitchen Duty Overview Page Webwork Module"
                |            i18n-name-key="kitchen-duty-overview-page-webwork-module.name"
                |            roles-required="use">  {{{point::8}}}
                |    <description
                |      key="kitchen-duty-overview-page-webwork-module.description"
                |    >The Kitchen Duty Overview Page Webwork Module Plugin</description>
                |    <actions>
                |      <action name="com.comsysto.kitchen.duty.webwork.KitchenDutyOverviewPageWebworkAction"
                |              alias="KitchenDutyOverviewPageWebworkAction"> {{{point::9}}}
                |        <view
                |          name="kitchen-duty-overview-page-success" {{{point::10}}}
                |        >/templates/kitchen-duty-overview-page-webwork-module/kitchen-duty-overview-page-success.vm</view>
                |      </action>
                |    </actions>
                |  </webwork1>
                |  <web-item key="user_kitchen_duty_overview_webitem" {{{point::11}}}
                |            name="user_kitchen_duty_overview_webitem"
                |            section="system.top.navigation.bar"
                |            weight="60"
                |            i18n-name-key="kitchen-duty-plugin.user.overview.page.web.item.name">
                |    <label key="kitchen-duty-plugin.user.overview.page.web.item.name"/>
                |    <link
                |      linkId="user_kitchen_duty_overview_webitem_link"
                |    >/secure/KitchenDutyOverviewPageWebworkAction.jspa</link>
                |  </web-item>
                |  ...
                |</atlassian-plugin>
                ')}}
            </div>
            <div class="col-md-5 cs-sticky-in-parent">
                <div class="list-group cs-source-point-list" data-source-target="knjbihvutzczdgui">
                    <div class="list-group-item cs-source-point-list__item">
                        First we need a link to the Overview Page from the side navigation when we are on the Planning Page.
                        You can see it in the screenshot above.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        We define a dedicated web-resource section to provide CSS, JS and Soy resources for the Overview Page.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        We reuse the moment-js library we already used on the planning page since the full calendar library depends on moment-js.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Next we put a copy of fullcalendar.min.js to <code>src/main/resources/js/3rdparty</code>.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        The full calendar also needs a copy of fullcalendar.min.css to <code>src/main/resources/css/3rdparty</code>.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        For the Overview Page we also define a dedicated soy template in <code>src/main/resources/templates-soy/kitchen-duty-overview.soy</code>.
                        We will create the file later in full detail.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        The Overview Page has its own JS-controller in <code>src/main/resources/js/kitchen-duty-plugin--overview-page-controller.js</code>.
                        We will create the file later in full detail.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        The actual page is defined as a web work module. The <code>roles-required="use"</code> ensures only logged in users
                        can view the page.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        The module contains the actual action to the <code>KitchenDutyOverviewPageWebworkAction.java</code>.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        As usual we define a velocity template for our web work action in <code>src/main/resources/templates/kitchen-duty-overview-page-webwork-module/kitchen-duty-overview-page-success.vm</code>.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Lastly we define a web-item with the link to the Overview Page in the JIRA top navigation bar.
                    </div>
                </div>
            </div>
        </div>

        <p>All these xml things have <strong>i18n keys which we need to put in our translation file</strong>. Keep in mind that encoding for property files is ISO 8859-1.</p>

        {{ csSource(lang='ini', filepath="src/main/resources/", filename="kitchen-duty-plugin.properties", ghBaseUrl=(gitHubBaseUrlForStep6 | replace("__COMMIT__", "master")), uniqueId='kmjihuzt76890', source='
        |# admin
        |kitchen-duty-plugin.admin.overview.page.web.item.name = Overview Page
        |
        |# kitchen-duty-overview-page-success.vm
        |kitchen-duty-plugin.user.overview.page.title = Kitchen Duty Plugin - Overview Page
        |
        |# webitem
        |kitchen-duty-plugin.user.overview.page.web.item.name = Kitchen Duty
        ') }}

        <p>Now we define our <strong>web work action</strong> that displays the velocity template and loads the overview page resources.</p>

        {{ csSource(lang='java', filepath="src/main/java/com/comsysto/kitchen/duty/webwork/", filename="KitchenDutyOverviewPageWebworkAction.java", ghBaseUrl=(gitHubBaseUrlForStep6 | replace("__COMMIT__", "master")), uniqueId='ckjnihbugvzf8', source='
        |package com.comsysto.kitchen.duty.webwork;
        |
        |import com.atlassian.jira.web.action.JiraWebActionSupport;
        |import com.atlassian.webresource.api.assembler.PageBuilderService;
        |import org.slf4j.Logger;
        |import org.slf4j.LoggerFactory;
        |
        |import javax.inject.Inject;
        |import javax.inject.Named;
        |
        |@Named
        |public class KitchenDutyOverviewPageWebworkAction extends JiraWebActionSupport
        |{
        |    private static final Logger log = LoggerFactory.getLogger(KitchenDutyOverviewPageWebworkAction.class);
        |
        |    @Inject
        |    private PageBuilderService pageBuilderService;
        |
        |    @Override
        |    public String execute() throws Exception {
        |        pageBuilderService.assembler().resources()
        |            .requireWebResource("com.comsysto.kitchen-duty-plugin:kitchen-duty-plugin-resources")
        |            .requireWebResource("com.comsysto.kitchen-duty-plugin:kitchen-duty-plugin-resources--overview-page");
        |
        |        return "kitchen-duty-overview-page-success";
        |    }
        |
        |    public void setPageBuilderService(PageBuilderService pageBuilderService) {
        |        this.pageBuilderService = pageBuilderService;
        |    }
        |}
        ') }}

        <p>
            Let's also create the <strong>velocity success template</strong> now.
            On non-admin pages you have to define the <a href="https://docs.atlassian.com/aui/7.9.5/docs/navigation.html">Navigation</a> by yourself.
            Also read the doc about <a href="https://docs.atlassian.com/aui/7.9.5/docs/page.html">Page</a>.
            We simply define a div with id <code>kdp-overview-page-container</code> to hook in with our JS-controller.
        </p>

        {{ csSource(lang='html', filepath="src/main/resources/templates/kitchen-duty-overview-page-webwork-module/", filename="kitchen-duty-overview-page-success.vm", ghBaseUrl=(gitHubBaseUrlForStep6 | replace("__COMMIT__", "master")), uniqueId='kijuzg7tf6r5678io', source='
        |<html>
        |<head>
        |    <title>$i18n.getText("kitchen-duty-plugin.user.overview.page.title")</title>
        |    <meta name="decorator" content="atl.general"/>
        |</head>
        |<body>
        |<div id="page">
        |    <section id="content" role="main">
        |
        |        <header class="aui-page-header">
        |            <div class="aui-page-header-inner">
        |                <div class="aui-page-header-main">
        |                    <h1>Kitchen Duty</h1>
        |                </div>
        |            </div>
        |        </header>
        |
        |        <div class="aui-page-panel">
        |            <div class="aui-page-panel-inner">
        |                <div class="aui-page-panel-nav">
        |                    <nav class="aui-navgroup aui-navgroup-vertical">
        |                        <div class="aui-navgroup-inner">
        |                            <ul class="aui-nav">
        |                                <li class="aui-nav-selected"><a href="${req.contextPath}/secure/KitchenDutyOverviewPageWebworkAction.jspa">Overview Page</a></li>
        |                                <li><a href="${req.contextPath}/secure/KitchenDutyPlanningWebworkAction.jspa">Planning Page</a></li>
        |                            </ul>
        |                        </div>
        |                    </nav>
        |                </div>
        |                <section class="aui-page-panel-content">
        |                    <div id="kdp-overview-page-container"></div>
        |                </section>
        |            </div>
        |        </div>
        |    </section>
        |</div>
        |</body>
        |</html>
        ') }}

    <p>When clicking on 'Kitchen Duty' in the JIRA top bar now it should look like this.</p>

    {{ image('doc/step-06-overview-page-velocity.png', 'Step 6 - Velocity and Web work action - Overview Page', '60%') }}

    <p>Ok that was now the server-side part of the overview page. Let's move on to the client-side.</p>





    <h3 class="cs-headline cs-headline--s">Kitchen Duty Overview Page JS Controller and Soy Templates</h3>

    <p>As we already did it on the planning page, we again have a JS-controller using soy-templates
    and some logic to display the <a href="https://fullcalendar.io/">full calendar</a> with data from REST Endpoints on the page.</p>

    <p>Ok to be honest we could just skip using the soy template here since we do not really need it right now.
        But it is always good to follow common conventions for building our pages, so that we can easily extend them in the future.</p>




        {{ csSource(lang='soy', filepath="src/main/resources/templates-soy/", filename="kitchen-duty-overview.soy", ghBaseUrl=(gitHubBaseUrlForStep6 | replace("__COMMIT__", "master")), uniqueId='fdsfdsr4dg6dfg', source='
            |{namespace JIRA.Templates.KDPO}
            |/**
            | * Kitchen Duty Overview Page - Base Template
            | */
            |{template .overviewPage}
            |    <div id="kdp-overview">
            |        <div id="kdp-calendar"></div>
            |    </div>
            |{/template}
        ')}}

        <p>Now comes the actual <strong>controller logic to display the calendar with kitchen duty data from the REST API</strong>.</p>

        <div class="row">
            <div class="col-md-7">
                {{ csSource(lang='js', filepath="src/main/resources/js/", filename="kitchen-duty-plugin--overview-page-controller.js", ghBaseUrl=(gitHubBaseUrlForStep6 | replace("__COMMIT__", "master")), uniqueId='bhvgcfrd546857io8giubhvgj', source="
                    |AJS.toInit(function(){
                    |    AJS.log('KDP: Overview Page Controller initializing ...');
                    |    var baseUrl = AJS.params.baseURL;
                    |    var restUrl = baseUrl + '/rest/kitchenduty/1.0';
                    |    window.KDPrestUrl = restUrl;
                    |
                    |    // Init Base SOY template
                    |    var overviewPageTemplate = JIRA.Templates.KDPO.overviewPage(); {{{point::1}}}
                    |    AJS.$('#kdp-overview-page-container').html(overviewPageTemplate);
                    |
                    |    AJS.$('#kdp-calendar').fullCalendar({ {{{point::2}}}
                    |        defaultView: 'month', {{{point::3}}}
                    |        weekNumbers: true, {{{point::4}}}
                    |        height: 500,
                    |        fixedWeekCount: false,
                    |        events: function(start, end, timezone, callback) { {{{point::5}}}
                    |            // Full calendar always starts month with days of previous month.
                    |            // We add 10 days to get month we want.
                    |            var year = moment(start).add('days', 10).format('YYYY'); {{{point::6}}}
                    |            var month = moment(start).add('days', 10).format('M'); {{{point::7}}}
                    |            AJS.$.ajax({ {{{point::8}}}
                    |                url: window.KDPrestUrl + '/overview_page/year/' + year + '/month/' + month,
                    |                dataType: 'json',
                    |                success: function(rawEvents) {
                    |                    var events = [];
                    |                    AJS.$(rawEvents).each(function() { {{{point::9}}}
                    |                        var users = AJS.$(this).attr('users');
                    |                        events.push({
                    |                            title: users.join(', '), {{{point::10}}}
                    |                            start: AJS.$(this).attr('start'),
                    |                            end: AJS.$(this).attr('end'),
                    |                            color: users.length > 0 ? '#36B37E' : '#FFAB00', {{{point::11}}}
                    |                        });
                    |                    });
                    |                    callback(events);
                    |                }
                    |            });
                    |        }
                    |    });
                    |});
                ")}}
            </div>
            <div class="col-md-5 cs-sticky-in-parent">
                <div class="list-group cs-source-point-list" data-source-target="bhvgcfrd546857io8giubhvgj">
                    <div class="list-group-item cs-source-point-list__item">
                        Load the overviewPage soy template and inject it into the DOM.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Initialize the <a href="https://fullcalendar.io/">full calendar</a> in the div with id <code>kdp-calendar</code>.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        We set the <a href="https://fullcalendar.io/docs/month-view"><code>defaultView</code> to month</a>.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        We also want the <a href="https://fullcalendar.io/docs/week-numbers">week numbers displayed</a>.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Via the <a href="https://fullcalendar.io/docs/events-function">Events Function</a>
                        we fill the calendar with our kitchen duty 'events' representing each week.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        The <code>start</code> variable contains the start date of the calendar view.
                        Since we are in the month view the start date is usually some day of the previous month
                        therefore we add 10 days to get a date within the current month. Via moment-js we get the year.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        We do the same to get the current month displayed in the calendar.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Via ajax GET request we call our <code>/overview_page/year/:year/month/:month</code>
                        REST Endpoint with the month and year we get from the calendar api.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        We iterate over the <code>rawEvents</code> which are in the form of
                        <code>[ { "week": 10, "start": "2018-03-04", "end": "2018-03-10", "users": [ "bob", "steve" ] } ]</code>.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Since we need to build <a href="https://fullcalendar.io/docs/event-object">full calendar event objects</a>
                        in form of
                        <code>[ { "start": "2018-03-04", "end": "2018-03-10", "title": "bob, steve", "color": "#ff0000" } ]</code>
                        we map our values. As <code>title</code> we concatenate the users into one string.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        As <code>color</code> we display green (#36B37E) if the week has assigned users.
                        And we display orange (#FFAB00) if no users are assigned to week.
                    </div>
                </div>
            </div>
        </div>


        <p>&nbsp;</p>

        <p>Lastly - since we might use the code to display <a href="https://docs.atlassian.com/aui/7.9.5/docs/flag.html">AUI Flags</a> in both controllers - <strong>we move the common code to <code>kitchen-duty-plugin.js</code></strong>.</p>

        {{ csSource(lang='js', filepath="src/main/resources/js/", filename="kitchen-duty-plugin.js", ghBaseUrl=(gitHubBaseUrlForStep6 | replace("__COMMIT__", "master")), uniqueId='fdg6dfr67z6rg', source="
        |//
        |// COMMON CODE
        |//
        |var showSuccessFlag = function(message) {
        |    require(['aui/flag'], function(flag) {
        |        flag({
        |            type: 'success',
        |            title: 'Kitchen Duty Plugin',
        |            close: 'auto',
        |            body: message
        |        });
        |    });
        |};
        |var showErrorFlag = function(message) {
        |    require(['aui/flag'], function(flag) {
        |        flag({
        |            type: 'error',
        |            title: 'Kitchen Duty Plugin',
        |            close: 'auto',
        |            body: message
        |        });
        |    });
        |};
        ")}}


        <p>That's it. Now we can run our plugin with <code>atlas-run</code> and when navigating to <a href="http://localhost:2990/jira/secure/KitchenDutyPlanningWebworkAction.jspa">http://localhost:2990/jira/secure/KitchenDutyOverviewPageWebworkAction.jspa</a>
        it should work as you can see below. <strong>We are completely done implementing the Kitchen Duty Overview Page</strong>.</p>

        {{ image('doc/step-06-overview-page-working.gif', 'Step 6 - Overview Page working', '60%') }}



        <div class="cs-v-spacer"></div>
        <div class="cs-tutorial-step-review">
            <div class="cs-tutorial-step-review__headline">
                <strong>You have completed Step 6.</strong> Good Job! You can check out this step's solution on GitHub
            </div>
            <div class="cs-tutorial-step-review__link">
                <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/tree/master/step-06-kitchen-duty-plugin">
                    https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/tree/master/step-06-kitchen-duty-plugin
                </a>
            </div>
        </div>
        <div class="cs-v-spacer"></div>


        <p class="text-center"><strong>The tutorial is at its end. You have completed all steps. Congratulations!</strong></p>
        <div class="cs-v-spacer"></div>


    </div>
</div>


{% endblock %}
