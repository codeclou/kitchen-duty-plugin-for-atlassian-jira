<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    
    
    <title>Kitchen Duty Planning JS Controller ~ Planning Page | Plugin Development Tutorial for Atlassian JIRA® | Kitchen Duty Plugin by Comsysto Reply</title>
    <meta description="An interactive step-by-step tutorial on how to write Plugins for Atlassian JIRA® by Comsysto Reply">
    <meta name="robots" content="noindex, nofollow">


    
    <meta property="og:title" content="Kitchen Duty Plugin for Atlassian JIRA® by Comsysto Reply" />
    <meta property="og:image" content="https://comsysto.github.io/kitchen-duty-plugin-for-atlassian-jira/images/kitchen-duty-plugin--social.jpg" />
    <meta property="og:description" content="An interactive tutorial on how to write Plugins for Atlassian JIRA® by Comsysto Reply" />

    
    <link rel="canonical" href="https://comsysto.github.io/kitchen-duty-plugin-for-atlassian-jira/tutorial/08-step-05-planning-page--kitchen-duty-planning-js-controller/" />

    <link rel="alternate" type="application/rss+xml" title="Kitchen Duty Plugin News" href="https://comsysto.github.io/kitchen-duty-plugin-for-atlassian-jira/rss_feed.xml" />



    <link href="/kitchen-duty-plugin-for-atlassian-jira/generated/bundlev2.css?v2018-09-02--12-50" rel="stylesheet">

    <link rel="icon" href="/kitchen-duty-plugin-for-atlassian-jira/images/favicon-32.png" type="image/png" sizes="32x32">
    <link rel="icon" href="/kitchen-duty-plugin-for-atlassian-jira/images/favicon-256.png" type="image/png" sizes="256x256">
    <link rel="icon" href="/kitchen-duty-plugin-for-atlassian-jira/images/favicon.svg" type="image/svg+xml">

    <script>var postLoadMethods = [];</script>
</head>
<body class="cs-tutorial-body">




















<textarea id="copy-to-clipboard-dummy"></textarea>
<div class="cs-page-header">
    <div class="row">
        <div class="col-md-5 cs-page-header-left">
            <a href="/kitchen-duty-plugin-for-atlassian-jira/" class="cs-page-logo">
                <span class="cs-page-logo-img d-none d-lg-inline"></span>
                <h1>Kitchen Duty Plugin</h1>
                <h2>Tutorial for Atlassian JIRA® Server</h2>
            </a>
            <a class="btn btn-primary cs-burger-button" id="toggleSidebarButton">
                <span class="cs-news-right" style="color:#fff;"><i class="fa fa-bars fa-lg" aria-hidden="true"></i></span>
            </a>
        </div>
        <div class="col-md-3 text-center d-none d-sm-block" style="padding-top:10px;">

            <!--
            <a class="btn btn-primary btn-borderless" href="/kitchen-duty-plugin-for-atlassian-jira/news/" target="_blank">
                <span class="cs-news-right">news</span>
            </a>
            -->
        </div>
        <div class="col-md-4  d-none d-sm-block cs-page-header-cs-logo text-right cs-page-header--right-fix">
            <a href="https://comsystoreply.de" target="_blank"><img src="/kitchen-duty-plugin-for-atlassian-jira/images/comsysto-logo.png" alt="Comsysto Reply" style="width:150px; margin-top:-20px;"/></a>
        </div>
    </div>
</div>

<!-- CONTENT -->


<div class="cs-content">
    <div class="cs-sidebar-wrapper">
        
<div id="toc">
    <ul>

        

        <li class="toc-h2 ">
            <a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/01-introduction/">
                <span>&nbsp;</span>
                Introduction
            </a>
        </li>
        <li class="toc-h2 ">
            <a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/02-step-00-getting-started/">
                <span class="cs-step-badge">0</span>
                Getting Started
            </a>
        </li>

        

        <li class="toc-h2-divider">Part I: Kitchen Duty Planning Page</li>

        <li class="toc-h2 ">
            <a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/03-story-workshop-for-planning-page/">
                <span>&nbsp;</span>
                Story Workshop for Planning Page
            </a>
        </li>
        <li class="toc-h2 ">
            <a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/04-step-01-planning-page--webwork-action-and-html-view/">
                <span class="cs-step-badge">1</span>
                Webwork Action and HTML View
            </a>
        </li>
        <li class="toc-h2 ">
            <a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/05-step-02-planning-page--user-search-rest-resource/">
                <span class="cs-step-badge">2</span>
                User Search REST Resource
            </a>
        </li>
        <li class="toc-h2 ">
            <a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/06-step-03-planning-page--user-search-js-controller/">
                <span class="cs-step-badge">3</span>
                User Search JS Controller
            </a>
        </li>
        <li class="toc-h2 ">
            <a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/07-step-04-planning-page--kitchen-duty-planning-rest-resource/">
                <span class="cs-step-badge">4</span>
                Kitchen Duty Planning REST Resource
            </a>
        </li>
        <li class="toc-h2 toc-active">
            <a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/08-step-05-planning-page--kitchen-duty-planning-js-controller/">
                <span class="cs-step-badge">5</span>
                Kitchen Duty Planning JS Controller
            </a>
        </li>


<!-- DISABLE SVG STATUS FOR NOW
        
        <li>
            
            
            
            
            
            
            
            
            <p>&nbsp;</p>
            <div class="cs-toc-infographic-wrapper">
                
<svg class="cs-interactive-graphic"
     id="navSvg11"
     data-json-settings="{
            &quot;markedAsDone&quot;: [ &quot;webwork-action&quot;, &quot;html-view&quot;, &quot;user-resource&quot;, &quot;user-search-resource-model&quot;, &quot;user-js-controller&quot;, &quot;kitchen-duty-resource&quot;, &quot;kitchen-duty-planning-model&quot;  ],
            &quot;markedAsTodo&quot;: [ &quot;kitchen-duty-js-controller&quot; ],
            &quot;markedAsGrayedOut&quot;: [ ],
            &quot;onClick&quot;: [ ]
            }"
     data-svg-to-load="kitchen-duty-planning-page--component-overview"
     viewBox="0 0 1043 654"
     preserveAspectRatio="xMaxYMax">
</svg>

            </div>
        </li>
        
-->

        

        <li class="toc-h2-divider">Part II: Kitchen Duty Overview Page</li>
        <li class="toc-h2 ">
            <a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/09-story-workshop-for-overview-page/">
                <span>&nbsp;</span>
                Story Workshop for Overview Page
            </a>
        </li>
        <li class="toc-h2 ">
            <a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/10-step-06-overview-page--implementation/">
                <span class="cs-step-badge">6</span>
                Kitchen Duty Overview Page
            </a>
        </li>


        


        <li class="toc-h2-divider">Misc</li>

        <li class="toc-h2 ">
            <a href="/kitchen-duty-plugin-for-atlassian-jira/news/">
                <span>&nbsp;</span>
                News
            </a>
        </li>

    </ul>







</div>


    </div>
    <div class="cs-content-wrapper">
        <div class="cs-content-wrapper-inner">
        



<div class="row">
    <div class="col-md-12">
        




<h2 class="cs-headline cs-headline--m cs-headline--anchor"
    data-scroll-to-headline="kitchen-duty-planning-js-controller"
    data-scroll-to-headline-previous="">
    
    Kitchen Duty Planning JS Controller
</h2>


        <!-- COMMIT BEFORE STEP 5: 9bffb0671a25637faa7641dc3393163a043614db -->

        <p>Some time has passed since I worked on this Plugin tutorial - <strong>it is mid 2018 now</strong> - and we need to catch up to some things.</p>

        <h3 class="cs-headline cs-headline--s">What has changed since 2017?</h3>


        <p><strong>1. State and future of AUI library:</strong></p>
        <ul>
            <li><strong><a href="https://atlaskit.atlassian.com/">AtlasKit library</a></strong> is based on ReactJS and is used for <strong><a href="https://developer.atlassian.com/cloud/jira/platform/integrating-with-jira-cloud/">Cloud Plugin Development</a></strong>.</li>
            <li><strong><a href="https://docs.atlassian.com/aui/">AUI library</a></strong> is based on JQuery and is used for <strong>Server Plugin Development.</strong></li>
            <li><a href="https://community.developer.atlassian.com/t/the-license-for-aui-7-is-changing">AUI Library has now a more "closed-source" License</a>, meaning you cannot use AUI version greater 7 for non-Atlassian products. If you have a website or standalone product using AUI for your UI you should check the license terms.</a>
            <li>
                That means we will continue using AUI for our plugin. And even though we could hit it with NPM, React, Angular, Webpack and all
                that fancy shenanigans, we will write oldschool ES5 JavaScript code that directly executes in all browsers including ol' grandpa IE11.
                I leave the crazy JavaScript build chain stuff up to you. The mechanisms explained in the tutorial are the same for both ways.
            </li>
        </ul>

        <p><strong>2. AUI Redesign + JIRA version upgrade</strong></p>

        <ul>
            <li>We now compile against JIRA 7.10 and use Atlassian SDK version 6.3.10 therefore upgrade your Atlassian SDK. Also are we now compiling against Java 8. Update your <code>pom.xml</code> accordingly.</li>
            <li>
                JIRA Software underwent a redesign now looks like this. But all components of AUI just work the same way.<br>

            </li>
        </ul>
        <div class="row  ml-2">
            <div class="col-md-6">
                
    
    
        
    
    <div class="row">
        <div class="col-md-12">
            <p>
                <a href="/kitchen-duty-plugin-for-atlassian-jira/images/doc/step-05-jira-now.png">
                    <img src="/kitchen-duty-plugin-for-atlassian-jira/images/doc/step-05-jira-now.png" class="img-fluid" alt="Step 5 - JIRA Redesign"
                         data-bilderrahmen="gallery-01"
                         data-bilderrahmen-title="Step 5 - JIRA Redesign"
                    >
                </a>
            </p>
        </div>
    </div>

            </div>
            <div class="col-md-6">
                

<div class="cs-code-filename">
    <div class="cs-code-filename-inner">
        
        pom.xml
        
    </div>
    <div class="cs-code-buttons">
        
        <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/502903955096146b308efbf5018c5457905f00bb/step-05-kitchen-duty-plugin/pom.xml" target="_blank"
        data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
        class="cs-code-ghlink"><i class="fa fa-github"></i></a>
        
        <a class="cs-code-copylink cs--trigger-copy-clipboard"
        data-toggle="tooltip" data-placement="left"
        data-title-orig="Copy file content to clipboard"
        title="Copy file content to clipboard"
        data-clipboard-text="&lt;project&gt;
    ...
    &lt;build&gt;
        &lt;plugins&gt;
            ...
            &lt;plugin&gt;
                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
                &lt;version&gt;3.3&lt;/version&gt;
                &lt;configuration&gt;
                    &lt;source&gt;1.8&lt;/source&gt;
                    &lt;target&gt;1.8&lt;/target&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
    &lt;properties&gt;
        &lt;jira.version&gt;7.10.0&lt;/jira.version&gt;
        &lt;amps.version&gt;6.3.15&lt;/amps.version&gt;
        ...
    &lt;/properties&gt;
&lt;/project&gt;"><i class="fa fa-files-o"></i></a>
    </div>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-tag">&lt;<span class="hljs-title">project</span>&gt;</span>
    ...
    <span class="hljs-tag">&lt;<span class="hljs-title">build</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">plugins</span>&gt;</span>
            ...
            <span class="hljs-tag">&lt;<span class="hljs-title">plugin</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-title">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">version</span>&gt;</span>3.3<span class="hljs-tag">&lt;/<span class="hljs-title">version</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">configuration</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">source</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-title">source</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">target</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-title">target</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-title">configuration</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-title">plugin</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">plugins</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">build</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">properties</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">jira.version</span>&gt;</span>7.10.0<span class="hljs-tag">&lt;/<span class="hljs-title">jira.version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">amps.version</span>&gt;</span>6.3.15<span class="hljs-tag">&lt;/<span class="hljs-title">amps.version</span>&gt;</span>
        ...
    <span class="hljs-tag">&lt;/<span class="hljs-title">properties</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">project</span>&gt;</span></code></pre>

            </div>
        </div>


        <h3 class="cs-headline cs-headline--s">What we want to achieve</h3>

        <p>
            Basically we want to first have the user select the week. Then we want to show a multi-select textfield containing
            existing users for that week and beeing able to add or remove users for that week.
            That means <strong>the template of the user selection loads conditionally by the week number</strong>.
        </p>
        <div class="row">
            <div class="col-md-6">
                
    
    
        
    
    <div class="row">
        <div class="col-md-12">
            <p>
                <a href="/kitchen-duty-plugin-for-atlassian-jira/images/doc/step-05-planning-page-working.gif">
                    <img src="/kitchen-duty-plugin-for-atlassian-jira/images/doc/step-05-planning-page-working.gif" class="img-fluid" alt="Step 5 - Planning Page working"
                         data-bilderrahmen="gallery-01"
                         data-bilderrahmen-title="Step 5 - Planning Page working"
                    >
                </a>
            </p>
        </div>
    </div>

            </div>
            <div class="col-md-6">
                
    
    
        
    
    <div class="row">
        <div class="col-md-12">
            <p>
                <a href="/kitchen-duty-plugin-for-atlassian-jira/images/doc/step-05-templates.png">
                    <img src="/kitchen-duty-plugin-for-atlassian-jira/images/doc/step-05-templates.png" class="img-fluid" alt="Step 5 - Planning Page Soy Templates"
                         data-bilderrahmen="gallery-01"
                         data-bilderrahmen-title="Step 5 - Planning Page Soy Templates"
                    >
                </a>
            </p>
        </div>
    </div>

            </div>
        </div>


        <p>There are now multiple soy templates as shown in the graphic above which we will later use from our JavaScript code to render the planning page.</p>

        <div class="row">
            <div class="col-md-7">
                

<div class="cs-code-filename">
    <div class="cs-code-filename-inner">
        
        <span class="d-none d-lg-inline d-xl-inline">src/main/resources/templates-soy/</span><span class="d-none d-sm-inline d-lg-none d-xl-none"
                                                                data-toggle="tooltip"
                                                                data-placement="right"
                                                                title="src/main/resources/templates-soy/">.../</span>kitchen-duty-planning.soy
        
    </div>
    <div class="cs-code-buttons">
        
        <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/502903955096146b308efbf5018c5457905f00bb/step-05-kitchen-duty-plugin/src/main/resources/templates-soy/kitchen-duty-planning.soy" target="_blank"
        data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
        class="cs-code-ghlink"><i class="fa fa-github"></i></a>
        
        <a class="cs-code-copylink cs--trigger-copy-clipboard"
        data-toggle="tooltip" data-placement="left"
        data-title-orig="Copy file content to clipboard"
        title="Copy file content to clipboard"
        data-clipboard-text="{namespace JIRA.Templates.KDP}

{template .planningPage} 
    &lt;form class=&quot;aui&quot; id=&quot;kdp-user-select-form&quot;&gt;
        &lt;div id=&quot;kdp-planning-page-week-container&quot;&gt;&lt;/div&gt;
        &lt;div id=&quot;kdp-planning-page-week-users-container&quot;&gt;&lt;/div&gt;
    &lt;/form&gt;
{/template}

{template .planningPageWeek} 
    &lt;h4 class=&quot;kdp-step-headline&quot;&gt;1. Select Week&lt;/h4&gt;
    &lt;div class=&quot;kdp-step-content&quot;&gt;
        &lt;input
          class=&quot;aui-date-picker aui-button&quot;
          id=&quot;week-picker&quot;
          type=&quot;date&quot;
          max=&quot;2050-01-25&quot;
          min=&quot;2011-12-25&quot;
        /&gt;
    &lt;/div&gt;
{/template}

{template .planningPageWeekUsers} 
    {@param? week: int} 
    &lt;h4 class=&quot;kdp-step-headline&quot;&gt;
        2. Kitchen Duty for Week&amp;nbsp;
        {if $week != null } 
            &lt;aui-badge class=&quot;aui-badge-primary&quot;&gt;
                &lt;span id=&quot;week-label&quot;&gt;{week}&lt;/span&gt;
            &lt;/aui-badge&gt;
        {else}
            &lt;aui-badge&gt;
                &lt;span id=&quot;week-label&quot;&gt;...&lt;/span&gt;
            &lt;/aui-badge&gt;
        {/if}
    &lt;/h4&gt;
    &lt;div class=&quot;kdp-step-content&quot;&gt;
        {if $week == null } 
            &lt;div&gt;- no week selected -&lt;/div&gt;
        {else}
            &lt;div&gt;Users on kitchen duty for selected week:&lt;/div&gt;
            &lt;div
              id=&quot;kdp-user-select&quot;
              name=&quot;kdp-user-select&quot;
              class=&quot;kdp-aui-select&quot;
              multiple=&quot;&quot;
              placeholder=&quot;start typing a username ...&quot;
            &gt;&lt;/div&gt;
            &lt;br/&gt;&lt;br/&gt;
            &lt;input
              class=&quot;button submit&quot;
              type=&quot;submit&quot;
              id=&quot;kdp-user-select-save-button&quot;
              value=&quot;save&quot;
            /&gt;
        {/if}
    &lt;/div&gt;
{/template}"><i class="fa fa-files-o"></i></a>
    </div>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-soyTag">{<span class="hljs-title"><span class="hljs-tag">namespace</span> JIRA.Templates.KDP</span>}</span>

<span class="hljs-soyTag">{<span class="hljs-title"><span class="hljs-tag">template</span> .planningPage</span>}</span> <span class="hljs-soyTag"><span class="cs-source-point" data-cs-source-point-id="dfghs5zdfsfsdfdf" data-cs-source-point-number="1"></span>
    &lt;form class=<span class="hljs-string">"aui"</span> id=<span class="hljs-string">"kdp-user-select-form"</span>&gt;
        &lt;div id=<span class="hljs-string">"kdp-planning-page-week-container"</span>&gt;&lt;/div&gt;
        &lt;div id=<span class="hljs-string">"kdp-planning-page-week-users-container"</span>&gt;&lt;/div&gt;
    &lt;/form&gt;
<span class="hljs-soyTag">{/<span class="hljs-tag">template</span>}</span>

<span class="hljs-soyTag">{<span class="hljs-title"><span class="hljs-tag">template</span> .planningPageWeek</span>}</span> <span class="hljs-soyTag"><span class="cs-source-point" data-cs-source-point-id="dfghs5zdfsfsdfdf" data-cs-source-point-number="2"></span>
    &lt;h4 class=<span class="hljs-string">"kdp-step-headline"</span>&gt;1. Select Week&lt;/h4&gt;
    &lt;div class=<span class="hljs-string">"kdp-step-content"</span>&gt;
        &lt;input
          class=<span class="hljs-string">"aui-date-picker aui-button"</span>
          id=<span class="hljs-string">"week-picker"</span>
          type=<span class="hljs-string">"date"</span>
          max=<span class="hljs-string">"2050-01-25"</span>
          min=<span class="hljs-string">"2011-12-25"</span>
        /&gt;
    &lt;/div&gt;
<span class="hljs-soyTag">{/<span class="hljs-tag">template</span>}</span>

<span class="hljs-soyTag">{<span class="hljs-title"><span class="hljs-tag">template</span> .planningPageWeekUsers</span>}</span> <span class="hljs-soyTag"><span class="cs-source-point" data-cs-source-point-id="dfghs5zdfsfsdfdf" data-cs-source-point-number="3"></span>
    <span class="hljs-soyTag">{@<span class="hljs-tag">param</span>? week: int}</span> <span class="hljs-soyTag"><span class="cs-source-point" data-cs-source-point-id="dfghs5zdfsfsdfdf" data-cs-source-point-number="4"></span>
    &lt;h4 class=<span class="hljs-string">"kdp-step-headline"</span>&gt;
        2. Kitchen Duty for Week&amp;nbsp;
        <span class="hljs-soyTag">{<span class="hljs-keyword">if</span> <span class="hljs-symbol">$week</span> != null }</span> <span class="hljs-soyTag"><span class="cs-source-point" data-cs-source-point-id="dfghs5zdfsfsdfdf" data-cs-source-point-number="5"></span>
            &lt;aui-badge class=<span class="hljs-string">"aui-badge-primary"</span>&gt;
                &lt;span id=<span class="hljs-string">"week-label"</span>&gt;<span class="hljs-soyTag">{week}</span>&lt;/span&gt;
            &lt;/aui-badge&gt;
        <span class="hljs-soyTag">{<span class="hljs-keyword">else</span>}</span>
            &lt;aui-badge&gt;
                &lt;span id=<span class="hljs-string">"week-label"</span>&gt;...&lt;/span&gt;
            &lt;/aui-badge&gt;
        <span class="hljs-soyTag">{/<span class="hljs-keyword">if</span>}</span>
    &lt;/h4&gt;
    &lt;div class=<span class="hljs-string">"kdp-step-content"</span>&gt;
        <span class="hljs-soyTag">{<span class="hljs-keyword">if</span> <span class="hljs-symbol">$week</span> == null }</span> <span class="hljs-soyTag"><span class="cs-source-point" data-cs-source-point-id="dfghs5zdfsfsdfdf" data-cs-source-point-number="6"></span>
            &lt;div&gt;- no week selected -&lt;/div&gt;
        <span class="hljs-soyTag">{<span class="hljs-keyword">else</span>}</span>
            &lt;div&gt;Users on kitchen duty for selected week:&lt;/div&gt;
            &lt;div
              id=<span class="hljs-string">"kdp-user-select"</span>
              name=<span class="hljs-string">"kdp-user-select"</span>
              class=<span class="hljs-string">"kdp-aui-select"</span>
              multiple=<span class="hljs-string">""</span>
              placeholder=<span class="hljs-string">"start typing a username ..."</span>
            &gt;&lt;/div&gt;
            &lt;br/&gt;&lt;br/&gt;
            &lt;input
              class=<span class="hljs-string">"button submit"</span>
              type=<span class="hljs-string">"submit"</span>
              id=<span class="hljs-string">"kdp-user-select-save-button"</span>
              value=<span class="hljs-string">"save"</span>
            /&gt;
        <span class="hljs-soyTag">{/<span class="hljs-keyword">if</span>}</span>
    &lt;/div&gt;
<span class="hljs-soyTag">{/<span class="hljs-tag">template</span>}</span></code></pre>

            </div>
            <div class="col-md-5 cs-sticky-in-parent">
                <div class="list-group cs-source-point-list" data-source-target="dfghs5zdfsfsdfdf">
                    <div class="list-group-item cs-source-point-list__item">
                       <strong>planningPage</strong> is the base template we inject into the page that has two divs with ids we later use to inject
                       the other two rendered templates.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        <strong>planningPageWeek</strong> is the template for the week selection. This template is only rendered once on page load.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        <strong>planningPageWeekUsers</strong> is the template for the user to week selection.
                        This template is re-rendered multiple times since it is a <strong>parameterized soy template</strong>.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        <strong>week parameter</strong> is used to pass the week number to the template.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        conditionally render the template for week being null (=no week selected) or week greater zero (=week selected).
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        when the week is null display a message, otherwise render the AUI Select 2 field for the user selection.
                    </div>
                </div>
            </div>
        </div>

        <p>We will later use the templates from our JavaScript code but for now we need again do something in Java.</p>


        <h3 class="cs-headline cs-headline--s">REST API Endpoint</h3>

        <p>In step four we implemented logic to persist only one user for a week. We need to change that to multiple users per week because of the way the <a href="https://docs.atlassian.com/aui/7.8.1/docs/auiselect2.html">AUI Select 2</a> works.</p>

        <p>
            Therefore I have changed the endpoints to do so. Basically I added just some for-each loops and some missing <code>activeObjects.flush(entity)</code> statements that update the ID of the object after creating a new entity.
            With the AUI Select 2 user field you can remove and add users. The HTTP PUT Request always contains a full list of users therefore we do not need the explicit delete-endpoint anymore.
            We simply update the relationships in our <code>@PUT</code> endpoint.
        </p>


        <div class="row">
            <div class="col-md-8">
            

<div class="cs-code-filename">
    <div class="cs-code-filename-inner">
        
        <span class="d-none d-lg-inline d-xl-inline">src/main/java/com/comsysto/kitchen/duty/rest/</span><span class="d-none d-sm-inline d-lg-none d-xl-none"
                                                                data-toggle="tooltip"
                                                                data-placement="right"
                                                                title="src/main/java/com/comsysto/kitchen/duty/rest/">.../</span>KitchenDutyPlanningResource.java
        
    </div>
    <div class="cs-code-buttons">
        
        <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/502903955096146b308efbf5018c5457905f00bb/step-05-kitchen-duty-plugin/src/main/java/com/comsysto/kitchen/duty/rest/KitchenDutyPlanningResource.java" target="_blank"
        data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
        class="cs-code-ghlink"><i class="fa fa-github"></i></a>
        
        <a class="cs-code-copylink cs--trigger-copy-clipboard"
        data-toggle="tooltip" data-placement="left"
        data-title-orig="Copy file content to clipboard"
        title="Copy file content to clipboard"
        data-clipboard-text="package com.comsysto.kitchen.duty.rest;
...

@Named
@Path(&quot;/planning&quot;)
public class KitchenDutyPlanningResource {
...


    @GET
    @Path(&quot;/week/{weekNumber}/users&quot;)
    @Produces({MediaType.APPLICATION_JSON})
    @AnonymousAllowed
    public Response getUsersForWeek(@PathParam(&quot;weekNumber&quot;) final Integer weekNumber) {
        Week week = activeObjects.executeInTransaction(new TransactionCallback&lt;Week&gt;() {
            @Override
            public Week doInTransaction() {
                Week[] weeks = activeObjects.find(Week.class, Query.select().where(&quot;WEEK = ?&quot;, weekNumber));
                if (weeks != null &amp;&amp; weeks.length &gt; 0) {
                    return weeks[0];
                }
                return null;
            }
        });
        List&lt;KitchenDutyPlanningResourceUserModel&gt; users = new ArrayList&lt;&gt;();
        if (week != null) {
            UserToWeek[] relationships = activeObjects.executeInTransaction(new TransactionCallback&lt;UserToWeek[]&gt;() {
                @Override
                public UserToWeek[] doInTransaction() {
                    return KitchenDutyActiveObjectHelper.findAllRelationships(activeObjects, week); 
                }
            });
            if (relationships != null) {
                for (UserToWeek userToWeek : relationships) {
                     users.add(new KitchenDutyPlanningResourceUserModel(userToWeek.getUser().getID(), userToWeek.getUser().getName()));
                }
            }
        }
        return Response.ok(users).build();
    }

    /*
     * Add the Users to the Week
     */
    @PUT
    @Path(&quot;/week/{weekNumber}/users&quot;)
    @Produces({MediaType.APPLICATION_JSON})
    @AnonymousAllowed
    public Response addUserToWeek(@PathParam(&quot;weekNumber&quot;) final Integer weekNumber,
                                  final List&lt;KitchenDutyPlanningResourceUserModel&gt; userParams) {
        activeObjects.executeInTransaction(new TransactionCallback&lt;Void&gt;() {
            @Override
            public Void doInTransaction() {
                //
                // WEEK 
                //
               Week week = KitchenDutyActiveObjectHelper.findUniqueWeek(activeObjects, weekNumber);
                if (week == null) {
                    week = activeObjects.create(Week.class, new DBParam(&quot;WEEK&quot;, weekNumber));
                    week.save();
                    activeObjects.flush(week);
                }

                //
                // CLEANUP EXISTING RELATIONSHIPS 
                //
                UserToWeek[] existingRelationships = KitchenDutyActiveObjectHelper.findAllRelationships(activeObjects, week);
                if (existingRelationships != null) {
                    for (UserToWeek existingRelationship : existingRelationships) {
                        activeObjects.delete(existingRelationship);
                        activeObjects.flush(existingRelationship);
                    }
                }

                //
                // USER
                //
                for (KitchenDutyPlanningResourceUserModel userParam : userParams) {
                    User user = KitchenDutyActiveObjectHelper.findUniqueUser(activeObjects, userParam.getUsername());
                    if (user == null) {
                        user = activeObjects.create(User.class, new DBParam(&quot;NAME&quot;, userParam.getUsername()));
                        user.save();
                        activeObjects.flush(user);
                    }
                    //
                    // Establish ManyToMany Relationship 
                    //
                    UserToWeek relationship = KitchenDutyActiveObjectHelper.findRelationship(activeObjects, user, week);
                    if (relationship == null) {
                        relationship = activeObjects.create(UserToWeek.class);
                        relationship.setUser(user);
                        relationship.setWeek(week);
                        relationship.save();
                        activeObjects.flush(relationship);
                    }
                }

                return null;
            }
        });
        return Response.ok().build();
    }"><i class="fa fa-files-o"></i></a>
    </div>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-keyword">package</span> com.comsysto.kitchen.duty.rest;
...

<span class="hljs-annotation">@Named</span>
<span class="hljs-annotation">@Path</span>(<span class="hljs-string">"/planning"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KitchenDutyPlanningResource</span> </span>{
...


    <span class="hljs-annotation">@GET</span>
    <span class="hljs-annotation">@Path</span>(<span class="hljs-string">"/week/{weekNumber}/users"</span>)
    <span class="hljs-annotation">@Produces</span>({MediaType.APPLICATION_JSON})
    <span class="hljs-annotation">@AnonymousAllowed</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Response <span class="hljs-title">getUsersForWeek</span><span class="hljs-params">(@PathParam(<span class="hljs-string">"weekNumber"</span>)</span> <span class="hljs-keyword">final</span> Integer weekNumber) </span>{
        Week week = activeObjects.executeInTransaction(<span class="hljs-keyword">new</span> TransactionCallback&lt;Week&gt;() {
            <span class="hljs-annotation">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> Week <span class="hljs-title">doInTransaction</span><span class="hljs-params">()</span> </span>{
                Week[] weeks = activeObjects.find(Week.class, Query.select().where(<span class="hljs-string">"WEEK = ?"</span>, weekNumber));
                <span class="hljs-keyword">if</span> (weeks != <span class="hljs-keyword">null</span> &amp;&amp; weeks.length &gt; <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">return</span> weeks[<span class="hljs-number">0</span>];
                }
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
            }
        });
        List&lt;KitchenDutyPlanningResourceUserModel&gt; users = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
        <span class="hljs-keyword">if</span> (week != <span class="hljs-keyword">null</span>) {
            UserToWeek[] relationships = activeObjects.executeInTransaction(<span class="hljs-keyword">new</span> TransactionCallback&lt;UserToWeek[]&gt;() {
                <span class="hljs-annotation">@Override</span>
                <span class="hljs-keyword">public</span> UserToWeek[] doInTransaction() {
                    <span class="hljs-keyword">return</span> KitchenDutyActiveObjectHelper.findAllRelationships(activeObjects, week); <span class="cs-source-point" data-cs-source-point-id="x3eewr8dasdsfsf67987ij" data-cs-source-point-number="1"></span>
                }
            });
            <span class="hljs-keyword">if</span> (relationships != <span class="hljs-keyword">null</span>) {
                <span class="hljs-keyword">for</span> (UserToWeek userToWeek : relationships) {
                    <span class="cs-source-point" data-cs-source-point-id="x3eewr8dasdsfsf67987ij" data-cs-source-point-number="2"></span> users.add(<span class="hljs-keyword">new</span> KitchenDutyPlanningResourceUserModel(userToWeek.getUser().getID(), userToWeek.getUser().getName()));
                }
            }
        }
        <span class="hljs-keyword">return</span> Response.ok(users).build();
    }

    <span class="hljs-comment">/*
     * Add the Users to the Week
     */</span>
    <span class="hljs-annotation">@PUT</span>
    <span class="hljs-annotation">@Path</span>(<span class="hljs-string">"/week/{weekNumber}/users"</span>)
    <span class="hljs-annotation">@Produces</span>({MediaType.APPLICATION_JSON})
    <span class="hljs-annotation">@AnonymousAllowed</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Response <span class="hljs-title">addUserToWeek</span><span class="hljs-params">(@PathParam(<span class="hljs-string">"weekNumber"</span>)</span> <span class="hljs-keyword">final</span> Integer weekNumber,
                                  <span class="hljs-keyword">final</span> List&lt;KitchenDutyPlanningResourceUserModel&gt; userParams) </span>{
        activeObjects.executeInTransaction(<span class="hljs-keyword">new</span> TransactionCallback&lt;Void&gt;() {
            <span class="hljs-annotation">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> Void <span class="hljs-title">doInTransaction</span><span class="hljs-params">()</span> </span>{
                <span class="hljs-comment">//</span>
                <span class="hljs-comment">// WEEK <span class="cs-source-point" data-cs-source-point-id="x3eewr8dasdsfsf67987ij" data-cs-source-point-number="3"></span></span>
                <span class="hljs-comment">//</span>
               Week week = KitchenDutyActiveObjectHelper.findUniqueWeek(activeObjects, weekNumber);
                <span class="hljs-keyword">if</span> (week == <span class="hljs-keyword">null</span>) {
                    week = activeObjects.create(Week.class, <span class="hljs-keyword">new</span> DBParam(<span class="hljs-string">"WEEK"</span>, weekNumber));
                    week.save();
                    activeObjects.flush(week);
                }

                <span class="hljs-comment">//</span>
                <span class="hljs-comment">// CLEANUP EXISTING RELATIONSHIPS <span class="cs-source-point" data-cs-source-point-id="x3eewr8dasdsfsf67987ij" data-cs-source-point-number="4"></span></span>
                <span class="hljs-comment">//</span>
                UserToWeek[] existingRelationships = KitchenDutyActiveObjectHelper.findAllRelationships(activeObjects, week);
                <span class="hljs-keyword">if</span> (existingRelationships != <span class="hljs-keyword">null</span>) {
                    <span class="hljs-keyword">for</span> (UserToWeek existingRelationship : existingRelationships) {
                        activeObjects.delete(existingRelationship);
                        activeObjects.flush(existingRelationship);
                    }
                }

                <span class="hljs-comment">//</span>
                <span class="hljs-comment">// USER</span>
                <span class="hljs-comment">//</span>
                <span class="hljs-keyword">for</span> (KitchenDutyPlanningResourceUserModel userParam : userParams) {
                    User user = KitchenDutyActiveObjectHelper.findUniqueUser(activeObjects, userParam.getUsername());
                    <span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span>) {
                        user = activeObjects.create(User.class, <span class="hljs-keyword">new</span> DBParam(<span class="hljs-string">"NAME"</span>, userParam.getUsername()));
                        user.save();
                        activeObjects.flush(user);
                    }
                    <span class="hljs-comment">//</span>
                    <span class="hljs-comment">// Establish ManyToMany Relationship <span class="cs-source-point" data-cs-source-point-id="x3eewr8dasdsfsf67987ij" data-cs-source-point-number="5"></span></span>
                    <span class="hljs-comment">//</span>
                    UserToWeek relationship = KitchenDutyActiveObjectHelper.findRelationship(activeObjects, user, week);
                    <span class="hljs-keyword">if</span> (relationship == <span class="hljs-keyword">null</span>) {
                        relationship = activeObjects.create(UserToWeek.class);
                        relationship.setUser(user);
                        relationship.setWeek(week);
                        relationship.save();
                        activeObjects.flush(relationship);
                    }
                }

                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
            }
        });
        <span class="hljs-keyword">return</span> Response.ok().build();
    }</code></pre>

            </div>
            <div class="col-md-4 cs-sticky-in-parent">
                <div class="list-group cs-source-point-list" data-source-target="x3eewr8dasdsfsf67987ij">
                    <div class="list-group-item cs-source-point-list__item">
                       We now query the UserToWeek objects by Week, to get all UserToWeek objects from which we get the all the users assigned to the week.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Now we wrap all users in a List of <code>KitchenDutyPlanningResourceUserModel</code> which procudes
                        the JSON <code>[ { "id": 1, "username": "linda" }, { "id": 2, "username": "bob" } ]</code>
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        First we get the Week object or create it if it does not exist.
                        The <code>activeObjects.flush(entity)</code> ensures that the ID gets updated for the week.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Next we remove all users from that week. Why? Let's say bob and steve have been assigned to that week before.
                        Someone edited the users for that week and now it is steve and linda. So how can we tell that we need to remove bob
                        when we do not even have the information about that? We cannot. Therefore we simply remove all users from that week to add
                        the desginated users to that week later.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Assign the designated users to the week. This way we do not need the DELETE endpoint anymore since we simply always first remove
                        all users for a week and then assign the new userlist to the week.
                    </div>
                </div>
            </div>
        </div>

        <p>Having done that we can move on again to our frontend code.<p>

        <h3 class="cs-headline cs-headline--s">Moment JS and AUI Preparations</h3>

        <p>
            Since we want to calcuclate the week number from our date selected in the date picker we need some libraries to do so. Date calculations
            in JavaScript are best done with <a href="http://momentjs.com/">MomentJS</a>.
            We need to add the dependency for the <a href="https://docs.atlassian.com/aui/7.9.5/docs/date-picker.html">AUI date picker</a> to our <code>atlassian-plugin.xml</code>
            and put a copy of <a href="http://momentjs.com/"><code>moment.min.js</code></a> inside <code>src/main/resources/js/3rdparty/</code>.
        </p>
        <p>
        

<div class="cs-code-filename">
    <div class="cs-code-filename-inner">
        
        <span class="d-none d-lg-inline d-xl-inline">src/main/resources/</span><span class="d-none d-sm-inline d-lg-none d-xl-none"
                                                                data-toggle="tooltip"
                                                                data-placement="right"
                                                                title="src/main/resources/">.../</span>atlassian-plugin.xml
        
    </div>
    <div class="cs-code-buttons">
        
        <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/502903955096146b308efbf5018c5457905f00bb/step-05-kitchen-duty-plugin/src/main/resources/atlassian-plugin.xml" target="_blank"
        data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
        class="cs-code-ghlink"><i class="fa fa-github"></i></a>
        
        <a class="cs-code-copylink cs--trigger-copy-clipboard"
        data-toggle="tooltip" data-placement="left"
        data-title-orig="Copy file content to clipboard"
        title="Copy file content to clipboard"
        data-clipboard-text="&lt;web-resource key=&quot;kitchen-duty-plugin-resources--planning-page&quot; name=&quot;kitchen-duty-plugin Web Resources for Planning Page&quot;&gt;
  &lt;dependency&gt;com.atlassian.auiplugin:ajs&lt;/dependency&gt;
  &lt;dependency&gt;com.atlassian.auiplugin:aui-select2&lt;/dependency&gt;
  &lt;dependency&gt;com.atlassian.auiplugin:aui-experimental-soy-templates&lt;/dependency&gt;
  &lt;dependency&gt;com.atlassian.auiplugin:aui-date-picker&lt;/dependency&gt; 
  &lt;transformation extension=&quot;soy&quot;&gt;
    &lt;transformer key=&quot;soyTransformer&quot;&gt;
      &lt;functions&gt;com.atlassian.confluence.plugins.soy:soy-core-functions&lt;/functions&gt;
    &lt;/transformer&gt;
  &lt;/transformation&gt;
  &lt;resource type=&quot;download&quot; name=&quot;momentjs.js&quot;
            location=&quot;/js/3rdparty/moment-2.22.2.min.js&quot;/&gt;
  &lt;resource type=&quot;download&quot; name=&quot;kitchen-duty-planning-soy.js&quot;
            location=&quot;templates-soy/kitchen-duty-planning.soy&quot;/&gt;
  &lt;resource type=&quot;download&quot; name=&quot;kitchen-duty-plugin--planning-page-controller.js&quot;
            location=&quot;/js/kitchen-duty-plugin--planning-page-controller.js&quot;/&gt; 
  &lt;context&gt;kitchen-duty-plugin&lt;/context&gt;
&lt;/web-resource&gt;"><i class="fa fa-files-o"></i></a>
    </div>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-tag">&lt;<span class="hljs-title">web-resource</span> <span class="hljs-attribute">key</span>=<span class="hljs-value">"kitchen-duty-plugin-resources--planning-page"</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"kitchen-duty-plugin Web Resources for Planning Page"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span>com.atlassian.auiplugin:ajs<span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span>com.atlassian.auiplugin:aui-select2<span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span>com.atlassian.auiplugin:aui-experimental-soy-templates<span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span>com.atlassian.auiplugin:aui-date-picker<span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span> <span class="cs-source-point" data-cs-source-point-id="u89hionbhvufghoijklnjbhg" data-cs-source-point-number="1"></span>
  <span class="hljs-tag">&lt;<span class="hljs-title">transformation</span> <span class="hljs-attribute">extension</span>=<span class="hljs-value">"soy"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">transformer</span> <span class="hljs-attribute">key</span>=<span class="hljs-value">"soyTransformer"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">functions</span>&gt;</span>com.atlassian.confluence.plugins.soy:soy-core-functions<span class="hljs-tag">&lt;/<span class="hljs-title">functions</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">transformer</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">transformation</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">resource</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"download"</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"momentjs.js"</span>
            <span class="hljs-attribute">location</span>=<span class="hljs-value">"/js/3rdparty/moment-2.22.2.min.js"</span>/&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">resource</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"download"</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"kitchen-duty-planning-soy.js"</span>
            <span class="hljs-attribute">location</span>=<span class="hljs-value">"templates-soy/kitchen-duty-planning.soy"</span>/&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">resource</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"download"</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"kitchen-duty-plugin--planning-page-controller.js"</span>
            <span class="hljs-attribute">location</span>=<span class="hljs-value">"/js/kitchen-duty-plugin--planning-page-controller.js"</span>/&gt;</span> <span class="cs-source-point" data-cs-source-point-id="u89hionbhvufghoijklnjbhg" data-cs-source-point-number="2"></span>
  <span class="hljs-tag">&lt;<span class="hljs-title">context</span>&gt;</span>kitchen-duty-plugin<span class="hljs-tag">&lt;/<span class="hljs-title">context</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">web-resource</span>&gt;</span></code></pre>

        </p>

        <h3 class="cs-headline cs-headline--s">JS Controller</h3>

        <p>
            We <strong>edit our existing Planning Page JS-Controller</strong> file in <code>/src/main/resources/js/kitchen-duty-plugin--planning-page-controller.js</code>.
            I have extended the existing code to load and save the users per week. This JS code now uses the soy templates defined above.
        </p>



        <div class="row">
            <div class="col-md-8">
        

<div class="cs-code-filename">
    <div class="cs-code-filename-inner">
        
        <span class="d-none d-lg-inline d-xl-inline">src/main/resources/js/</span><span class="d-none d-sm-inline d-lg-none d-xl-none"
                                                                data-toggle="tooltip"
                                                                data-placement="right"
                                                                title="src/main/resources/js/">.../</span>kitchen-duty-plugin--planning-page-controller.js
        
    </div>
    <div class="cs-code-buttons">
        
        <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/502903955096146b308efbf5018c5457905f00bb/step-05-kitchen-duty-plugin/src/main/resources/js/kitchen-duty-plugin--planning-page-controller.js" target="_blank"
        data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
        class="cs-code-ghlink"><i class="fa fa-github"></i></a>
        
        <a class="cs-code-copylink cs--trigger-copy-clipboard"
        data-toggle="tooltip" data-placement="left"
        data-title-orig="Copy file content to clipboard"
        title="Copy file content to clipboard"
        data-clipboard-text="var showSuccessFlag = function(message) {
    require([&#39;aui/flag&#39;], function(flag) {
        flag({
            type: &#39;success&#39;,
            title: &#39;Kitchen Duty Plugin&#39;,
            close: &#39;auto&#39;,
            body: message
        });
    });
};
var showErrorFlag = function(message) {
    require([&#39;aui/flag&#39;], function(flag) {
        flag({
            type: &#39;error&#39;,
            title: &#39;Kitchen Duty Plugin&#39;,
            close: &#39;auto&#39;,
            body: message
        });
    });
};

var initUserSearch = function(weekNumber) { 
    // Init SOY template
    var planningPageWeekUsersTemplate = JIRA.Templates.KDP.planningPageWeekUsers({
        week: weekNumber 
    });
    AJS.$(&#39;#kdp-planning-page-week-users-container&#39;).html(planningPageWeekUsersTemplate); 

    // Init actions
    var auiUserSelectOptions = {
        ajax: {
            url: function () { return window.KDPrestUrl + &#39;/user/search&#39;; },
            dataType: &#39;json&#39;,
            delay: 250,
            data: function (searchTerm) { return { query: searchTerm }; },
            results: function (data) { return { results: data }; },
            cache: true
        },
        minimumInputLength: 1,
        tags: &#39;true&#39;
    };
    AJS.$(&#39;#kdp-user-select&#39;).auiSelect2(auiUserSelectOptions);

    // Load initial values from REST API and set for aui-select
    if (weekNumber !== null) { 
        AJS.$.ajax({
            url: window.KDPrestUrl + &#39;/planning/week/&#39; + weekNumber + &#39;/users&#39;,
            dataType: &#39;json&#39;,
            success: function(users) {
                var selectedUserList = [];
                if (users !== null) { 
                    users.forEach(function(user) {
                        selectedUserList.push({ id: user.username, text: user.username });
                    });
                    AJS.$(&#39;#kdp-user-select&#39;).select2(&#39;data&#39;, selectedUserList);
                }
            }
        });
    }

    // Save users on save button click
    AJS.$(&#39;#kdp-user-select-form&#39;).off(); // remove previous listeners
    AJS.$(&#39;#kdp-user-select-form&#39;).submit(function (e) {
        e.preventDefault();
        var selectedUserList = [];
        AJS.$(AJS.$(&#39;#kdp-user-select&#39;).select2(&#39;data&#39;)).each(function () {
            // we need to transform the JSON sent to the Endpoint since it
            // has to be in specific format
            selectedUserList.push({ username: this.text });
        });
        AJS.$.ajax({ 
            url: window.KDPrestUrl + &#39;/planning/week/&#39; + weekNumber + &#39;/users&#39;,
            type: &#39;PUT&#39;,
            contentType: &#39;application/json&#39;,
            data: JSON.stringify(selectedUserList),
            processData: false,
            success: function() {
                showSuccessFlag(&#39;Saved users for Week &#39; + weekNumber);
            },
            error: function() {
                showErrorFlag(&#39;Failed to save users for Week &#39; + weekNumber);
            }
        });
    });
};

var initWeekPicker = function() { 
    // Init SOY template
    var planningPageWeekTemplate = JIRA.Templates.KDP.planningPageWeek();
    AJS.$(&#39;#kdp-planning-page-week-container&#39;).html(planningPageWeekTemplate);

    // Init actions
    AJS.$(&#39;#week-picker&#39;).off(); // remove previous listeners
    AJS.$(&#39;#week-picker&#39;).datePicker({&#39;overrideBrowserDefault&#39;: true});
    AJS.$(&#39;#week-picker&#39;).change(function() {
        var week = moment(AJS.$(&#39;#week-picker&#39;).val()).week(); 
        initUserSearch(week);
    });
};

AJS.toInit(function(){
    AJS.log(&#39;KDP: Planning Page Controller initializing ...&#39;);
    var baseUrl = AJS.params.baseURL;
    var restUrl = baseUrl + &#39;/rest/kitchenduty/1.0&#39;;
    window.KDPrestUrl = restUrl;

    // set locale for moment-js so that week starts on sunday
    // and week numbers are correctly calculated
    moment.locale(&#39;en&#39;, {
        week: {
            dow: 0, // Sunday (0) is the first day of the week
            doy: 1  // Week that contains Jan 1st is the first week of the year.
        }
    });
    console.log(&#39;Week starts at: &#39; + moment().startOf(&#39;week&#39;).format(&#39;dddd&#39;));
    console.log(&#39;Current moment locale: &#39; + moment().locale());

    // Init Base SOY template 
    var planningPageTemplate = JIRA.Templates.KDP.planningPage();
    AJS.$(&#39;#kdp-planning-page-container&#39;).html(planningPageTemplate);

    // Init child templates 
    initWeekPicker();
    initUserSearch(null);
});"><i class="fa fa-files-o"></i></a>
    </div>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-keyword">var</span> showSuccessFlag = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-built_in">require</span>([<span class="hljs-string">'aui/flag'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">flag</span>) </span>{
        flag({
            type: <span class="hljs-string">'success'</span>,
            title: <span class="hljs-string">'Kitchen Duty Plugin'</span>,
            close: <span class="hljs-string">'auto'</span>,
            body: message
        });
    });
};
<span class="hljs-keyword">var</span> showErrorFlag = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-built_in">require</span>([<span class="hljs-string">'aui/flag'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">flag</span>) </span>{
        flag({
            type: <span class="hljs-string">'error'</span>,
            title: <span class="hljs-string">'Kitchen Duty Plugin'</span>,
            close: <span class="hljs-string">'auto'</span>,
            body: message
        });
    });
};

<span class="hljs-keyword">var</span> initUserSearch = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">weekNumber</span>) </span>{ <span class="cs-source-point" data-cs-source-point-id="sdfdfhg36ig" data-cs-source-point-number="1"></span>
    <span class="hljs-comment">// Init SOY template</span>
    <span class="hljs-keyword">var</span> planningPageWeekUsersTemplate = JIRA.Templates.KDP.planningPageWeekUsers({
        week: weekNumber <span class="cs-source-point" data-cs-source-point-id="sdfdfhg36ig" data-cs-source-point-number="2"></span>
    });
    AJS.$(<span class="hljs-string">'#kdp-planning-page-week-users-container'</span>).html(planningPageWeekUsersTemplate); <span class="cs-source-point" data-cs-source-point-id="sdfdfhg36ig" data-cs-source-point-number="3"></span>

    <span class="hljs-comment">// Init actions</span>
    <span class="hljs-keyword">var</span> auiUserSelectOptions = {
        ajax: {
            url: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-built_in">window</span>.KDPrestUrl + <span class="hljs-string">'/user/search'</span>; },
            dataType: <span class="hljs-string">'json'</span>,
            delay: <span class="hljs-number">250</span>,
            data: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">searchTerm</span>) </span>{ <span class="hljs-keyword">return</span> { query: searchTerm }; },
            results: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>{ <span class="hljs-keyword">return</span> { results: data }; },
            cache: <span class="hljs-literal">true</span>
        },
        minimumInputLength: <span class="hljs-number">1</span>,
        tags: <span class="hljs-string">'true'</span>
    };
    AJS.$(<span class="hljs-string">'#kdp-user-select'</span>).auiSelect2(auiUserSelectOptions);

    <span class="hljs-comment">// Load initial values from REST API and set for aui-select</span>
    <span class="hljs-keyword">if</span> (weekNumber !== <span class="hljs-literal">null</span>) { <span class="cs-source-point" data-cs-source-point-id="sdfdfhg36ig" data-cs-source-point-number="4"></span>
        AJS.$.ajax({
            url: <span class="hljs-built_in">window</span>.KDPrestUrl + <span class="hljs-string">'/planning/week/'</span> + weekNumber + <span class="hljs-string">'/users'</span>,
            dataType: <span class="hljs-string">'json'</span>,
            success: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">users</span>) </span>{
                <span class="hljs-keyword">var</span> selectedUserList = [];
                <span class="hljs-keyword">if</span> (users !== <span class="hljs-literal">null</span>) { <span class="cs-source-point" data-cs-source-point-id="sdfdfhg36ig" data-cs-source-point-number="5"></span>
                    users.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">user</span>) </span>{
                        selectedUserList.push({ id: user.username, text: user.username });
                    });
                    AJS.$(<span class="hljs-string">'#kdp-user-select'</span>).select2(<span class="hljs-string">'data'</span>, selectedUserList);
                }
            }
        });
    }

    <span class="hljs-comment">// Save users on save button click</span>
    AJS.$(<span class="hljs-string">'#kdp-user-select-form'</span>).off(); <span class="hljs-comment">// remove previous listeners</span>
    AJS.$(<span class="hljs-string">'#kdp-user-select-form'</span>).submit(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) </span>{
        e.preventDefault();
        <span class="hljs-keyword">var</span> selectedUserList = [];
        AJS.$(AJS.$(<span class="hljs-string">'#kdp-user-select'</span>).select2(<span class="hljs-string">'data'</span>)).each(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-comment">// we need to transform the JSON sent to the Endpoint since it</span>
            <span class="hljs-comment">// has to be in specific format</span>
            selectedUserList.push({ username: <span class="hljs-keyword">this</span>.text });
        });
        AJS.$.ajax({ <span class="cs-source-point" data-cs-source-point-id="sdfdfhg36ig" data-cs-source-point-number="6"></span>
            url: <span class="hljs-built_in">window</span>.KDPrestUrl + <span class="hljs-string">'/planning/week/'</span> + weekNumber + <span class="hljs-string">'/users'</span>,
            type: <span class="hljs-string">'PUT'</span>,
            contentType: <span class="hljs-string">'application/json'</span>,
            data: <span class="hljs-built_in">JSON</span>.stringify(selectedUserList),
            processData: <span class="hljs-literal">false</span>,
            success: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                showSuccessFlag(<span class="hljs-string">'Saved users for Week '</span> + weekNumber);
            },
            error: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                showErrorFlag(<span class="hljs-string">'Failed to save users for Week '</span> + weekNumber);
            }
        });
    });
};

<span class="hljs-keyword">var</span> initWeekPicker = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="cs-source-point" data-cs-source-point-id="sdfdfhg36ig" data-cs-source-point-number="7"></span>
    <span class="hljs-comment">// Init SOY template</span>
    <span class="hljs-keyword">var</span> planningPageWeekTemplate = JIRA.Templates.KDP.planningPageWeek();
    AJS.$(<span class="hljs-string">'#kdp-planning-page-week-container'</span>).html(planningPageWeekTemplate);

    <span class="hljs-comment">// Init actions</span>
    AJS.$(<span class="hljs-string">'#week-picker'</span>).off(); <span class="hljs-comment">// remove previous listeners</span>
    AJS.$(<span class="hljs-string">'#week-picker'</span>).datePicker({<span class="hljs-string">'overrideBrowserDefault'</span>: <span class="hljs-literal">true</span>});
    AJS.$(<span class="hljs-string">'#week-picker'</span>).change(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> week = moment(AJS.$(<span class="hljs-string">'#week-picker'</span>).val()).week(); <span class="cs-source-point" data-cs-source-point-id="sdfdfhg36ig" data-cs-source-point-number="8"></span>
        initUserSearch(week);
    });
};

AJS.toInit(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    AJS.log(<span class="hljs-string">'KDP: Planning Page Controller initializing ...'</span>);
    <span class="hljs-keyword">var</span> baseUrl = AJS.params.baseURL;
    <span class="hljs-keyword">var</span> restUrl = baseUrl + <span class="hljs-string">'/rest/kitchenduty/1.0'</span>;
    <span class="hljs-built_in">window</span>.KDPrestUrl = restUrl;

    <span class="hljs-comment">// set locale for moment-js so that week starts on sunday</span>
    <span class="hljs-comment">// and week numbers are correctly calculated</span>
    moment.locale(<span class="hljs-string">'en'</span>, {
        week: {
            dow: <span class="hljs-number">0</span>, <span class="hljs-comment">// Sunday (0) is the first day of the week</span>
            doy: <span class="hljs-number">1</span>  <span class="hljs-comment">// Week that contains Jan 1st is the first week of the year.</span>
        }
    });
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Week starts at: '</span> + moment().startOf(<span class="hljs-string">'week'</span>).format(<span class="hljs-string">'dddd'</span>));
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Current moment locale: '</span> + moment().locale());

    <span class="hljs-comment">// Init Base SOY template <span class="cs-source-point" data-cs-source-point-id="sdfdfhg36ig" data-cs-source-point-number="9"></span></span>
    <span class="hljs-keyword">var</span> planningPageTemplate = JIRA.Templates.KDP.planningPage();
    AJS.$(<span class="hljs-string">'#kdp-planning-page-container'</span>).html(planningPageTemplate);

    <span class="hljs-comment">// Init child templates <span class="cs-source-point" data-cs-source-point-id="sdfdfhg36ig" data-cs-source-point-number="10"></span></span>
    initWeekPicker();
    initUserSearch(<span class="hljs-literal">null</span>);
});</code></pre>

            </div>
            <div class="col-md-4 cs-sticky-in-parent">
                <div class="list-group cs-source-point-list" data-source-target="x3eewr8dasdsfsf67987ij">
                    <div class="list-group-item cs-source-point-list__item">
                       <strong>initUserSearch function</strong> renders the
                       <em>planningPageWeekUsers</em> soy template for the week number passed as parameter.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        <strong>week soy template parameter</strong> is passed to template from JavaScript function parameter.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        The rendered <em>planningPageWeekUsers</em> soy template is injected into the DOM.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        If the <em>weekNumber</em> variable is not null (meaning user has selected a date), then
                        load existing users for that week from our REST Endpoint via HTTP GET.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        If we get a non empty userlist from the API (meaning there are already users assigned for that week),
                        we build us a custom array to pass to the AUI Select 2 field. With the <strong>select2 function</strong>
                        on the DOM element of the AUI Select 2 you can pass in initial data like so:
                        <code>AJS.$('#id').select2('data', [ { id: 'foo', text: 'foo' } ]);</code>
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        When the form is submitted (meaning user clicked save button), then
                        we first build ourselves a userlist in the format the API can handle <code>selectedUserList.push({ username: this.text });</code>.
                        Then we send the userlist via HTTP PUT to our Endpoint for the selected week.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        <strong>initWeekPicker function</strong> renders the
                        <em>planningPageWeek</em> soy template. This template is only rendered once on page load.
                        It initializes the <a href="https://docs.atlassian.com/aui/7.8.1/docs/date-picker.html">AUI Date picker</a> for our textfield.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        This is the real magic now. We register a <strong>change listener</strong> to our date picker field,
                        meaning that once the user selects a date the function is called.
                        Inside that function we get the selected date from the date picker and pass it to the
                        <a href="http://momentjs.com/docs/#/get-set/week/">MomentJS week() function</a> which returns us
                        the week number for that date.
                        And once we have the week number we <strong>trigger a re-render of the <em>planningPageWeekUsers</em> template</strong> for that week.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        In our <code>AJS.toInit()</code> function (which is executed after the DOM has loaded),
                        we render the base <em>planningPage</em> soy template.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Right after that we initially render the child templates.
                        First the <code>initWeekPicker()</code> and secondly
                        the <code>initUserSearch()</code> with a <code>null</code> parameter,
                        telling the function that the user has not yet selected a date.
                    </div>
                </div>
            </div>
        </div>




        <p>That's it. Now we can run our plugin with <code>atlas-run</code> and when navigating to <a href="http://localhost:2990/jira/secure/KitchenDutyPlanningWebworkAction.jspa">http://localhost:2990/jira/secure/KitchenDutyPlanningWebworkAction.jspa</a>
        it should work as you can see below. <strong>We are completely done implementing the Kitchen Duty Planning Page</strong>.</p>

        
    
    
    <div class="row">
        <div class="offset-md-1 col-md-10">
            <p>
                <a href="/kitchen-duty-plugin-for-atlassian-jira/images/doc/step-05-planning-page-working.gif">
                    <img src="/kitchen-duty-plugin-for-atlassian-jira/images/doc/step-05-planning-page-working.gif" class="img-fluid" alt="Step 5 - Planning Page working"
                         data-bilderrahmen="gallery-01"
                         data-bilderrahmen-title="Step 5 - Planning Page working"
                    >
                </a>
            </p>
        </div>
    </div>


        <div class="cs-v-spacer"></div>
        <div class="cs-tutorial-step-review">
            <div class="cs-tutorial-step-review__headline">
                <strong>You have completed Step 5.</strong> Good Job! You can check out this step's solution on GitHub
            </div>
            <div class="cs-tutorial-step-review__link">
                <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/tree/master/step-05-kitchen-duty-plugin">
                    https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/tree/master/step-05-kitchen-duty-plugin
                </a>
            </div>
        </div>
        <div class="cs-v-spacer"></div>
        <p>The graphic shows marked green <strong>which components we implemented in this section</strong>.</p>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-10 offset-lg-1 col-xl-8 offset-xl-2">
                
<svg class="cs-interactive-graphic"
     id="p07-ig01"
     data-json-settings="{
                    &quot;markedAsDone&quot;: [ &quot;webwork-action&quot;, &quot;html-view&quot;, &quot;user-resource&quot;, &quot;user-search-resource-model&quot;, &quot;user-js-controller&quot;, &quot;kitchen-duty-resource&quot;, &quot;kitchen-duty-planning-model&quot;, &quot;kitchen-duty-js-controller&quot; ],
                    &quot;markedAsTodo&quot;: [  ],
                    &quot;markedAsGrayedOut&quot;: [ ],
                    &quot;onClick&quot;: [ ]
                }"
     data-svg-to-load="kitchen-duty-planning-page--component-overview"
     viewBox="0 0 1043 654"
     preserveAspectRatio="xMaxYMax">
</svg>

            </div>
        </div>

        <div class="cs-v-spacer cs-v-spacer--big"></div>
        <div class="cs-v-spacer cs-v-spacer--big"></div>

    </div>
</div>



        </div>
    </div>
</div>


<div class="cs-footer">
    <div class="cs-legal-box">
        <a href="/kitchen-duty-plugin-for-atlassian-jira/author-and-license/">Author &middot; License &middot; Trademarks</a>
        <a target="_blank" href="https://legal.comsysto.com/comsysto.github.io/de/impressum/">Impressum &middot; Imprint</a>
        <a target="_blank" href="https://legal.comsysto.com/comsysto.github.io/de/datenschutz/">Datenschutz &middot; Privacy</a>
        <a class="d-none d-sm-inline btn-borderless cs-stars-on-github-give-star-button" href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira" target="_blank">
            star on GitHub
        </a>
    </div>

    <div class="text-right cs-pager">
        <a class="btn btn-secondary" href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/07-step-04-planning-page--kitchen-duty-planning-rest-resource/">
            <i class="fa fa-angle-left"></i>
            <span class="d-none d-lg-inline">previous page</span>
        </a>
        
        <a class="btn btn-secondary" href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/09-story-workshop-for-overview-page/">
            <span class="d-none d-lg-inline">next page</span>
            <i class="fa fa-angle-right"></i></a>
        
    </div>
</div>







<script src="/kitchen-duty-plugin-for-atlassian-jira/generated/bundle.js?v2018-09-02--12-50" async></script>


<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
<script>
    WebFont.load({
        google: {
            families: [ 'Menlo',
                'Open+Sans:400,300,600,700,800',
                'Roboto:400,900,700',
                'Source+Sans+Pro:400,300,600',
                'Patrick+Hand'
            ]
        }
    });
</script>
</body>
</html>
