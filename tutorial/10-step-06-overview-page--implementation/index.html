<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    
    
    <title>Kitchen Duty Overview Page Implementation ~ Overview Page | Plugin Development Tutorial for Atlassian JIRA® | Kitchen Duty Plugin by Comsysto Reply</title>
    <meta description="An interactive step-by-step tutorial on how to write Plugins for Atlassian JIRA® by Comsysto Reply">
    <meta name="robots" content="noindex, nofollow">


    
    <meta property="og:title" content="Kitchen Duty Plugin for Atlassian JIRA® by Comsysto Reply" />
    <meta property="og:image" content="https://comsysto.github.io/kitchen-duty-plugin-for-atlassian-jira/images/kitchen-duty-plugin--social.jpg" />
    <meta property="og:description" content="An interactive tutorial on how to write Plugins for Atlassian JIRA® by Comsysto Reply" />

    
    <link rel="canonical" href="https://comsysto.github.io/kitchen-duty-plugin-for-atlassian-jira/tutorial/10-step-06-overview-page--implementation/" />

    <link rel="alternate" type="application/rss+xml" title="Kitchen Duty Plugin News" href="https://comsysto.github.io/kitchen-duty-plugin-for-atlassian-jira/rss_feed.xml" />



    <link href="/kitchen-duty-plugin-for-atlassian-jira/generated/bundlev2.css?v2018-09-01--12-50" rel="stylesheet">

    <link rel="icon" href="/kitchen-duty-plugin-for-atlassian-jira/images/favicon-32.png" type="image/png" sizes="32x32">
    <link rel="icon" href="/kitchen-duty-plugin-for-atlassian-jira/images/favicon-256.png" type="image/png" sizes="256x256">
    <link rel="icon" href="/kitchen-duty-plugin-for-atlassian-jira/images/favicon.svg" type="image/svg+xml">

    <script>var postLoadMethods = [];</script>
</head>
<body class="cs-tutorial-body">




















<textarea id="copy-to-clipboard-dummy"></textarea>
<div class="cs-page-header">
    <div class="row">
        <div class="col-md-5 cs-page-header-left">
            <a href="/kitchen-duty-plugin-for-atlassian-jira/" class="cs-page-logo">
                <span class="cs-page-logo-img d-none d-lg-inline"></span>
                <h1>Kitchen Duty Plugin</h1>
                <h2>Tutorial for Atlassian JIRA® Server</h2>
            </a>
            <a class="btn btn-primary cs-burger-button" id="toggleSidebarButton">
                <span class="cs-news-right" style="color:#fff;"><i class="fa fa-bars fa-lg" aria-hidden="true"></i></span>
            </a>
        </div>
        <div class="col-md-3 text-center d-none d-sm-block" style="padding-top:10px;">

            <!--
            <a class="btn btn-primary btn-borderless" href="/kitchen-duty-plugin-for-atlassian-jira/news/" target="_blank">
                <span class="cs-news-right">news</span>
            </a>
            -->
        </div>
        <div class="col-md-4  d-none d-sm-block cs-page-header-cs-logo text-right cs-page-header--right-fix">
            <a href="https://comsystoreply.de" target="_blank"><img src="/kitchen-duty-plugin-for-atlassian-jira/images/comsysto-logo.png" alt="Comsysto Reply" style="width:150px; margin-top:-20px;"/></a>
        </div>
    </div>
</div>

<!-- CONTENT -->


<div class="cs-content">
    <div class="cs-sidebar-wrapper">
        
<div id="toc">
    <ul>

        

        <li class="toc-h2 ">
            <a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/01-introduction/">
                <span>&nbsp;</span>
                Introduction
            </a>
        </li>
        <li class="toc-h2 ">
            <a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/02-step-00-getting-started/">
                <span class="cs-step-badge">0</span>
                Getting Started
            </a>
        </li>

        

        <li class="toc-h2-divider">Part I: Kitchen Duty Planning Page</li>

        <li class="toc-h2 ">
            <a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/03-story-workshop-for-planning-page/">
                <span>&nbsp;</span>
                Story Workshop for Planning Page
            </a>
        </li>
        <li class="toc-h2 ">
            <a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/04-step-01-planning-page--webwork-action-and-html-view/">
                <span class="cs-step-badge">1</span>
                Webwork Action and HTML View
            </a>
        </li>
        <li class="toc-h2 ">
            <a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/05-step-02-planning-page--user-search-rest-resource/">
                <span class="cs-step-badge">2</span>
                User Search REST Resource
            </a>
        </li>
        <li class="toc-h2 ">
            <a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/06-step-03-planning-page--user-search-js-controller/">
                <span class="cs-step-badge">3</span>
                User Search JS Controller
            </a>
        </li>
        <li class="toc-h2 ">
            <a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/07-step-04-planning-page--kitchen-duty-planning-rest-resource/">
                <span class="cs-step-badge">4</span>
                Kitchen Duty Planning REST Resource
            </a>
        </li>
        <li class="toc-h2 ">
            <a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/08-step-05-planning-page--kitchen-duty-planning-js-controller/">
                <span class="cs-step-badge">5</span>
                Kitchen Duty Planning JS Controller
            </a>
        </li>


<!-- DISABLE SVG STATUS FOR NOW
        
-->

        

        <li class="toc-h2-divider">Part II: Kitchen Duty Overview Page</li>
        <li class="toc-h2 ">
            <a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/09-story-workshop-for-overview-page/">
                <span>&nbsp;</span>
                Story Workshop for Overview Page
            </a>
        </li>
        <li class="toc-h2 toc-active">
            <a href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/10-step-06-overview-page--implementation/">
                <span class="cs-step-badge">6</span>
                Kitchen Duty Overview Page
            </a>
        </li>


        


        <li class="toc-h2-divider">Misc</li>

        <li class="toc-h2 ">
            <a href="/kitchen-duty-plugin-for-atlassian-jira/news/">
                <span>&nbsp;</span>
                News
            </a>
        </li>

    </ul>







</div>


    </div>
    <div class="cs-content-wrapper">
        <div class="cs-content-wrapper-inner">
        



<div class="row">
    <div class="col-md-12">
        




<h2 class="cs-headline cs-headline--m cs-headline--anchor"
    data-scroll-to-headline="kitchen-duty-overview-page"
    data-scroll-to-headline-previous="">
    
    Kitchen Duty Overview Page
</h2>


        <p>
            Before we continue any further we need to clean up some <strong>technical debt</strong>.
            I just realised the <strong>REST API Endpoints are not secured</strong> also the <strong>database spaghetti code</strong>
            really bugs me out. Therefore here are some completely unrelated but necessary things we need to do.
        </p>

        <h3 class="cs-headline cs-headline--s">BaseResource and AuthGuards for KitchenDutyPlanningResource Endpoint</h3>

        <div class="row">
            <div class="col-md-8">
                <p>
                    Since we will get more Endpoints now for our Overview Page we will have common code. Therefore we will create a base-class all endpoints extend from.
                    We move the common code there. The first thing is the dependencies to <code>UserManager</code> and <code>ActiveObjects</code>.
                    Next are the two <strong>AuthGuard methods</strong> we will use to secure every endpoint <code>isUserLoggedIn()</code> and <code>isUserNotAdmin()</code>.
                    Lastly we need some convenience methods to serve certain HTTP Error codes as JSON - therefore we now have <code>getUnauthorizedErrorResponse()</code> and <code>getForbiddenErrorResponse()</code>.
                </p>


                

<div class="cs-code-filename">
    
    <span class="d-none d-lg-inline d-xl-inline">src/main/java/com/comsysto/kitchen/duty/rest/</span><span class="d-none d-sm-inline d-lg-none d-xl-none"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/java/com/comsysto/kitchen/duty/rest/">.../</span>BaseResource.java
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/master/step-06-kitchen-duty-plugin/src/main/java/com/comsysto/kitchen/duty/rest/BaseResource.java" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="package com.comsysto.kitchen.duty.rest;

import com.atlassian.activeobjects.external.ActiveObjects;
import com.atlassian.sal.api.user.UserProfile;

import javax.ws.rs.core.Response;
import java.time.LocalDate;
import java.time.temporal.ChronoField;
import java.time.temporal.WeekFields;
import java.util.ArrayList;
import java.util.List;

public class BaseResource {

    protected com.atlassian.sal.api.user.UserManager userManager;
    protected ActiveObjects activeObjects;

    protected Boolean isUserLoggedIn() {
        UserProfile user = userManager.getRemoteUser();
        if (user != null) {
            return true;
        } else {
            return false;
        }
    }

    public Boolean isUserNotAdmin() {
        UserProfile user = userManager.getRemoteUser();;
        return (user == null || !userManager.isAdmin(user.getUserKey()));
    }

    protected Response getUnauthorizedErrorResponse() {
        return Response.serverError()
            .entity(new RestError(
                RestError.errorText401,
                401001,
                Response.Status.UNAUTHORIZED.getStatusCode()))
            .status(Response.Status.UNAUTHORIZED)
            .build();
    }

    protected Response getForbiddenErrorResponse() {
        return Response.serverError()
            .entity(new RestError(
                RestError.errorText403,
                403001,
                Response.Status.FORBIDDEN.getStatusCode()))
            .status(Response.Status.FORBIDDEN)
            .build();
    }
}"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-keyword">package</span> com.comsysto.kitchen.duty.rest;

<span class="hljs-keyword">import</span> com.atlassian.activeobjects.external.ActiveObjects;
<span class="hljs-keyword">import</span> com.atlassian.sal.api.user.UserProfile;

<span class="hljs-keyword">import</span> javax.ws.rs.core.Response;
<span class="hljs-keyword">import</span> java.time.LocalDate;
<span class="hljs-keyword">import</span> java.time.temporal.ChronoField;
<span class="hljs-keyword">import</span> java.time.temporal.WeekFields;
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseResource</span> </span>{

    <span class="hljs-keyword">protected</span> com.atlassian.sal.api.user.UserManager userManager;
    <span class="hljs-keyword">protected</span> ActiveObjects activeObjects;

    <span class="hljs-function"><span class="hljs-keyword">protected</span> Boolean <span class="hljs-title">isUserLoggedIn</span><span class="hljs-params">()</span> </span>{
        UserProfile user = userManager.getRemoteUser();
        <span class="hljs-keyword">if</span> (user != <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> Boolean <span class="hljs-title">isUserNotAdmin</span><span class="hljs-params">()</span> </span>{
        UserProfile user = userManager.getRemoteUser();;
        <span class="hljs-keyword">return</span> (user == <span class="hljs-keyword">null</span> || !userManager.isAdmin(user.getUserKey()));
    }

    <span class="hljs-function"><span class="hljs-keyword">protected</span> Response <span class="hljs-title">getUnauthorizedErrorResponse</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> Response.serverError()
            .entity(<span class="hljs-keyword">new</span> RestError(
                RestError.errorText401,
                <span class="hljs-number">401001</span>,
                Response.Status.UNAUTHORIZED.getStatusCode()))
            .status(Response.Status.UNAUTHORIZED)
            .build();
    }

    <span class="hljs-function"><span class="hljs-keyword">protected</span> Response <span class="hljs-title">getForbiddenErrorResponse</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> Response.serverError()
            .entity(<span class="hljs-keyword">new</span> RestError(
                RestError.errorText403,
                <span class="hljs-number">403001</span>,
                Response.Status.FORBIDDEN.getStatusCode()))
            .status(Response.Status.FORBIDDEN)
            .build();
    }
}</code></pre>


            </div>
            <div class="col-md-4 text-center">
                <div style="max-width:500px">
                    <img src="/kitchen-duty-plugin-for-atlassian-jira/images/drawings/06-fffecurity.svg" class="img-fluid">
                </div>
            </div>
        </div>


        <p>You might have already seen that we use a class <code>RestError</code>. This is a simple pojo to serve our errors as JSON.</p>

        

<div class="cs-code-filename">
    
    <span class="d-none d-lg-inline d-xl-inline">src/main/java/com/comsysto/kitchen/duty/rest/</span><span class="d-none d-sm-inline d-lg-none d-xl-none"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/java/com/comsysto/kitchen/duty/rest/">.../</span>RestError.java
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/master/step-06-kitchen-duty-plugin/src/main/java/com/comsysto/kitchen/duty/rest/RestError.java" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="package com.comsysto.kitchen.duty.rest;

import javax.xml.bind.annotation.XmlAccessType;
import javax.xml.bind.annotation.XmlAccessorType;
import javax.xml.bind.annotation.XmlElement;
import javax.xml.bind.annotation.XmlRootElement;

@XmlRootElement(name = &quot;status&quot;)
@XmlAccessorType(XmlAccessType.FIELD)
public class RestError {

    public static final String errorText401 = &quot;Unauthorized (no user is authenticated).&quot;;
    public static final String errorText403 = &quot;Permission Denied (insufficient rights).&quot;;

    @XmlElement(name = &quot;statusCode&quot;)
    private Integer statusCode;

    @XmlElement(name = &quot;subCode&quot;)
    private Integer subCode;

    @XmlElement
    private String message;

    public RestError() {    }

    public RestError(String message, Integer subCode, Integer statusCode) {
        this.setMessage(message);
        this.setStatusCode(statusCode);
        this.setSubCode(subCode);
    }

    public Integer getStatusCode() {
        return statusCode;
    }

    public void setStatusCode(Integer statusCode) {
        this.statusCode = statusCode;
    }

    public String getMessage() {
        return message;
    }

    public void setMessage(String message) {
        this.message = message;
    }

    public Integer getSubCode() {
        return subCode;
    }

    public void setSubCode(Integer subCode) {
        this.subCode = subCode;
    }
}"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-keyword">package</span> com.comsysto.kitchen.duty.rest;

<span class="hljs-keyword">import</span> javax.xml.bind.annotation.XmlAccessType;
<span class="hljs-keyword">import</span> javax.xml.bind.annotation.XmlAccessorType;
<span class="hljs-keyword">import</span> javax.xml.bind.annotation.XmlElement;
<span class="hljs-keyword">import</span> javax.xml.bind.annotation.XmlRootElement;

<span class="hljs-annotation">@XmlRootElement</span>(name = <span class="hljs-string">"status"</span>)
<span class="hljs-annotation">@XmlAccessorType</span>(XmlAccessType.FIELD)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RestError</span> </span>{

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String errorText401 = <span class="hljs-string">"Unauthorized (no user is authenticated)."</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String errorText403 = <span class="hljs-string">"Permission Denied (insufficient rights)."</span>;

    <span class="hljs-annotation">@XmlElement</span>(name = <span class="hljs-string">"statusCode"</span>)
    <span class="hljs-keyword">private</span> Integer statusCode;

    <span class="hljs-annotation">@XmlElement</span>(name = <span class="hljs-string">"subCode"</span>)
    <span class="hljs-keyword">private</span> Integer subCode;

    <span class="hljs-annotation">@XmlElement</span>
    <span class="hljs-keyword">private</span> String message;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">RestError</span><span class="hljs-params">()</span> </span>{    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">RestError</span><span class="hljs-params">(String message, Integer subCode, Integer statusCode)</span> </span>{
        <span class="hljs-keyword">this</span>.setMessage(message);
        <span class="hljs-keyword">this</span>.setStatusCode(statusCode);
        <span class="hljs-keyword">this</span>.setSubCode(subCode);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getStatusCode</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> statusCode;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setStatusCode</span><span class="hljs-params">(Integer statusCode)</span> </span>{
        <span class="hljs-keyword">this</span>.statusCode = statusCode;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getMessage</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> message;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setMessage</span><span class="hljs-params">(String message)</span> </span>{
        <span class="hljs-keyword">this</span>.message = message;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getSubCode</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> subCode;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setSubCode</span><span class="hljs-params">(Integer subCode)</span> </span>{
        <span class="hljs-keyword">this</span>.subCode = subCode;
    }
}</code></pre>


            <p>Ok now we need our existing <code>KitchenDutyPlanningResource</code> <strong>to extend the <code>BaseResource</code> and use the AuthGuards</strong>.</p>
            <div class="row">
                <div class="col-md-7">
                    

<div class="cs-code-filename">
    
    <span class="d-none d-lg-inline d-xl-inline">src/main/java/com/comsysto/kitchen/duty/rest/</span><span class="d-none d-sm-inline d-lg-none d-xl-none"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/java/com/comsysto/kitchen/duty/rest/">.../</span>KitchenDutyPlanningResource.java
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/master/step-06-kitchen-duty-plugin/src/main/java/com/comsysto/kitchen/duty/rest/KitchenDutyPlanningResource.java" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="package com.comsysto.kitchen.duty.rest;

...

@Named
@Path(&quot;/planning&quot;)
public class KitchenDutyPlanningResource extends BaseResource { 

    @Inject
    public KitchenDutyPlanningResource(ActiveObjects activeObjects, 
                                       UserManager userManager) {
        this.activeObjects = activeObjects;
        this.userManager = userManager;
    }

    public KitchenDutyPlanningResource() {
    }

    @GET
    @Path(&quot;/week/{isoWeekNumber}/users&quot;)
    @Produces({MediaType.APPLICATION_JSON})
    @AnonymousAllowed
    public Response getUsersForWeek(@PathParam(&quot;isoWeekNumber&quot;) final Integer isoWeekNumber) {
        // AUTHENTICATION
        if (!this.isUserLoggedIn()) { 
            return getUnauthorizedErrorResponse();
        }
        // AUTHORIZATION
        if (this.isUserNotAdmin()) { 
            return getForbiddenErrorResponse();
        }
        // BUSINESS LOGIC
        ...
    }

    @PUT
    @Path(&quot;/week/{isoWeekNumber}/users&quot;)
    @Produces({MediaType.APPLICATION_JSON})
    @AnonymousAllowed 
    public Response addUserToWeek(@PathParam(&quot;isoWeekNumber&quot;) final Integer isoWeekNumber,
                                  final List&lt;KitchenDutyPlanningResourceUserModel&gt; userParams) {
        // AUTHENTICATION
        if (!this.isUserLoggedIn()) {
            return getUnauthorizedErrorResponse();
        }
        // AUTHORIZATION
        if (this.isUserNotAdmin()) {
            return getForbiddenErrorResponse();
        }
        // BUSINESS LOGIC
        ...
    }

    @DELETE
    @Path(&quot;/week/{isoWeekNumber}/users&quot;)
    @Produces({MediaType.APPLICATION_JSON})
    @AnonymousAllowed
    public Response deleteUserFomWeek(@PathParam(&quot;isoWeekNumber&quot;) final Integer isoWeekNumber,
                                  final KitchenDutyPlanningResourceUserModel userParam) {
        // AUTHENTICATION
        if (!this.isUserLoggedIn()) {
            return getUnauthorizedErrorResponse();
        }
        // AUTHORIZATION
        if (this.isUserNotAdmin()) {
            return getForbiddenErrorResponse();
        }
        // BUSINESS LOGIC
        ...
    }

    @GET
    @Path(&quot;/user/{username}/weeks&quot;)
    @Produces({MediaType.APPLICATION_JSON})
    @AnonymousAllowed
    public Response getWeeksForUser(@PathParam(&quot;username&quot;) final String username) {
        // AUTHENTICATION
        if (!this.isUserLoggedIn()) {
            return getUnauthorizedErrorResponse();
        }
        // AUTHORIZATION
        if (this.isUserNotAdmin()) {
            return getForbiddenErrorResponse();
        }
        // BUSINESS LOGIC
        ...
    }


    @GET
    @Path(&quot;/health&quot;)
    @Produces({MediaType.APPLICATION_JSON})
    @AnonymousAllowed
    public Response health() {
        return Response.ok(&quot;ok&quot;).build();
    }

}"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-keyword">package</span> com.comsysto.kitchen.duty.rest;

...

<span class="hljs-annotation">@Named</span>
<span class="hljs-annotation">@Path</span>(<span class="hljs-string">"/planning"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KitchenDutyPlanningResource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseResource</span> </span>{ <span class="cs-source-point" data-cs-source-point-id="fsdsdasfggfsd5" data-cs-source-point-number="1"></span>

    <span class="hljs-annotation">@Inject</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">KitchenDutyPlanningResource</span><span class="hljs-params">(ActiveObjects activeObjects, <span class="cs-source-point" data-cs-source-point-id="fsdsdasfggfsd5" data-cs-source-point-number="2"></span>
                                       UserManager userManager)</span> </span>{
        <span class="hljs-keyword">this</span>.activeObjects = activeObjects;
        <span class="hljs-keyword">this</span>.userManager = userManager;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">KitchenDutyPlanningResource</span><span class="hljs-params">()</span> </span>{
    }

    <span class="hljs-annotation">@GET</span>
    <span class="hljs-annotation">@Path</span>(<span class="hljs-string">"/week/{isoWeekNumber}/users"</span>)
    <span class="hljs-annotation">@Produces</span>({MediaType.APPLICATION_JSON})
    <span class="hljs-annotation">@AnonymousAllowed</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Response <span class="hljs-title">getUsersForWeek</span><span class="hljs-params">(@PathParam(<span class="hljs-string">"isoWeekNumber"</span>)</span> <span class="hljs-keyword">final</span> Integer isoWeekNumber) </span>{
        <span class="hljs-comment">// AUTHENTICATION</span>
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isUserLoggedIn()) { <span class="cs-source-point" data-cs-source-point-id="fsdsdasfggfsd5" data-cs-source-point-number="3"></span>
            <span class="hljs-keyword">return</span> getUnauthorizedErrorResponse();
        }
        <span class="hljs-comment">// AUTHORIZATION</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isUserNotAdmin()) { <span class="cs-source-point" data-cs-source-point-id="fsdsdasfggfsd5" data-cs-source-point-number="4"></span>
            <span class="hljs-keyword">return</span> getForbiddenErrorResponse();
        }
        <span class="hljs-comment">// BUSINESS LOGIC</span>
        ...
    }

    <span class="hljs-annotation">@PUT</span>
    <span class="hljs-annotation">@Path</span>(<span class="hljs-string">"/week/{isoWeekNumber}/users"</span>)
    <span class="hljs-annotation">@Produces</span>({MediaType.APPLICATION_JSON})
    <span class="hljs-annotation">@AnonymousAllowed</span> <span class="cs-source-point" data-cs-source-point-id="fsdsdasfggfsd5" data-cs-source-point-number="5"></span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Response <span class="hljs-title">addUserToWeek</span><span class="hljs-params">(@PathParam(<span class="hljs-string">"isoWeekNumber"</span>)</span> <span class="hljs-keyword">final</span> Integer isoWeekNumber,
                                  <span class="hljs-keyword">final</span> List&lt;KitchenDutyPlanningResourceUserModel&gt; userParams) </span>{
        <span class="hljs-comment">// AUTHENTICATION</span>
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isUserLoggedIn()) {
            <span class="hljs-keyword">return</span> getUnauthorizedErrorResponse();
        }
        <span class="hljs-comment">// AUTHORIZATION</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isUserNotAdmin()) {
            <span class="hljs-keyword">return</span> getForbiddenErrorResponse();
        }
        <span class="hljs-comment">// BUSINESS LOGIC</span>
        ...
    }

    <span class="hljs-annotation">@DELETE</span>
    <span class="hljs-annotation">@Path</span>(<span class="hljs-string">"/week/{isoWeekNumber}/users"</span>)
    <span class="hljs-annotation">@Produces</span>({MediaType.APPLICATION_JSON})
    <span class="hljs-annotation">@AnonymousAllowed</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Response <span class="hljs-title">deleteUserFomWeek</span><span class="hljs-params">(@PathParam(<span class="hljs-string">"isoWeekNumber"</span>)</span> <span class="hljs-keyword">final</span> Integer isoWeekNumber,
                                  <span class="hljs-keyword">final</span> KitchenDutyPlanningResourceUserModel userParam) </span>{
        <span class="hljs-comment">// AUTHENTICATION</span>
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isUserLoggedIn()) {
            <span class="hljs-keyword">return</span> getUnauthorizedErrorResponse();
        }
        <span class="hljs-comment">// AUTHORIZATION</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isUserNotAdmin()) {
            <span class="hljs-keyword">return</span> getForbiddenErrorResponse();
        }
        <span class="hljs-comment">// BUSINESS LOGIC</span>
        ...
    }

    <span class="hljs-annotation">@GET</span>
    <span class="hljs-annotation">@Path</span>(<span class="hljs-string">"/user/{username}/weeks"</span>)
    <span class="hljs-annotation">@Produces</span>({MediaType.APPLICATION_JSON})
    <span class="hljs-annotation">@AnonymousAllowed</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Response <span class="hljs-title">getWeeksForUser</span><span class="hljs-params">(@PathParam(<span class="hljs-string">"username"</span>)</span> <span class="hljs-keyword">final</span> String username) </span>{
        <span class="hljs-comment">// AUTHENTICATION</span>
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isUserLoggedIn()) {
            <span class="hljs-keyword">return</span> getUnauthorizedErrorResponse();
        }
        <span class="hljs-comment">// AUTHORIZATION</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isUserNotAdmin()) {
            <span class="hljs-keyword">return</span> getForbiddenErrorResponse();
        }
        <span class="hljs-comment">// BUSINESS LOGIC</span>
        ...
    }


    <span class="hljs-annotation">@GET</span>
    <span class="hljs-annotation">@Path</span>(<span class="hljs-string">"/health"</span>)
    <span class="hljs-annotation">@Produces</span>({MediaType.APPLICATION_JSON})
    <span class="hljs-annotation">@AnonymousAllowed</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Response <span class="hljs-title">health</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> Response.ok(<span class="hljs-string">"ok"</span>).build();
    }

}</code></pre>

            </div>
            <div class="col-md-5 cs-sticky-in-parent">
                <div class="list-group cs-source-point-list" data-source-target="fsdsdasfggfsd5">
                    <div class="list-group-item cs-source-point-list__item">
                       Class needs to extend <code>BaseResource</code> now.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                       Constructor now needs to do dependency injection for <code>UserManager</code> and <code>ActiveObjects</code>.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                       AuthGuard to ensure user is logged in. Otherwise error HTTP 401 Unauthorized is served.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                       AuthGuard to ensure user is administrator. Otherwise error HTTP 403 Forbidden is served.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        <strong>Why not just remove <code>@AnonymousAllowed</code></strong>? You can do that - then JIRA will do the authentication and error handling and most likely send you HTML errors instead of JSON.
                        Just do Authentication and Authorization the way you see it fits best for you. This is just one way to do so, but it is also risky if you forget the AuthGuards for some methods.
                        You should always have automated REST API tests ensure your plugin is really secure.
                    </div>
                </div>
            </div>
        </div>

        <p>

        </p>

        <p>You might have noticed that we use a <code>UserManager</code> that <strong>comes from the SAL API</strong>. We have already learned that we need to add a <code>@ComponentImport</code> for that.</p>


        

<div class="cs-code-filename">
    
    <span class="d-none d-lg-inline d-xl-inline">src/main/java/com/comsysto/kitchen/duty/impl/</span><span class="d-none d-sm-inline d-lg-none d-xl-none"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/java/com/comsysto/kitchen/duty/impl/">.../</span>MyPluginComponentImpl.java
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/master/step-06-kitchen-duty-plugin/src/main/java/com/comsysto/kitchen/duty/impl/MyPluginComponentImpl.java" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="package com.comsysto.kitchen.duty.impl;

...

@ExportAsService ({MyPluginComponent.class})
@Named (&quot;myPluginComponent&quot;)
public class MyPluginComponentImpl implements MyPluginComponent {

    @ComponentImport
    protected com.atlassian.sal.api.user.UserManager userManager;
    ...
}"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-keyword">package</span> com.comsysto.kitchen.duty.impl;

...

<span class="hljs-annotation">@ExportAsService</span> ({MyPluginComponent.class})
<span class="hljs-annotation">@Named</span> (<span class="hljs-string">"myPluginComponent"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyPluginComponentImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MyPluginComponent</span> </span>{

    <span class="hljs-annotation">@ComponentImport</span>
    <span class="hljs-keyword">protected</span> com.atlassian.sal.api.user.UserManager userManager;
    ...
}</code></pre>


        <p>&nbsp;</p>











        <h3 class="cs-headline cs-headline--s">KitchenDutyActiveObjectHelper - or howto move data access spaghetti code somewhere else</h3>

        <p>
        We have previously seen our REST Endpoints full of ugly transactional data access code.
        We want to move that stuff somewhere else and have clean REST Endpoints that just call some methods and do not care about transactions.
        The code simply moves into <strong><code>KitchenDutyActiveObjectHelper</code></strong>. There it can be ugly and we do not have to see it all the time.
        </p>



        <div class="row">
            <div class="col-md-7">
                

<div class="cs-code-filename">
    
    <span class="d-none d-lg-inline d-xl-inline">src/main/java/com/comsysto/kitchen/duty/ao/</span><span class="d-none d-sm-inline d-lg-none d-xl-none"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/java/com/comsysto/kitchen/duty/ao/">.../</span>KitchenDutyActiveObjectHelper.java
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/master/step-06-kitchen-duty-plugin/src/main/java/com/comsysto/kitchen/duty/ao/KitchenDutyActiveObjectHelper.java" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="package com.comsysto.kitchen.duty.ao;

...
import java.util.ArrayList;
import java.util.List;

public class KitchenDutyActiveObjectHelper {

    ....

    //
    // TRANSACTIONAL
    //

    public static Week getWeekByIsoWeekInTransaction(ActiveObjects activeObjects, Long isoWeekNumber) { 
        return activeObjects.executeInTransaction(new TransactionCallback&lt;Week&gt;() {
            @Override
            public Week doInTransaction() {
                Week[] weeks = activeObjects.find(Week.class, Query.select().where(&quot;WEEK = ?&quot;, isoWeekNumber));
                if (weeks != null &amp;&amp; weeks.length &gt; 0) {
                    return weeks[0];
                }
                return null;
            }
        });
    }

    public static List&lt;User&gt; getUsersAssignedToWeekInTransaction(ActiveObjects activeObjects, Week week) { 
        List&lt;User&gt; users = new ArrayList&lt;&gt;(); 
        if (week != null) {
            UserToWeek[] relationships = activeObjects.executeInTransaction(new TransactionCallback&lt;UserToWeek[]&gt;() {
                @Override
                public UserToWeek[] doInTransaction() {
                    return KitchenDutyActiveObjectHelper.findAllRelationships(activeObjects, week);
                }
            });
            if (relationships != null) {
                for (UserToWeek userToWeek : relationships) {
                    users.add(userToWeek.getUser());
                }
            }
        }
        return users;
    }

}"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-keyword">package</span> com.comsysto.kitchen.duty.ao;

...
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KitchenDutyActiveObjectHelper</span> </span>{

    ....

    <span class="hljs-comment">//</span>
    <span class="hljs-comment">// TRANSACTIONAL</span>
    <span class="hljs-comment">//</span>

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Week <span class="hljs-title">getWeekByIsoWeekInTransaction</span><span class="hljs-params">(ActiveObjects activeObjects, Long isoWeekNumber)</span> </span>{ <span class="cs-source-point" data-cs-source-point-id="fsdsdasfggfsddfsdffej5" data-cs-source-point-number="1"></span>
        <span class="hljs-keyword">return</span> activeObjects.executeInTransaction(<span class="hljs-keyword">new</span> TransactionCallback&lt;Week&gt;() {
            <span class="hljs-annotation">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> Week <span class="hljs-title">doInTransaction</span><span class="hljs-params">()</span> </span>{
                Week[] weeks = activeObjects.find(Week.class, Query.select().where(<span class="hljs-string">"WEEK = ?"</span>, isoWeekNumber));
                <span class="hljs-keyword">if</span> (weeks != <span class="hljs-keyword">null</span> &amp;&amp; weeks.length &gt; <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">return</span> weeks[<span class="hljs-number">0</span>];
                }
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
            }
        });
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;User&gt; <span class="hljs-title">getUsersAssignedToWeekInTransaction</span><span class="hljs-params">(ActiveObjects activeObjects, Week week)</span> </span>{ <span class="cs-source-point" data-cs-source-point-id="fsdsdasfggfsddfsdffej5" data-cs-source-point-number="2"></span>
        List&lt;User&gt; users = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(); <span class="cs-source-point" data-cs-source-point-id="fsdsdasfggfsddfsdffej5" data-cs-source-point-number="3"></span>
        <span class="hljs-keyword">if</span> (week != <span class="hljs-keyword">null</span>) {
            UserToWeek[] relationships = activeObjects.executeInTransaction(<span class="hljs-keyword">new</span> TransactionCallback&lt;UserToWeek[]&gt;() {
                <span class="hljs-annotation">@Override</span>
                <span class="hljs-keyword">public</span> UserToWeek[] doInTransaction() {
                    <span class="hljs-keyword">return</span> KitchenDutyActiveObjectHelper.findAllRelationships(activeObjects, week);
                }
            });
            <span class="hljs-keyword">if</span> (relationships != <span class="hljs-keyword">null</span>) {
                <span class="hljs-keyword">for</span> (UserToWeek userToWeek : relationships) {
                    users.add(userToWeek.getUser());
                }
            }
        }
        <span class="hljs-keyword">return</span> users;
    }

}</code></pre>

            </div>
            <div class="col-md-5 cs-sticky-in-parent">
                <div class="list-group cs-source-point-list" data-source-target="fsdsdasfggfsddfsdffej5">
                    <div class="list-group-item cs-source-point-list__item">
                       <strong><code>getWeekByIsoWeekInTransaction()</code></strong> gives us either an object of <code>Week</code> or <code>null</code> for a certain iso week.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                       <strong><code>getUsersAssignedToWeekInTransaction()</code></strong> gives us either a list of <code>List&lt;User&gt;</code> or and empty list for a certain week.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                       Note that we never return null for lists. It is always convenient in the upper layers of our code (e.g. the REST Endpoints) to not always have to null check everything.
                    </div>
                    <div class="mt-3 text-center">
                        <img src="/kitchen-duty-plugin-for-atlassian-jira/images/drawings/06-al-dente.svg" class="img-fluid" style="max-width:400px">
                    </div>
                </div>
            </div>
        </div>

        <p>These two methods are needed for our Overview Page REST Endpoint. If you are brave enough you can refactor the Planning Page REST Endpoint in the same way and move
        the code to <code>KitchenDutyActiveObjectHelper</code>.</p>

        <p>&nbsp;</p>

        <h3 class="cs-headline cs-headline--s">Kitchen Duty Overview Page REST Resource</h3>

        <p>We now need a REST Endpoint to give us all weeks with users that have kitchen duty for the whole month.</p>
        <p>
            But since we checked the <a href="https://fullcalendar.io/docs/event-object">Events Object Spec of Full Calendar</a> we know that for a
            valid event we need <strong>the start and the end date</strong>.
            We want an event representing a week which means sunday is the start date and saturday the end date.
            It is possible to calculate that in JavaScript but I decided to do it in Java.
        </p>

        

<div class="cs-code-filename">
    
    desired event response for march 2018
    
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="[
  {
    &quot;isoWeek&quot;: 10,
    &quot;start&quot;: &quot;2018-03-04&quot;,
    &quot;end&quot;: &quot;2018-03-10&quot;,
    &quot;users&quot;: [ ]
  },
  {
    &quot;isoWeek&quot;: 11,
    &quot;start&quot;: &quot;2018-03-11&quot;,
    &quot;end&quot;: &quot;2018-03-17&quot;,
    &quot;users&quot;: [ &quot;admin&quot; ]
  },
  ...
]"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs">[
  {
    <span class="hljs-string">"isoWeek"</span>: <span class="hljs-number">10</span>,
    <span class="hljs-string">"start"</span>: <span class="hljs-string">"2018-03-04"</span>,
    <span class="hljs-string">"end"</span>: <span class="hljs-string">"2018-03-10"</span>,
    <span class="hljs-string">"users"</span>: [ ]
  },
  {
    <span class="hljs-string">"isoWeek"</span>: <span class="hljs-number">11</span>,
    <span class="hljs-string">"start"</span>: <span class="hljs-string">"2018-03-11"</span>,
    <span class="hljs-string">"end"</span>: <span class="hljs-string">"2018-03-17"</span>,
    <span class="hljs-string">"users"</span>: [ <span class="hljs-string">"admin"</span> ]
  },
  ...
]</code></pre>


        <p>Since we moved the data access code to our ActiveObjectsHelper our Endpoint looks very clean now.</p>

        <div class="row">
            <div class="col-md-7">
                

<div class="cs-code-filename">
    
    <span class="d-none d-lg-inline d-xl-inline">src/main/java/com/comsysto/kitchen/duty/rest/</span><span class="d-none d-sm-inline d-lg-none d-xl-none"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/java/com/comsysto/kitchen/duty/rest/">.../</span>KitchenDutyOverviewPageResource.java
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/master/step-06-kitchen-duty-plugin/src/main/java/com/comsysto/kitchen/duty/rest/KitchenDutyOverviewPageResource.java" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="package com.comsysto.kitchen.duty.rest;

import com.atlassian.activeobjects.external.ActiveObjects;
import com.atlassian.plugins.rest.common.security.AnonymousAllowed;
import com.atlassian.sal.api.user.UserManager;
import com.comsysto.kitchen.duty.ao.KitchenDutyActiveObjectHelper;
import com.comsysto.kitchen.duty.ao.User;
import com.comsysto.kitchen.duty.ao.Week;

...
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

@Named
@Path(&quot;/overview_page&quot;)
public class KitchenDutyOverviewPageResource extends BaseResource {

    @Inject
    public KitchenDutyOverviewPageResource(ActiveObjects activeObjects,
                                           UserManager userManager) {
        this.activeObjects = activeObjects;
        this.userManager = userManager;
    }
    public KitchenDutyOverviewPageResource() { }

    @GET
    @Path(&quot;/year/{year}/month/{month}&quot;) 
    @Produces({MediaType.APPLICATION_JSON})
    @AnonymousAllowed
    public Response getUsersForWeek(@PathParam(&quot;year&quot;) final Long year,
                                    @PathParam(&quot;month&quot;) final Long month) {
        // AUTHENTICATION
        if (!this.isUserLoggedIn()) {
            return getUnauthorizedErrorResponse();
        }
        // BUSINESS LOGIC
        List&lt;KitchenDutyOverviewPageMonthDutyModel&gt; responseList = new ArrayList&lt;&gt;();
        List&lt;Long&gt; isoWeeksInMonth = getIsoWeeksOfMonth(year, month); 
        for (Long isoWeek : isoWeeksInMonth) {
            Week week = KitchenDutyActiveObjectHelper 
                         .getWeekByIsoWeekInTransaction(activeObjects, isoWeek);
            List&lt;User&gt; usersForWeek = KitchenDutyActiveObjectHelper 
                         .getUsersAssignedToWeekInTransaction(activeObjects, week);
            List&lt;String&gt; usernames = usersForWeek
                         .stream()
                         .map(user -&gt; user.getName())
                         .collect(Collectors.toList()); 
            responseList.add(new KitchenDutyOverviewPageMonthDutyModel(
                isoWeek,
                getFirstDayOfWeekOfYear(year, isoWeek).toString(), 
                getLastDayOfWeekOfYear(year, isoWeek).toString(), 
                usernames)
            );
        }

        return Response.ok(responseList).build();
    }

}"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-keyword">package</span> com.comsysto.kitchen.duty.rest;

<span class="hljs-keyword">import</span> com.atlassian.activeobjects.external.ActiveObjects;
<span class="hljs-keyword">import</span> com.atlassian.plugins.rest.common.security.AnonymousAllowed;
<span class="hljs-keyword">import</span> com.atlassian.sal.api.user.UserManager;
<span class="hljs-keyword">import</span> com.comsysto.kitchen.duty.ao.KitchenDutyActiveObjectHelper;
<span class="hljs-keyword">import</span> com.comsysto.kitchen.duty.ao.User;
<span class="hljs-keyword">import</span> com.comsysto.kitchen.duty.ao.Week;

...
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.stream.Collectors;

<span class="hljs-annotation">@Named</span>
<span class="hljs-annotation">@Path</span>(<span class="hljs-string">"/overview_page"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KitchenDutyOverviewPageResource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseResource</span> </span>{

    <span class="hljs-annotation">@Inject</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">KitchenDutyOverviewPageResource</span><span class="hljs-params">(ActiveObjects activeObjects,
                                           UserManager userManager)</span> </span>{
        <span class="hljs-keyword">this</span>.activeObjects = activeObjects;
        <span class="hljs-keyword">this</span>.userManager = userManager;
    }
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">KitchenDutyOverviewPageResource</span><span class="hljs-params">()</span> </span>{ }

    <span class="hljs-annotation">@GET</span>
    <span class="hljs-annotation">@Path</span>(<span class="hljs-string">"/year/{year}/month/{month}"</span>) <span class="cs-source-point" data-cs-source-point-id="mdsihjsdfdv8" data-cs-source-point-number="1"></span>
    <span class="hljs-annotation">@Produces</span>({MediaType.APPLICATION_JSON})
    <span class="hljs-annotation">@AnonymousAllowed</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Response <span class="hljs-title">getUsersForWeek</span><span class="hljs-params">(@PathParam(<span class="hljs-string">"year"</span>)</span> <span class="hljs-keyword">final</span> Long year,
                                    @<span class="hljs-title">PathParam</span><span class="hljs-params">(<span class="hljs-string">"month"</span>)</span> <span class="hljs-keyword">final</span> Long month) </span>{
        <span class="hljs-comment">// AUTHENTICATION</span>
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isUserLoggedIn()) {
            <span class="hljs-keyword">return</span> getUnauthorizedErrorResponse();
        }
        <span class="hljs-comment">// BUSINESS LOGIC</span>
        List&lt;KitchenDutyOverviewPageMonthDutyModel&gt; responseList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
        List&lt;Long&gt; isoWeeksInMonth = getIsoWeeksOfMonth(year, month); <span class="cs-source-point" data-cs-source-point-id="mdsihjsdfdv8" data-cs-source-point-number="2"></span>
        <span class="hljs-keyword">for</span> (Long isoWeek : isoWeeksInMonth) {
            Week week = KitchenDutyActiveObjectHelper <span class="cs-source-point" data-cs-source-point-id="mdsihjsdfdv8" data-cs-source-point-number="3"></span>
                         .getWeekByIsoWeekInTransaction(activeObjects, isoWeek);
            List&lt;User&gt; usersForWeek = KitchenDutyActiveObjectHelper <span class="cs-source-point" data-cs-source-point-id="mdsihjsdfdv8" data-cs-source-point-number="4"></span>
                         .getUsersAssignedToWeekInTransaction(activeObjects, week);
            List&lt;String&gt; usernames = usersForWeek
                         .stream()
                         .map(user -&gt; user.getName())
                         .collect(Collectors.toList()); <span class="cs-source-point" data-cs-source-point-id="mdsihjsdfdv8" data-cs-source-point-number="5"></span>
            responseList.add(<span class="hljs-keyword">new</span> KitchenDutyOverviewPageMonthDutyModel(
                isoWeek,
                getFirstDayOfWeekOfYear(year, isoWeek).toString(), <span class="cs-source-point" data-cs-source-point-id="mdsihjsdfdv8" data-cs-source-point-number="6"></span>
                getLastDayOfWeekOfYear(year, isoWeek).toString(), <span class="cs-source-point" data-cs-source-point-id="mdsihjsdfdv8" data-cs-source-point-number="7"></span>
                usernames)
            );
        }

        <span class="hljs-keyword">return</span> Response.ok(responseList).build();
    }

}</code></pre>

            </div>
            <div class="col-md-5 cs-sticky-in-parent">
                <div class="list-group cs-source-point-list" data-source-target="mdsihjsdfdv8">
                    <div class="list-group-item cs-source-point-list__item">
                        The URL should map to <code>/year/{year}/month/{month}</code>
                        so that we can query for e.g. <code>/year/2018/month/8</code>
                        and get all isoWeeks for that month. We always get 5 weeks.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Get all iso weeks in that month.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Query the database and get existing Week Object.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Get the users for that week (nullsafe = return empty list if no users found)
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Map the user objects to stringified usernames.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Now we build our event list as <code>KitchenDutyOverviewPageMonthDutyModel</code>
                        objects with isoWeek, start-date and end-date.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        <code>getFirstDayOfWeekOfYear()</code> gets you the date of the first day of the week (sunday).
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        <code>getLastDayOfWeekOfYear()</code> gets you the date of the last day of the week (saturday).
                    </div>
                </div>
            </div>
        </div>

        <p>The pojo for the week-events with start and end-date. The rest will be mapped in the JS controller.</p>

        

<div class="cs-code-filename">
    
    <span class="d-none d-lg-inline d-xl-inline">src/main/java/com/comsysto/kitchen/duty/rest/</span><span class="d-none d-sm-inline d-lg-none d-xl-none"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/java/com/comsysto/kitchen/duty/rest/">.../</span>KitchenDutyOverviewPageMonthDutyModel.java
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/master/step-06-kitchen-duty-plugin/src/main/java/com/comsysto/kitchen/duty/rest/KitchenDutyOverviewPageMonthDutyModel.java" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="package com.comsysto.kitchen.duty.rest;

import javax.xml.bind.annotation.XmlAccessType;
import javax.xml.bind.annotation.XmlAccessorType;
import javax.xml.bind.annotation.XmlElement;
import javax.xml.bind.annotation.XmlRootElement;
import java.util.List;

/*
 * We want this entity to be directly usable as full calendar event object
 * https://fullcalendar.io/docs/event-object
 */
@XmlRootElement(name = &quot;duty&quot;)
@XmlAccessorType(XmlAccessType.FIELD)
public class KitchenDutyOverviewPageMonthDutyModel {

    @XmlElement
    private Long isoWeek;

    @XmlElement
    private String start; /* Date String - First day of week (Sunday) */
    @XmlElement
    private String end; /* Date String - Last day of week (Monday) */

    @XmlElement
    private List&lt;String&gt; users;

    public KitchenDutyOverviewPageMonthDutyModel(Long isoWeek, String start, String end, List&lt;String&gt; users) {
        this.start = start;
        this.end = end;
        this.isoWeek = isoWeek;
        this.users = users;
    }

    public Long getIsoWeek() {
        return isoWeek;
    }

    public void setIsoWeek(Long isoWeek) {
        this.isoWeek = isoWeek;
    }

    public List&lt;String&gt; getUsers() {
        return users;
    }

    public void setUsers(List&lt;String&gt; users) {
        this.users = users;
    }

    public String getStart() {
        return start;
    }

    public void setStart(String start) {
        this.start = start;
    }

    public String getEnd() {
        return end;
    }

    public void setEnd(String end) {
        this.end = end;
    }
}"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-keyword">package</span> com.comsysto.kitchen.duty.rest;

<span class="hljs-keyword">import</span> javax.xml.bind.annotation.XmlAccessType;
<span class="hljs-keyword">import</span> javax.xml.bind.annotation.XmlAccessorType;
<span class="hljs-keyword">import</span> javax.xml.bind.annotation.XmlElement;
<span class="hljs-keyword">import</span> javax.xml.bind.annotation.XmlRootElement;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/*
 * We want this entity to be directly usable as full calendar event object
 * https://fullcalendar.io/docs/event-object
 */</span>
<span class="hljs-annotation">@XmlRootElement</span>(name = <span class="hljs-string">"duty"</span>)
<span class="hljs-annotation">@XmlAccessorType</span>(XmlAccessType.FIELD)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KitchenDutyOverviewPageMonthDutyModel</span> </span>{

    <span class="hljs-annotation">@XmlElement</span>
    <span class="hljs-keyword">private</span> Long isoWeek;

    <span class="hljs-annotation">@XmlElement</span>
    <span class="hljs-keyword">private</span> String start; <span class="hljs-comment">/* Date String - First day of week (Sunday) */</span>
    <span class="hljs-annotation">@XmlElement</span>
    <span class="hljs-keyword">private</span> String end; <span class="hljs-comment">/* Date String - Last day of week (Monday) */</span>

    <span class="hljs-annotation">@XmlElement</span>
    <span class="hljs-keyword">private</span> List&lt;String&gt; users;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">KitchenDutyOverviewPageMonthDutyModel</span><span class="hljs-params">(Long isoWeek, String start, String end, List&lt;String&gt; users)</span> </span>{
        <span class="hljs-keyword">this</span>.start = start;
        <span class="hljs-keyword">this</span>.end = end;
        <span class="hljs-keyword">this</span>.isoWeek = isoWeek;
        <span class="hljs-keyword">this</span>.users = users;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">getIsoWeek</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> isoWeek;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setIsoWeek</span><span class="hljs-params">(Long isoWeek)</span> </span>{
        <span class="hljs-keyword">this</span>.isoWeek = isoWeek;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title">getUsers</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> users;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUsers</span><span class="hljs-params">(List&lt;String&gt; users)</span> </span>{
        <span class="hljs-keyword">this</span>.users = users;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getStart</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> start;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setStart</span><span class="hljs-params">(String start)</span> </span>{
        <span class="hljs-keyword">this</span>.start = start;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getEnd</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> end;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setEnd</span><span class="hljs-params">(String end)</span> </span>{
        <span class="hljs-keyword">this</span>.end = end;
    }
}</code></pre>


        <p>The <strong>date calculation helpers <code>getIsoWeeksOfMonth()</code>, <code>getFirstDayOfWeekOfYear()</code> and <code>getLastDayOfWeekOfYear()</code> are defined in <code>BaseResource.java</code></strong>.</p>

        <div class="row">
            <div class="col-md-7">
                

<div class="cs-code-filename">
    
    <span class="d-none d-lg-inline d-xl-inline">src/main/java/com/comsysto/kitchen/duty/rest/</span><span class="d-none d-sm-inline d-lg-none d-xl-none"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/java/com/comsysto/kitchen/duty/rest/">.../</span>BaseResource.java
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/master/step-06-kitchen-duty-plugin/src/main/java/com/comsysto/kitchen/duty/rest/BaseResource.java" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="package com.comsysto.kitchen.duty.rest;

import java.time.LocalDate;
import java.time.temporal.ChronoField;
import java.time.temporal.WeekFields;
...

public class BaseResource {
  ...

  public static List&lt;Long&gt; getIsoWeeksOfMonth(Long year, Long month) { 
      List&lt;Long&gt; isoWeeks = new ArrayList&lt;&gt;();
      isoWeeks.add(getWeekOfMonth(year, month, 1L));
      isoWeeks.add(getWeekOfMonth(year, month, 2L));
      isoWeeks.add(getWeekOfMonth(year, month, 3L));
      isoWeeks.add(getWeekOfMonth(year, month, 4L));
      isoWeeks.add(getWeekOfMonth(year, month, 5L));
      return isoWeeks;
  }

  protected static Long getWeekOfMonth(Long year, Long month, Long weekInMonth) { 
      // https://docs.oracle.com/javase/8/docs/api/java/time/temporal/WeekFields.html
      WeekFields weekFields = WeekFields.ISO;
      return (long) LocalDate.now().with(weekFields.weekBasedYear(), year)
          .with(ChronoField.MONTH_OF_YEAR, month)
          .with(ChronoField.ALIGNED_WEEK_OF_MONTH, weekInMonth)
          .get(ChronoField.ALIGNED_WEEK_OF_YEAR);
  }

  public static LocalDate getFirstDayOfWeekOfYear(Long year, Long isoWeek) { 
      // https://docs.oracle.com/javase/8/docs/api/java/time/temporal/WeekFields.html
      WeekFields weekFields = WeekFields.ISO;
      return LocalDate.now().with(weekFields.weekBasedYear(), year)
          .with(ChronoField.ALIGNED_WEEK_OF_YEAR, isoWeek)
          .with(ChronoField.DAY_OF_WEEK, 1).minusDays(1);
  }

  public static LocalDate getLastDayOfWeekOfYear(Long year, Long isoWeek) { 
      return getFirstDayOfWeekOfYear(year, isoWeek).plusDays(6);
  }
}"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-keyword">package</span> com.comsysto.kitchen.duty.rest;

<span class="hljs-keyword">import</span> java.time.LocalDate;
<span class="hljs-keyword">import</span> java.time.temporal.ChronoField;
<span class="hljs-keyword">import</span> java.time.temporal.WeekFields;
...

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseResource</span> </span>{
  ...

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;Long&gt; <span class="hljs-title">getIsoWeeksOfMonth</span><span class="hljs-params">(Long year, Long month)</span> </span>{ <span class="cs-source-point" data-cs-source-point-id="sg4ddf" data-cs-source-point-number="1"></span>
      List&lt;Long&gt; isoWeeks = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
      isoWeeks.add(getWeekOfMonth(year, month, <span class="hljs-number">1L</span>));
      isoWeeks.add(getWeekOfMonth(year, month, <span class="hljs-number">2L</span>));
      isoWeeks.add(getWeekOfMonth(year, month, <span class="hljs-number">3L</span>));
      isoWeeks.add(getWeekOfMonth(year, month, <span class="hljs-number">4L</span>));
      isoWeeks.add(getWeekOfMonth(year, month, <span class="hljs-number">5L</span>));
      <span class="hljs-keyword">return</span> isoWeeks;
  }

  <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> Long <span class="hljs-title">getWeekOfMonth</span><span class="hljs-params">(Long year, Long month, Long weekInMonth)</span> </span>{ <span class="cs-source-point" data-cs-source-point-id="sg4ddf" data-cs-source-point-number="2"></span>
      <span class="hljs-comment">// https://docs.oracle.com/javase/8/docs/api/java/time/temporal/WeekFields.html</span>
      WeekFields weekFields = WeekFields.ISO;
      <span class="hljs-keyword">return</span> (<span class="hljs-keyword">long</span>) LocalDate.now().with(weekFields.weekBasedYear(), year)
          .with(ChronoField.MONTH_OF_YEAR, month)
          .with(ChronoField.ALIGNED_WEEK_OF_MONTH, weekInMonth)
          .get(ChronoField.ALIGNED_WEEK_OF_YEAR);
  }

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> LocalDate <span class="hljs-title">getFirstDayOfWeekOfYear</span><span class="hljs-params">(Long year, Long isoWeek)</span> </span>{ <span class="cs-source-point" data-cs-source-point-id="sg4ddf" data-cs-source-point-number="3"></span>
      <span class="hljs-comment">// https://docs.oracle.com/javase/8/docs/api/java/time/temporal/WeekFields.html</span>
      WeekFields weekFields = WeekFields.ISO;
      <span class="hljs-keyword">return</span> LocalDate.now().with(weekFields.weekBasedYear(), year)
          .with(ChronoField.ALIGNED_WEEK_OF_YEAR, isoWeek)
          .with(ChronoField.DAY_OF_WEEK, <span class="hljs-number">1</span>).minusDays(<span class="hljs-number">1</span>);
  }

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> LocalDate <span class="hljs-title">getLastDayOfWeekOfYear</span><span class="hljs-params">(Long year, Long isoWeek)</span> </span>{ <span class="cs-source-point" data-cs-source-point-id="sg4ddf" data-cs-source-point-number="4"></span>
      <span class="hljs-keyword">return</span> getFirstDayOfWeekOfYear(year, isoWeek).plusDays(<span class="hljs-number">6</span>);
  }
}</code></pre>

            </div>
            <div class="col-md-5 cs-sticky-in-parent">
                <div class="list-group cs-source-point-list" data-source-target="sg4ddf">
                    <div class="list-group-item cs-source-point-list__item">
                        <code>getIsoWeeksOfMonth()</code> returns five weeks with iso week numbers
                        for given year and month.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        <code>getWeekOfMonth()</code> returns the iso week number
                        for given year, month and weekInMonth. Ok if it sounds confusing look
                        at the Unit Test. But simply said this methods converts
                        week 1-5 of a specific month to the iso week number which represents basically the week
                        of a year.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        <code>getFirstDayOfWeekOfYear()</code> returns the first day of the week (sunday)
                        for a given year and isoWeek.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        <code>getLastDayOfWeekOfYear()</code> returns the last day of the week (saturday)
                        for a given year and isoWeek.
                    </div>
                </div>
            </div>
        </div>

        <p>The <strong>Unit Test for the date calculation helpers</strong> looks like this. Just simple asserts, nothing special.</p>

        

<div class="cs-code-filename">
    
    <span class="d-none d-lg-inline d-xl-inline">src/test/java/ut/com/comsysto/kitchen/duty/rest/</span><span class="d-none d-sm-inline d-lg-none d-xl-none"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/test/java/ut/com/comsysto/kitchen/duty/rest/">.../</span>BaseResourceTest.java
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/master/step-06-kitchen-duty-plugin/src/test/java/ut/com/comsysto/kitchen/duty/rest/BaseResourceTest.java" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="package ut.com.comsysto.kitchen.duty.rest;

import com.comsysto.kitchen.duty.rest.BaseResource;
import org.junit.Test;

import java.time.LocalDate;
import java.util.List;

import static org.junit.Assert.assertEquals;

public class BaseResourceTest {

    @Test
    public void testGetIsoWeeksOfMonth() {
        List&lt;Long&gt; isoWeeks = BaseResource.getIsoWeeksOfMonth(2018L, 8L);

        assertEquals(Long.valueOf(32), isoWeeks.get(0));
        assertEquals(Long.valueOf(33), isoWeeks.get(1));
        assertEquals(Long.valueOf(34), isoWeeks.get(2));
        assertEquals(Long.valueOf(35), isoWeeks.get(3));
        assertEquals(Long.valueOf(36), isoWeeks.get(4));

        List&lt;Long&gt; isoWeeks2 = BaseResource.getIsoWeeksOfMonth(2018L, 2L);

        assertEquals(Long.valueOf(6), isoWeeks2.get(0));
        assertEquals(Long.valueOf(7), isoWeeks2.get(1));
        assertEquals(Long.valueOf(8), isoWeeks2.get(2));
        assertEquals(Long.valueOf(9), isoWeeks2.get(3));
        assertEquals(Long.valueOf(10), isoWeeks2.get(4));

        List&lt;Long&gt; isoWeeks3 = BaseResource.getIsoWeeksOfMonth(2018L, 5L);

        assertEquals(Long.valueOf(19), isoWeeks3.get(0));
        assertEquals(Long.valueOf(20), isoWeeks3.get(1));
        assertEquals(Long.valueOf(21), isoWeeks3.get(2));
        assertEquals(Long.valueOf(22), isoWeeks3.get(3));
        assertEquals(Long.valueOf(23), isoWeeks3.get(4));
    }


    @Test
    public void testGetFirstDayOfWeekOfMonth() {
        LocalDate date = BaseResource.getFirstDayOfWeekOfYear(2018L, 32L);
        assertEquals(&quot;2018-08-05&quot;, date.toString());
    }

    @Test
    public void testGetLastDayOfWeekOfMonth() {
        LocalDate date = BaseResource.getLastDayOfWeekOfYear(2018L, 32L);
        assertEquals(&quot;2018-08-11&quot;, date.toString());
    }


}"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-keyword">package</span> ut.com.comsysto.kitchen.duty.rest;

<span class="hljs-keyword">import</span> com.comsysto.kitchen.duty.rest.BaseResource;
<span class="hljs-keyword">import</span> org.junit.Test;

<span class="hljs-keyword">import</span> java.time.LocalDate;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> org.junit.Assert.assertEquals;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseResourceTest</span> </span>{

    <span class="hljs-annotation">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGetIsoWeeksOfMonth</span><span class="hljs-params">()</span> </span>{
        List&lt;Long&gt; isoWeeks = BaseResource.getIsoWeeksOfMonth(<span class="hljs-number">2018L</span>, <span class="hljs-number">8L</span>);

        assertEquals(Long.valueOf(<span class="hljs-number">32</span>), isoWeeks.get(<span class="hljs-number">0</span>));
        assertEquals(Long.valueOf(<span class="hljs-number">33</span>), isoWeeks.get(<span class="hljs-number">1</span>));
        assertEquals(Long.valueOf(<span class="hljs-number">34</span>), isoWeeks.get(<span class="hljs-number">2</span>));
        assertEquals(Long.valueOf(<span class="hljs-number">35</span>), isoWeeks.get(<span class="hljs-number">3</span>));
        assertEquals(Long.valueOf(<span class="hljs-number">36</span>), isoWeeks.get(<span class="hljs-number">4</span>));

        List&lt;Long&gt; isoWeeks2 = BaseResource.getIsoWeeksOfMonth(<span class="hljs-number">2018L</span>, <span class="hljs-number">2L</span>);

        assertEquals(Long.valueOf(<span class="hljs-number">6</span>), isoWeeks2.get(<span class="hljs-number">0</span>));
        assertEquals(Long.valueOf(<span class="hljs-number">7</span>), isoWeeks2.get(<span class="hljs-number">1</span>));
        assertEquals(Long.valueOf(<span class="hljs-number">8</span>), isoWeeks2.get(<span class="hljs-number">2</span>));
        assertEquals(Long.valueOf(<span class="hljs-number">9</span>), isoWeeks2.get(<span class="hljs-number">3</span>));
        assertEquals(Long.valueOf(<span class="hljs-number">10</span>), isoWeeks2.get(<span class="hljs-number">4</span>));

        List&lt;Long&gt; isoWeeks3 = BaseResource.getIsoWeeksOfMonth(<span class="hljs-number">2018L</span>, <span class="hljs-number">5L</span>);

        assertEquals(Long.valueOf(<span class="hljs-number">19</span>), isoWeeks3.get(<span class="hljs-number">0</span>));
        assertEquals(Long.valueOf(<span class="hljs-number">20</span>), isoWeeks3.get(<span class="hljs-number">1</span>));
        assertEquals(Long.valueOf(<span class="hljs-number">21</span>), isoWeeks3.get(<span class="hljs-number">2</span>));
        assertEquals(Long.valueOf(<span class="hljs-number">22</span>), isoWeeks3.get(<span class="hljs-number">3</span>));
        assertEquals(Long.valueOf(<span class="hljs-number">23</span>), isoWeeks3.get(<span class="hljs-number">4</span>));
    }


    <span class="hljs-annotation">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGetFirstDayOfWeekOfMonth</span><span class="hljs-params">()</span> </span>{
        LocalDate date = BaseResource.getFirstDayOfWeekOfYear(<span class="hljs-number">2018L</span>, <span class="hljs-number">32L</span>);
        assertEquals(<span class="hljs-string">"2018-08-05"</span>, date.toString());
    }

    <span class="hljs-annotation">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testGetLastDayOfWeekOfMonth</span><span class="hljs-params">()</span> </span>{
        LocalDate date = BaseResource.getLastDayOfWeekOfYear(<span class="hljs-number">2018L</span>, <span class="hljs-number">32L</span>);
        assertEquals(<span class="hljs-string">"2018-08-11"</span>, date.toString());
    }


}</code></pre>



        <p>Ok if we now do a curl on the Endpoint it looks like this. We always get five weeks within the month (or with minor overlap).</p>


        
<div class="cs-shell">
    <div class="cs-shell__inner">
        <a class="cs-shell__copy-clipboard cs--trigger-copy-clipboard" data-clipboard-text="curl --user admin:admin http://localhost:2990/jira/rest/kitchenduty/1.0/overview_page/year/2018/month/3"
           data-toggle="tooltip" data-placement="left"
           data-title-orig="Copy file content to clipboard"
           title="Copy file content to clipboard"><i class="fa fa-files-o"></i></a>

        curl --user admin:admin http://localhost:2990/jira/rest/kitchenduty/1.0/overview_page/year/2018/month/3<br>
        <pre class="cs-shell__output"><code class="hljs cs-shell__output-hljs">[
  {
    <span class="hljs-string">"isoWeek"</span>: <span class="hljs-number">10</span>,
    <span class="hljs-string">"start"</span>: <span class="hljs-string">"2018-03-04"</span>,
    <span class="hljs-string">"end"</span>: <span class="hljs-string">"2018-03-10"</span>,
    <span class="hljs-string">"users"</span>: [ ]
  },
  {
    <span class="hljs-string">"isoWeek"</span>: <span class="hljs-number">11</span>,
    <span class="hljs-string">"start"</span>: <span class="hljs-string">"2018-03-11"</span>,
    <span class="hljs-string">"end"</span>: <span class="hljs-string">"2018-03-17"</span>,
    <span class="hljs-string">"users"</span>: [ <span class="hljs-string">"admin"</span> ]
  },
  {
    <span class="hljs-string">"isoWeek"</span>: <span class="hljs-number">12</span>,
    <span class="hljs-string">"start"</span>: <span class="hljs-string">"2018-03-18"</span>,
    <span class="hljs-string">"end"</span>: <span class="hljs-string">"2018-03-24"</span>,
    <span class="hljs-string">"users"</span>: [ ]
  },
  {
    <span class="hljs-string">"isoWeek"</span>: <span class="hljs-number">13</span>,
    <span class="hljs-string">"start"</span>: <span class="hljs-string">"2018-03-25"</span>,
    <span class="hljs-string">"end"</span>: <span class="hljs-string">"2018-03-31"</span>,
    <span class="hljs-string">"users"</span>: [ ]
  },
  {
    <span class="hljs-string">"isoWeek"</span>: <span class="hljs-number">14</span>,
    <span class="hljs-string">"start"</span>: <span class="hljs-string">"2018-04-01"</span>,
    <span class="hljs-string">"end"</span>: <span class="hljs-string">"2018-04-07"</span>,
    <span class="hljs-string">"users"</span>: [ ]
  }
]</code></pre>

    </div>
</div>



    <p>The code for our endpoint is complete now. Let's move on.</p>


    <h3 class="cs-headline cs-headline--s">Kitchen Duty Overview Page Webwork Action and WebItems</h3>

    <p>Ok now again comes the ugly XML part. We need a dedicated page that can be accessed by every logged in user to display
    the calendar. And we need a <a href="https://developer.atlassian.com/server/jira/platform/web-item/">Web Item</a> link in the top JIRA navigation bar.</p>

    
    
    
    <div class="row">
        <div class="offset-md-1 col-md-10">
            <p>
                <a href="/kitchen-duty-plugin-for-atlassian-jira/images/doc/step-06-web-item.png">
                    <img src="/kitchen-duty-plugin-for-atlassian-jira/images/doc/step-06-web-item.png" class="img-fluid" alt="Step 6 - Web Item - Link to Overview Page from navigation top bar"
                         data-bilderrahmen="gallery-01"
                         data-bilderrahmen-title="Step 6 - Web Item - Link to Overview Page from navigation top bar"
                    >
                </a>
            </p>
        </div>
    </div>


    <p>Also we want to link to the Overview Page from the Planning Page to make navigating easy.</p>

    
    
    
    <div class="row">
        <div class="offset-md-1 col-md-10">
            <p>
                <a href="/kitchen-duty-plugin-for-atlassian-jira/images/doc/step-06-planning-page-link-to-overview.png">
                    <img src="/kitchen-duty-plugin-for-atlassian-jira/images/doc/step-06-planning-page-link-to-overview.png" class="img-fluid" alt="Step 6 - Web Item - Link to Overview Page from Planning Page"
                         data-bilderrahmen="gallery-01"
                         data-bilderrahmen-title="Step 6 - Web Item - Link to Overview Page from Planning Page"
                    >
                </a>
            </p>
        </div>
    </div>



    <div class="row">
        <div class="col-md-7">
            

<div class="cs-code-filename">
    
    <span class="d-none d-lg-inline d-xl-inline">src/main/resources/</span><span class="d-none d-sm-inline d-lg-none d-xl-none"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/resources/">.../</span>atlassian-plugin.xml
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/master/step-06-kitchen-duty-plugin/src/main/resources/atlassian-plugin.xml" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="&lt;atlassian-plugin key=&quot;${atlassian.plugin.key}&quot; name=&quot;${project.name}&quot; plugins-version=&quot;2&quot;&gt;
  ...
  &lt;web-item key=&quot;admin_kitchen_duty_overview_webitem&quot;  
       name=&quot;admin_kitchen_duty_overview_webitem&quot;
       section=&quot;admin_plugins_menu/admin_kitchen_duty_planning_section&quot;
       weight=&quot;14&quot; i18n-name-key=&quot;kitchen-duty-plugin.admin.overview.page.web.item.name&quot;&gt;
     &lt;label key=&quot;kitchen-duty-plugin.admin.overview.page.web.item.name&quot;/&gt;
     &lt;link linkId=&quot;admin_kitchen_duty_overview_webitem_link&quot;&gt;/secure/KitchenDutyOverviewPageWebworkAction.jspa&lt;/link&gt;
  &lt;/web-item&gt;
  ...
  &lt;!-- ====================== --&gt;
  &lt;!-- OVERVIEW PAGE --&gt;
  &lt;!-- ====================== --&gt;
  &lt;web-resource key=&quot;kitchen-duty-plugin-resources--overview-page&quot; 
       name=&quot;kitchen-duty-plugin Web Resources for Overview Page&quot;&gt;
    &lt;dependency&gt;com.atlassian.auiplugin:ajs&lt;/dependency&gt;
    &lt;dependency&gt;com.atlassian.auiplugin:aui-experimental-soy-templates&lt;/dependency&gt;
    &lt;transformation extension=&quot;soy&quot;&gt;
      &lt;transformer key=&quot;soyTransformer&quot;&gt;
        &lt;functions&gt;com.atlassian.confluence.plugins.soy:soy-core-functions&lt;/functions&gt;
      &lt;/transformer&gt;
    &lt;/transformation&gt;
    &lt;resource type=&quot;download&quot; name=&quot;momentjs.js&quot;
              location=&quot;/js/3rdparty/moment-2.22.2.min.js&quot;/&gt;   
    &lt;resource type=&quot;download&quot; name=&quot;fullcalendar.js&quot;
              location=&quot;/js/3rdparty/fullcalendar-3.9.0.min.js&quot;/&gt;   
    &lt;resource type=&quot;download&quot; name=&quot;fullcalendar.css&quot;
              location=&quot;/css/3rdparty/fullcalendar-3.9.0.min.css&quot;/&gt;   
    &lt;resource type=&quot;download&quot; name=&quot;kitchen-duty-overview-soy.js&quot;
              location=&quot;templates-soy/kitchen-duty-overview.soy&quot;/&gt;     
    &lt;resource type=&quot;download&quot; name=&quot;kitchen-duty-plugin--overview-page-controller.js&quot;
              location=&quot;/js/kitchen-duty-plugin--overview-page-controller.js&quot;/&gt;   
    &lt;context&gt;kitchen-duty-plugin&lt;/context&gt;
  &lt;/web-resource&gt;
  &lt;webwork1 key=&quot;kitchen-duty-overview-page-webwork-module&quot;
            name=&quot;Kitchen Duty Overview Page Webwork Module&quot;
            i18n-name-key=&quot;kitchen-duty-overview-page-webwork-module.name&quot;
            roles-required=&quot;use&quot;&gt;  
    &lt;description
      key=&quot;kitchen-duty-overview-page-webwork-module.description&quot;
    &gt;The Kitchen Duty Overview Page Webwork Module Plugin&lt;/description&gt;
    &lt;actions&gt;
      &lt;action name=&quot;com.comsysto.kitchen.duty.webwork.KitchenDutyOverviewPageWebworkAction&quot;
              alias=&quot;KitchenDutyOverviewPageWebworkAction&quot;&gt; 
        &lt;view
          name=&quot;kitchen-duty-overview-page-success&quot; 
        &gt;/templates/kitchen-duty-overview-page-webwork-module/kitchen-duty-overview-page-success.vm&lt;/view&gt;
      &lt;/action&gt;
    &lt;/actions&gt;
  &lt;/webwork1&gt;
  &lt;web-item key=&quot;user_kitchen_duty_overview_webitem&quot; 
            name=&quot;user_kitchen_duty_overview_webitem&quot;
            section=&quot;system.top.navigation.bar&quot;
            weight=&quot;60&quot;
            i18n-name-key=&quot;kitchen-duty-plugin.user.overview.page.web.item.name&quot;&gt;
    &lt;label key=&quot;kitchen-duty-plugin.user.overview.page.web.item.name&quot;/&gt;
    &lt;link
      linkId=&quot;user_kitchen_duty_overview_webitem_link&quot;
    &gt;/secure/KitchenDutyOverviewPageWebworkAction.jspa&lt;/link&gt;
  &lt;/web-item&gt;
  ...
&lt;/atlassian-plugin&gt;"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-tag">&lt;<span class="hljs-title">atlassian-plugin</span> <span class="hljs-attribute">key</span>=<span class="hljs-value">"${atlassian.plugin.key}"</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"${project.name}"</span> <span class="hljs-attribute">plugins-version</span>=<span class="hljs-value">"2"</span>&gt;</span>
  ...
  <span class="hljs-tag">&lt;<span class="hljs-title">web-item</span> <span class="hljs-attribute">key</span>=<span class="hljs-value">"admin_kitchen_duty_overview_webitem"</span>  <span class="cs-source-point" data-cs-source-point-id="knjbihvutzczdgui" data-cs-source-point-number="1"></span>
       <span class="hljs-attribute">name</span>=<span class="hljs-value">"admin_kitchen_duty_overview_webitem"</span>
       <span class="hljs-attribute">section</span>=<span class="hljs-value">"admin_plugins_menu/admin_kitchen_duty_planning_section"</span>
       <span class="hljs-attribute">weight</span>=<span class="hljs-value">"14"</span> <span class="hljs-attribute">i18n-name-key</span>=<span class="hljs-value">"kitchen-duty-plugin.admin.overview.page.web.item.name"</span>&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-title">label</span> <span class="hljs-attribute">key</span>=<span class="hljs-value">"kitchen-duty-plugin.admin.overview.page.web.item.name"</span>/&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-title">link</span> <span class="hljs-attribute">linkId</span>=<span class="hljs-value">"admin_kitchen_duty_overview_webitem_link"</span>&gt;</span>/secure/KitchenDutyOverviewPageWebworkAction.jspa<span class="hljs-tag">&lt;/<span class="hljs-title">link</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">web-item</span>&gt;</span>
  ...
  <span class="hljs-comment">&lt;!-- ====================== --&gt;</span>
  <span class="hljs-comment">&lt;!-- OVERVIEW PAGE --&gt;</span>
  <span class="hljs-comment">&lt;!-- ====================== --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">web-resource</span> <span class="hljs-attribute">key</span>=<span class="hljs-value">"kitchen-duty-plugin-resources--overview-page"</span> <span class="cs-source-point" data-cs-source-point-id="knjbihvutzczdgui" data-cs-source-point-number="2"></span>
       <span class="hljs-attribute">name</span>=<span class="hljs-value">"kitchen-duty-plugin Web Resources for Overview Page"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span>com.atlassian.auiplugin:ajs<span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span>com.atlassian.auiplugin:aui-experimental-soy-templates<span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">transformation</span> <span class="hljs-attribute">extension</span>=<span class="hljs-value">"soy"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">transformer</span> <span class="hljs-attribute">key</span>=<span class="hljs-value">"soyTransformer"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">functions</span>&gt;</span>com.atlassian.confluence.plugins.soy:soy-core-functions<span class="hljs-tag">&lt;/<span class="hljs-title">functions</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-title">transformer</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">transformation</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">resource</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"download"</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"momentjs.js"</span>
              <span class="hljs-attribute">location</span>=<span class="hljs-value">"/js/3rdparty/moment-2.22.2.min.js"</span>/&gt;</span>   <span class="cs-source-point" data-cs-source-point-id="knjbihvutzczdgui" data-cs-source-point-number="3"></span>
    <span class="hljs-tag">&lt;<span class="hljs-title">resource</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"download"</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"fullcalendar.js"</span>
              <span class="hljs-attribute">location</span>=<span class="hljs-value">"/js/3rdparty/fullcalendar-3.9.0.min.js"</span>/&gt;</span>   <span class="cs-source-point" data-cs-source-point-id="knjbihvutzczdgui" data-cs-source-point-number="4"></span>
    <span class="hljs-tag">&lt;<span class="hljs-title">resource</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"download"</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"fullcalendar.css"</span>
              <span class="hljs-attribute">location</span>=<span class="hljs-value">"/css/3rdparty/fullcalendar-3.9.0.min.css"</span>/&gt;</span>   <span class="cs-source-point" data-cs-source-point-id="knjbihvutzczdgui" data-cs-source-point-number="5"></span>
    <span class="hljs-tag">&lt;<span class="hljs-title">resource</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"download"</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"kitchen-duty-overview-soy.js"</span>
              <span class="hljs-attribute">location</span>=<span class="hljs-value">"templates-soy/kitchen-duty-overview.soy"</span>/&gt;</span>     <span class="cs-source-point" data-cs-source-point-id="knjbihvutzczdgui" data-cs-source-point-number="6"></span>
    <span class="hljs-tag">&lt;<span class="hljs-title">resource</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"download"</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"kitchen-duty-plugin--overview-page-controller.js"</span>
              <span class="hljs-attribute">location</span>=<span class="hljs-value">"/js/kitchen-duty-plugin--overview-page-controller.js"</span>/&gt;</span>   <span class="cs-source-point" data-cs-source-point-id="knjbihvutzczdgui" data-cs-source-point-number="7"></span>
    <span class="hljs-tag">&lt;<span class="hljs-title">context</span>&gt;</span>kitchen-duty-plugin<span class="hljs-tag">&lt;/<span class="hljs-title">context</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">web-resource</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">webwork1</span> <span class="hljs-attribute">key</span>=<span class="hljs-value">"kitchen-duty-overview-page-webwork-module"</span>
            <span class="hljs-attribute">name</span>=<span class="hljs-value">"Kitchen Duty Overview Page Webwork Module"</span>
            <span class="hljs-attribute">i18n-name-key</span>=<span class="hljs-value">"kitchen-duty-overview-page-webwork-module.name"</span>
            <span class="hljs-attribute">roles-required</span>=<span class="hljs-value">"use"</span>&gt;</span>  <span class="cs-source-point" data-cs-source-point-id="knjbihvutzczdgui" data-cs-source-point-number="8"></span>
    <span class="hljs-tag">&lt;<span class="hljs-title">description</span>
      <span class="hljs-attribute">key</span>=<span class="hljs-value">"kitchen-duty-overview-page-webwork-module.description"</span>
    &gt;</span>The Kitchen Duty Overview Page Webwork Module Plugin<span class="hljs-tag">&lt;/<span class="hljs-title">description</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">actions</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">action</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"com.comsysto.kitchen.duty.webwork.KitchenDutyOverviewPageWebworkAction"</span>
              <span class="hljs-attribute">alias</span>=<span class="hljs-value">"KitchenDutyOverviewPageWebworkAction"</span>&gt;</span> <span class="cs-source-point" data-cs-source-point-id="knjbihvutzczdgui" data-cs-source-point-number="9"></span>
        <span class="hljs-tag">&lt;<span class="hljs-title">view</span>
          <span class="hljs-attribute">name</span>=<span class="hljs-value">"kitchen-duty-overview-page-success"</span> <span class="cs-source-point" data-cs-source-point-id="knjbihvutzczdgui" data-cs-source-point-number="10"></span>
        &gt;</span>/templates/kitchen-duty-overview-page-webwork-module/kitchen-duty-overview-page-success.vm<span class="hljs-tag">&lt;/<span class="hljs-title">view</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-title">action</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">actions</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">webwork1</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">web-item</span> <span class="hljs-attribute">key</span>=<span class="hljs-value">"user_kitchen_duty_overview_webitem"</span> <span class="cs-source-point" data-cs-source-point-id="knjbihvutzczdgui" data-cs-source-point-number="11"></span>
            <span class="hljs-attribute">name</span>=<span class="hljs-value">"user_kitchen_duty_overview_webitem"</span>
            <span class="hljs-attribute">section</span>=<span class="hljs-value">"system.top.navigation.bar"</span>
            <span class="hljs-attribute">weight</span>=<span class="hljs-value">"60"</span>
            <span class="hljs-attribute">i18n-name-key</span>=<span class="hljs-value">"kitchen-duty-plugin.user.overview.page.web.item.name"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">label</span> <span class="hljs-attribute">key</span>=<span class="hljs-value">"kitchen-duty-plugin.user.overview.page.web.item.name"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">link</span>
      <span class="hljs-attribute">linkId</span>=<span class="hljs-value">"user_kitchen_duty_overview_webitem_link"</span>
    &gt;</span>/secure/KitchenDutyOverviewPageWebworkAction.jspa<span class="hljs-tag">&lt;/<span class="hljs-title">link</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">web-item</span>&gt;</span>
  ...
<span class="hljs-tag">&lt;/<span class="hljs-title">atlassian-plugin</span>&gt;</span></code></pre>

            </div>
            <div class="col-md-5 cs-sticky-in-parent">
                <div class="list-group cs-source-point-list" data-source-target="knjbihvutzczdgui">
                    <div class="list-group-item cs-source-point-list__item">
                        First we need a link to the Overview Page from the side navigation when we are on the Planning Page.
                        You can see it in the screenshot above.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        We define a dedicated web-resource section to provide CSS, JS and Soy resources for the Overview Page.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        We reuse the moment-js library we already used on the planning page since the full calendar library depends on moment-js.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Next we put a copy of fullcalendar.min.js to <code>src/main/resources/js/3rdparty</code>.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        The full calendar also needs a copy of fullcalendar.min.css to <code>src/main/resources/css/3rdparty</code>.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        For the Overview Page we also define a dedicated soy template in <code>src/main/resources/templates-soy/kitchen-duty-overview.soy</code>.
                        We will create the file later in full detail.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        The Overview Page has its own JS-controller in <code>src/main/resources/js/kitchen-duty-plugin--overview-page-controller.js</code>.
                        We will create the file later in full detail.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        The actual page is defined as a web work module. The <code>roles-required="use"</code> ensures only logged in users
                        can view the page.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        The module contains the actual action to the <code>KitchenDutyOverviewPageWebworkAction.java</code>.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        As usual we define a velocity template for our web work action in <code>src/main/resources/templates/kitchen-duty-overview-page-webwork-module/kitchen-duty-overview-page-success.vm</code>.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Lastly we define a web-item with the link to the Overview Page in the JIRA top navigation bar.
                    </div>
                </div>
            </div>
        </div>

        <p>All these xml things have <strong>i18n keys which we need to put in our translation file</strong>. Keep in mind that encoding for property files is ISO 8859-1.</p>

        

<div class="cs-code-filename">
    
    <span class="d-none d-lg-inline d-xl-inline">src/main/resources/</span><span class="d-none d-sm-inline d-lg-none d-xl-none"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/resources/">.../</span>kitchen-duty-plugin.properties
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/master/step-06-kitchen-duty-plugin/src/main/resources/kitchen-duty-plugin.properties" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="# admin
kitchen-duty-plugin.admin.overview.page.web.item.name = Overview Page

# kitchen-duty-overview-page-success.vm
kitchen-duty-plugin.user.overview.page.title = Kitchen Duty Plugin - Overview Page

# webitem
kitchen-duty-plugin.user.overview.page.web.item.name = Kitchen Duty"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"># admin
kitchen-duty-plugin.admin.overview.page.web.item.name = Overview Page

# kitchen-duty-overview-page-success.vm
kitchen-duty-plugin.user.overview.page.title = Kitchen Duty Plugin - Overview Page

# webitem
kitchen-duty-plugin.user.overview.page.web.item.name = Kitchen Duty</code></pre>


        <p>Now we define our <strong>web work action</strong> that displays the velocity template and loads the overview page resources.</p>

        

<div class="cs-code-filename">
    
    <span class="d-none d-lg-inline d-xl-inline">src/main/java/com/comsysto/kitchen/duty/webwork/</span><span class="d-none d-sm-inline d-lg-none d-xl-none"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/java/com/comsysto/kitchen/duty/webwork/">.../</span>KitchenDutyOverviewPageWebworkAction.java
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/master/step-06-kitchen-duty-plugin/src/main/java/com/comsysto/kitchen/duty/webwork/KitchenDutyOverviewPageWebworkAction.java" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="package com.comsysto.kitchen.duty.webwork;

import com.atlassian.jira.web.action.JiraWebActionSupport;
import com.atlassian.webresource.api.assembler.PageBuilderService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.inject.Inject;
import javax.inject.Named;

@Named
public class KitchenDutyOverviewPageWebworkAction extends JiraWebActionSupport
{
    private static final Logger log = LoggerFactory.getLogger(KitchenDutyOverviewPageWebworkAction.class);

    @Inject
    private PageBuilderService pageBuilderService;

    @Override
    public String execute() throws Exception {
        pageBuilderService.assembler().resources()
            .requireWebResource(&quot;com.comsysto.kitchen-duty-plugin:kitchen-duty-plugin-resources&quot;)
            .requireWebResource(&quot;com.comsysto.kitchen-duty-plugin:kitchen-duty-plugin-resources--overview-page&quot;);

        return &quot;kitchen-duty-overview-page-success&quot;;
    }

    public void setPageBuilderService(PageBuilderService pageBuilderService) {
        this.pageBuilderService = pageBuilderService;
    }
}"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-keyword">package</span> com.comsysto.kitchen.duty.webwork;

<span class="hljs-keyword">import</span> com.atlassian.jira.web.action.JiraWebActionSupport;
<span class="hljs-keyword">import</span> com.atlassian.webresource.api.assembler.PageBuilderService;
<span class="hljs-keyword">import</span> org.slf4j.Logger;
<span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;

<span class="hljs-keyword">import</span> javax.inject.Inject;
<span class="hljs-keyword">import</span> javax.inject.Named;

<span class="hljs-annotation">@Named</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KitchenDutyOverviewPageWebworkAction</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">JiraWebActionSupport</span>
</span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Logger log = LoggerFactory.getLogger(KitchenDutyOverviewPageWebworkAction.class);

    <span class="hljs-annotation">@Inject</span>
    <span class="hljs-keyword">private</span> PageBuilderService pageBuilderService;

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">execute</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
        pageBuilderService.assembler().resources()
            .requireWebResource(<span class="hljs-string">"com.comsysto.kitchen-duty-plugin:kitchen-duty-plugin-resources"</span>)
            .requireWebResource(<span class="hljs-string">"com.comsysto.kitchen-duty-plugin:kitchen-duty-plugin-resources--overview-page"</span>);

        <span class="hljs-keyword">return</span> <span class="hljs-string">"kitchen-duty-overview-page-success"</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setPageBuilderService</span><span class="hljs-params">(PageBuilderService pageBuilderService)</span> </span>{
        <span class="hljs-keyword">this</span>.pageBuilderService = pageBuilderService;
    }
}</code></pre>


        <p>
            Let's also create the <strong>velocity success template</strong> now.
            On non-admin pages you have to define the <a href="https://docs.atlassian.com/aui/7.9.5/docs/navigation.html">Navigation</a> by yourself.
            Also read the doc about <a href="https://docs.atlassian.com/aui/7.9.5/docs/page.html">Page</a>.
            We simply define a div with id <code>kdp-overview-page-container</code> to hook in with our JS-controller.
        </p>

        

<div class="cs-code-filename">
    
    <span class="d-none d-lg-inline d-xl-inline">src/main/resources/templates/kitchen-duty-overview-page-webwork-module/</span><span class="d-none d-sm-inline d-lg-none d-xl-none"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/resources/templates/kitchen-duty-overview-page-webwork-module/">.../</span>kitchen-duty-overview-page-success.vm
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/master/step-06-kitchen-duty-plugin/src/main/resources/templates/kitchen-duty-overview-page-webwork-module/kitchen-duty-overview-page-success.vm" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;$i18n.getText(&quot;kitchen-duty-plugin.user.overview.page.title&quot;)&lt;/title&gt;
    &lt;meta name=&quot;decorator&quot; content=&quot;atl.general&quot;/&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div id=&quot;page&quot;&gt;
    &lt;section id=&quot;content&quot; role=&quot;main&quot;&gt;

        &lt;header class=&quot;aui-page-header&quot;&gt;
            &lt;div class=&quot;aui-page-header-inner&quot;&gt;
                &lt;div class=&quot;aui-page-header-main&quot;&gt;
                    &lt;h1&gt;Kitchen Duty&lt;/h1&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/header&gt;

        &lt;div class=&quot;aui-page-panel&quot;&gt;
            &lt;div class=&quot;aui-page-panel-inner&quot;&gt;
                &lt;div class=&quot;aui-page-panel-nav&quot;&gt;
                    &lt;nav class=&quot;aui-navgroup aui-navgroup-vertical&quot;&gt;
                        &lt;div class=&quot;aui-navgroup-inner&quot;&gt;
                            &lt;ul class=&quot;aui-nav&quot;&gt;
                                &lt;li class=&quot;aui-nav-selected&quot;&gt;&lt;a href=&quot;${req.contextPath}/secure/KitchenDutyOverviewPageWebworkAction.jspa&quot;&gt;Overview Page&lt;/a&gt;&lt;/li&gt;
                                &lt;li&gt;&lt;a href=&quot;${req.contextPath}/secure/KitchenDutyPlanningWebworkAction.jspa&quot;&gt;Planning Page&lt;/a&gt;&lt;/li&gt;
                            &lt;/ul&gt;
                        &lt;/div&gt;
                    &lt;/nav&gt;
                &lt;/div&gt;
                &lt;section class=&quot;aui-page-panel-content&quot;&gt;
                    &lt;div id=&quot;kdp-overview-page-container&quot;&gt;&lt;/div&gt;
                &lt;/section&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/section&gt;
&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-tag">&lt;<span class="hljs-title">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">title</span>&gt;</span>$i18n.getText("kitchen-duty-plugin.user.overview.page.title")<span class="hljs-tag">&lt;/<span class="hljs-title">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"decorator"</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">"atl.general"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"page"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">section</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"content"</span> <span class="hljs-attribute">role</span>=<span class="hljs-value">"main"</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-title">header</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"aui-page-header"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"aui-page-header-inner"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"aui-page-header-main"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">h1</span>&gt;</span>Kitchen Duty<span class="hljs-tag">&lt;/<span class="hljs-title">h1</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">header</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"aui-page-panel"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"aui-page-panel-inner"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"aui-page-panel-nav"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">nav</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"aui-navgroup aui-navgroup-vertical"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"aui-navgroup-inner"</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-title">ul</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"aui-nav"</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-title">li</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"aui-nav-selected"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-title">a</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"${req.contextPath}/secure/KitchenDutyOverviewPageWebworkAction.jspa"</span>&gt;</span>Overview Page<span class="hljs-tag">&lt;/<span class="hljs-title">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">li</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-title">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-title">a</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"${req.contextPath}/secure/KitchenDutyPlanningWebworkAction.jspa"</span>&gt;</span>Planning Page<span class="hljs-tag">&lt;/<span class="hljs-title">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">li</span>&gt;</span>
                            <span class="hljs-tag">&lt;/<span class="hljs-title">ul</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-title">nav</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">section</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"aui-page-panel-content"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"kdp-overview-page-container"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-title">section</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">section</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span></code></pre>


    <p>When clicking on 'Kitchen Duty' in the JIRA top bar now it should look like this.</p>

    
    
    
    <div class="row">
        <div class="offset-md-1 col-md-10">
            <p>
                <a href="/kitchen-duty-plugin-for-atlassian-jira/images/doc/step-06-overview-page-velocity.png">
                    <img src="/kitchen-duty-plugin-for-atlassian-jira/images/doc/step-06-overview-page-velocity.png" class="img-fluid" alt="Step 6 - Velocity and Web work action - Overview Page"
                         data-bilderrahmen="gallery-01"
                         data-bilderrahmen-title="Step 6 - Velocity and Web work action - Overview Page"
                    >
                </a>
            </p>
        </div>
    </div>


    <p>Ok that was now the server-side part of the overview page. Let's move on to the client-side.</p>





    <h3 class="cs-headline cs-headline--s">Kitchen Duty Overview Page JS Controller and Soy Templates</h3>

    <p>As we already did it on the planning page, we again have a JS-controller using soy-templates
    and some logic to display the <a href="https://fullcalendar.io/">full calendar</a> with data from REST Endpoints on the page.</p>

    <p>Ok to be honest we could just skip using the soy template here since we do not really need it right now.
        But it is always good to follow common conventions for building our pages, so that we can easily extend them in the future.</p>




        

<div class="cs-code-filename">
    
    <span class="d-none d-lg-inline d-xl-inline">src/main/resources/templates-soy/</span><span class="d-none d-sm-inline d-lg-none d-xl-none"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/resources/templates-soy/">.../</span>kitchen-duty-overview.soy
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/master/step-06-kitchen-duty-plugin/src/main/resources/templates-soy/kitchen-duty-overview.soy" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="{namespace JIRA.Templates.KDPO}
/**
 * Kitchen Duty Overview Page - Base Template
 */
{template .overviewPage}
    &lt;div id=&quot;kdp-overview&quot;&gt;
        &lt;div id=&quot;kdp-calendar&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;
{/template}"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-soyTag">{<span class="hljs-title"><span class="hljs-tag">namespace</span> JIRA.Templates.KDPO</span>}</span>
<span class="hljs-comment">/**
 * Kitchen Duty Overview Page - Base Template
 */</span>
<span class="hljs-soyTag">{<span class="hljs-title"><span class="hljs-tag">template</span> .overviewPage</span>}</span>
    &lt;div id=<span class="hljs-string">"kdp-overview"</span>&gt;
        &lt;div id=<span class="hljs-string">"kdp-calendar"</span>&gt;&lt;/div&gt;
    &lt;/div&gt;
<span class="hljs-soyTag">{/<span class="hljs-tag">template</span>}</span></code></pre>


        <p>Now comes the actual <strong>controller logic to display the calendar with kitchen duty data from the REST API</strong>.</p>

        <div class="row">
            <div class="col-md-7">
                

<div class="cs-code-filename">
    
    <span class="d-none d-lg-inline d-xl-inline">src/main/resources/js/</span><span class="d-none d-sm-inline d-lg-none d-xl-none"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/resources/js/">.../</span>kitchen-duty-plugin--overview-page-controller.js
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/master/step-06-kitchen-duty-plugin/src/main/resources/js/kitchen-duty-plugin--overview-page-controller.js" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="AJS.toInit(function(){
    AJS.log(&#39;KDP: Overview Page Controller initializing ...&#39;);
    var baseUrl = AJS.params.baseURL;
    var restUrl = baseUrl + &#39;/rest/kitchenduty/1.0&#39;;
    window.KDPrestUrl = restUrl;

    // Init Base SOY template
    var overviewPageTemplate = JIRA.Templates.KDPO.overviewPage(); 
    AJS.$(&#39;#kdp-overview-page-container&#39;).html(overviewPageTemplate);

    AJS.$(&#39;#kdp-calendar&#39;).fullCalendar({ 
        defaultView: &#39;month&#39;, 
        weekNumbers: true, 
        height: 500,
        fixedWeekCount: false,
        events: function(start, end, timezone, callback) { 
            // Full calendar always starts month with days of previous month.
            // We add 10 days to get month we want.
            var year = moment(start).add(&#39;days&#39;, 10).format(&#39;YYYY&#39;); 
            var month = moment(start).add(&#39;days&#39;, 10).format(&#39;M&#39;); 
            AJS.$.ajax({ 
                url: window.KDPrestUrl + &#39;/overview_page/year/&#39; + year + &#39;/month/&#39; + month,
                dataType: &#39;json&#39;,
                success: function(rawEvents) {
                    var events = [];
                    AJS.$(rawEvents).each(function() { 
                        var users = AJS.$(this).attr(&#39;users&#39;);
                        events.push({
                            title: users.join(&#39;, &#39;), 
                            start: AJS.$(this).attr(&#39;start&#39;),
                            end: AJS.$(this).attr(&#39;end&#39;),
                            color: users.length &gt; 0 ? &#39;#36B37E&#39; : &#39;#FFAB00&#39;, 
                        });
                    });
                    callback(events);
                }
            });
        }
    });
});"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs">AJS.toInit(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
    AJS.log(<span class="hljs-string">'KDP: Overview Page Controller initializing ...'</span>);
    <span class="hljs-keyword">var</span> baseUrl = AJS.params.baseURL;
    <span class="hljs-keyword">var</span> restUrl = baseUrl + <span class="hljs-string">'/rest/kitchenduty/1.0'</span>;
    <span class="hljs-built_in">window</span>.KDPrestUrl = restUrl;

    <span class="hljs-comment">// Init Base SOY template</span>
    <span class="hljs-keyword">var</span> overviewPageTemplate = JIRA.Templates.KDPO.overviewPage(); <span class="cs-source-point" data-cs-source-point-id="bhvgcfrd546857io8giubhvgj" data-cs-source-point-number="1"></span>
    AJS.$(<span class="hljs-string">'#kdp-overview-page-container'</span>).html(overviewPageTemplate);

    AJS.$(<span class="hljs-string">'#kdp-calendar'</span>).fullCalendar({ <span class="cs-source-point" data-cs-source-point-id="bhvgcfrd546857io8giubhvgj" data-cs-source-point-number="2"></span>
        defaultView: <span class="hljs-string">'month'</span>, <span class="cs-source-point" data-cs-source-point-id="bhvgcfrd546857io8giubhvgj" data-cs-source-point-number="3"></span>
        weekNumbers: <span class="hljs-literal">true</span>, <span class="cs-source-point" data-cs-source-point-id="bhvgcfrd546857io8giubhvgj" data-cs-source-point-number="4"></span>
        height: <span class="hljs-number">500</span>,
        fixedWeekCount: <span class="hljs-literal">false</span>,
        events: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">start, end, timezone, callback</span>) </span>{ <span class="cs-source-point" data-cs-source-point-id="bhvgcfrd546857io8giubhvgj" data-cs-source-point-number="5"></span>
            <span class="hljs-comment">// Full calendar always starts month with days of previous month.</span>
            <span class="hljs-comment">// We add 10 days to get month we want.</span>
            <span class="hljs-keyword">var</span> year = moment(start).add(<span class="hljs-string">'days'</span>, <span class="hljs-number">10</span>).format(<span class="hljs-string">'YYYY'</span>); <span class="cs-source-point" data-cs-source-point-id="bhvgcfrd546857io8giubhvgj" data-cs-source-point-number="6"></span>
            <span class="hljs-keyword">var</span> month = moment(start).add(<span class="hljs-string">'days'</span>, <span class="hljs-number">10</span>).format(<span class="hljs-string">'M'</span>); <span class="cs-source-point" data-cs-source-point-id="bhvgcfrd546857io8giubhvgj" data-cs-source-point-number="7"></span>
            AJS.$.ajax({ <span class="cs-source-point" data-cs-source-point-id="bhvgcfrd546857io8giubhvgj" data-cs-source-point-number="8"></span>
                url: <span class="hljs-built_in">window</span>.KDPrestUrl + <span class="hljs-string">'/overview_page/year/'</span> + year + <span class="hljs-string">'/month/'</span> + month,
                dataType: <span class="hljs-string">'json'</span>,
                success: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">rawEvents</span>) </span>{
                    <span class="hljs-keyword">var</span> events = [];
                    AJS.$(rawEvents).each(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="cs-source-point" data-cs-source-point-id="bhvgcfrd546857io8giubhvgj" data-cs-source-point-number="9"></span>
                        <span class="hljs-keyword">var</span> users = AJS.$(<span class="hljs-keyword">this</span>).attr(<span class="hljs-string">'users'</span>);
                        events.push({
                            title: users.join(<span class="hljs-string">', '</span>), <span class="cs-source-point" data-cs-source-point-id="bhvgcfrd546857io8giubhvgj" data-cs-source-point-number="10"></span>
                            start: AJS.$(<span class="hljs-keyword">this</span>).attr(<span class="hljs-string">'start'</span>),
                            end: AJS.$(<span class="hljs-keyword">this</span>).attr(<span class="hljs-string">'end'</span>),
                            color: users.length &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">'#36B37E'</span> : <span class="hljs-string">'#FFAB00'</span>, <span class="cs-source-point" data-cs-source-point-id="bhvgcfrd546857io8giubhvgj" data-cs-source-point-number="11"></span>
                        });
                    });
                    callback(events);
                }
            });
        }
    });
});</code></pre>

            </div>
            <div class="col-md-5 cs-sticky-in-parent">
                <div class="list-group cs-source-point-list" data-source-target="bhvgcfrd546857io8giubhvgj">
                    <div class="list-group-item cs-source-point-list__item">
                        Load the overviewPage soy template and inject it into the DOM.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Initialize the <a href="https://fullcalendar.io/">full calendar</a> in the div with id <code>kdp-calendar</code>.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        We set the <a href="https://fullcalendar.io/docs/month-view"><code>defaultView</code> to month</a>.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        We also want the <a href="https://fullcalendar.io/docs/week-numbers">week numbers displayed</a>.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Via the <a href="https://fullcalendar.io/docs/events-function">Events Function</a>
                        we fill the calendar with our kitchen duty 'events' representing each week.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        The <code>start</code> variable contains the start date of the calendar view.
                        Since we are in the month view the start date is usually some day of the previous month
                        therefore we add 10 days to get a date within the current month. Via moment-js we get the year.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        We do the same to get the current month displayed in the calendar.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Via ajax GET request we call our <code>/overview_page/year/:year/month/:month</code>
                        REST Endpoint with the month and year we get from the calendar api.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        We iterate over the <code>rawEvents</code> which are in the form of
                        <code>[ { "isoWeek": 10, "start": "2018-03-04", "end": "2018-03-10", "users": [ "bob", "steve" ] } ]</code>.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        Since we need to build <a href="https://fullcalendar.io/docs/event-object">full calendar event objects</a>
                        in form of
                        <code>[ { "start": "2018-03-04", "end": "2018-03-10", "title": "bob, steve", "color": "#ff0000" } ]</code>
                        we map our values. As <code>title</code> we concatenate the users into one string.
                    </div>
                    <div class="list-group-item cs-source-point-list__item">
                        As <code>color</code> we display green (#36B37E) if the week has assigned users.
                        And we display orange (#FFAB00) if no users are assigned to week.
                    </div>
                </div>
            </div>
        </div>


        <p>&nbsp;</p>

        <p>Lastly - since we might use the code to display <a href="https://docs.atlassian.com/aui/7.9.5/docs/flag.html">AUI Flags</a> in both controllers - <strong>we move the common code to <code>kitchen-duty-plugin.js</code></strong>.</p>

        

<div class="cs-code-filename">
    
    <span class="d-none d-lg-inline d-xl-inline">src/main/resources/js/</span><span class="d-none d-sm-inline d-lg-none d-xl-none"
                                                            data-toggle="tooltip"
                                                            data-placement="right"
                                                            title="src/main/resources/js/">.../</span>kitchen-duty-plugin.js
    
    
    <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/blob/master/step-06-kitchen-duty-plugin/src/main/resources/js/kitchen-duty-plugin.js" target="_blank"
       data-toggle="tooltip" data-placement="left" title="Open file on GitHub"
       class="cs-code-ghlink"><i class="fa fa-github"></i></a>
    
    <a class="cs-code-copylink cs--trigger-copy-clipboard"
       data-toggle="tooltip" data-placement="left"
       data-title-orig="Copy file content to clipboard"
       title="Copy file content to clipboard"
       data-clipboard-text="//
// COMMON CODE
//
var showSuccessFlag = function(message) {
    require([&#39;aui/flag&#39;], function(flag) {
        flag({
            type: &#39;success&#39;,
            title: &#39;Kitchen Duty Plugin&#39;,
            close: &#39;auto&#39;,
            body: message
        });
    });
};
var showErrorFlag = function(message) {
    require([&#39;aui/flag&#39;], function(flag) {
        flag({
            type: &#39;error&#39;,
            title: &#39;Kitchen Duty Plugin&#39;,
            close: &#39;auto&#39;,
            body: message
        });
    });
};"><i class="fa fa-files-o"></i></a>
</div>

<pre class="cs-code"><code class="hljs"><span class="hljs-comment">//</span>
<span class="hljs-comment">// COMMON CODE</span>
<span class="hljs-comment">//</span>
<span class="hljs-keyword">var</span> showSuccessFlag = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-built_in">require</span>([<span class="hljs-string">'aui/flag'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">flag</span>) </span>{
        flag({
            type: <span class="hljs-string">'success'</span>,
            title: <span class="hljs-string">'Kitchen Duty Plugin'</span>,
            close: <span class="hljs-string">'auto'</span>,
            body: message
        });
    });
};
<span class="hljs-keyword">var</span> showErrorFlag = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) </span>{
    <span class="hljs-built_in">require</span>([<span class="hljs-string">'aui/flag'</span>], <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">flag</span>) </span>{
        flag({
            type: <span class="hljs-string">'error'</span>,
            title: <span class="hljs-string">'Kitchen Duty Plugin'</span>,
            close: <span class="hljs-string">'auto'</span>,
            body: message
        });
    });
};</code></pre>



        <p>That's it. Now we can run our plugin with <code>atlas-run</code> and when navigating to <a href="http://localhost:2990/jira/secure/KitchenDutyPlanningWebworkAction.jspa">http://localhost:2990/jira/secure/KitchenDutyOverviewPageWebworkAction.jspa</a>
        it should work as you can see below. <strong>We are completely done implementing the Kitchen Duty Overview Page</strong>.</p>

        
    
    
    <div class="row">
        <div class="offset-md-1 col-md-10">
            <p>
                <a href="/kitchen-duty-plugin-for-atlassian-jira/images/doc/step-06-overview-page-working.gif">
                    <img src="/kitchen-duty-plugin-for-atlassian-jira/images/doc/step-06-overview-page-working.gif" class="img-fluid" alt="Step 6 - Overview Page working"
                         data-bilderrahmen="gallery-01"
                         data-bilderrahmen-title="Step 6 - Overview Page working"
                    >
                </a>
            </p>
        </div>
    </div>




        <div class="cs-v-spacer"></div>
        <div class="cs-tutorial-step-review">
            <div class="cs-tutorial-step-review__headline">
                <strong>You have completed Step 6.</strong> Good Job! You can check out this step's solution on GitHub
            </div>
            <div class="cs-tutorial-step-review__link">
                <a href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/tree/master/step-06-kitchen-duty-plugin">
                    https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira/tree/master/step-06-kitchen-duty-plugin
                </a>
            </div>
        </div>
        <div class="cs-v-spacer"></div>


        
    
    
    <div class="row">
        <div class="offset-md-1 col-md-10">
            <p>
                <a href="/kitchen-duty-plugin-for-atlassian-jira/images/drawings/banzai.svg">
                    <img src="/kitchen-duty-plugin-for-atlassian-jira/images/drawings/banzai.svg" class="img-fluid" alt="Banzai! Banzai! Banzai!"
                         data-bilderrahmen="gallery-01"
                         data-bilderrahmen-title="Banzai! Banzai! Banzai!"
                    >
                </a>
            </p>
        </div>
    </div>

        <p class="text-center"><strong>The tutorial is at its end. You have completed all steps. Banzai!</strong></p>
        <div class="cs-v-spacer"></div>


    </div>
</div>



        </div>
    </div>
</div>


<div class="cs-footer">
    <div class="cs-legal-box">
        <a href="/kitchen-duty-plugin-for-atlassian-jira/author-and-license/">Author &middot; License &middot; Trademarks</a>
        <a target="_blank" href="https://legal.comsysto.com/comsysto.github.io/de/impressum/">Impressum &middot; Imprint</a>
        <a target="_blank" href="https://legal.comsysto.com/comsysto.github.io/de/datenschutz/">Datenschutz &middot; Privacy</a>
        <a class="d-none d-sm-inline btn-borderless cs-stars-on-github-give-star-button" href="https://github.com/comsysto/kitchen-duty-plugin-for-atlassian-jira" target="_blank">
            <span class="cs-stars-on-github-count-stars">...</span>
            stars on GitHub
        </a>
    </div>

    <div class="text-right cs-pager">
        <a class="btn btn-secondary" href="/kitchen-duty-plugin-for-atlassian-jira/tutorial/09-story-workshop-for-overview-page/">
            <i class="fa fa-angle-left"></i>
            <span class="d-none d-lg-inline">previous page</span>
        </a>
        
    </div>
</div>







<script src="/kitchen-duty-plugin-for-atlassian-jira/generated/bundle.js?v2018-09-01--12-50" async></script>


<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
<script>
    WebFont.load({
        google: {
            families: [ 'Menlo',
                'Open+Sans:400,300,600,700,800',
                'Roboto:400,900,700',
                'Source+Sans+Pro:400,300,600',
                'Patrick+Hand'
            ]
        }
    });
</script>
</body>
</html>
